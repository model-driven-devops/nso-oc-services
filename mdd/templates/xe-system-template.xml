<config-template xmlns="http://tail-f.com/ns/config/1.0">
  <devices xmlns="http://tail-f.com/ns/ncs">
    <device>
      <name>{$DEVICE}</name>
      <config>
        <?set-root-node {/}?>
        <?set-context-node {/ncs:devices/device[name=$DEVICE]}?>
        <?if {mdd:openconfig/oc-sys:system/aaa}?>
        <?if {mdd:openconfig/oc-sys:system/aaa/authentication/admin-user/admin-password}?>
        <username xmlns="urn:ios">
          <name>admin</name>
          <privilege>15</privilege>
          <secret>
            <type>0</type>
            <secret>{mdd:openconfig/oc-sys:system/aaa/authentication/admin-user/admin-password}</secret>
          </secret>
        </username>
        <?end?> <!-- end if {mdd:openconfig/oc-sys:system/aaa/authentication/admin-user/admin-password} -->

<!--        Due to templating limitations, aaa accounting is being configured in python-->

        <aaa xmlns="urn:ios">
          <?if {mdd:openconfig/oc-sys:system/aaa/authentication/config/authentication-method}?>
          <new-model/>
          <authentication>
            <login>
              <name>default</name>
              <tacacsplus when="{$XE_AUTHENTICATION_TACACS='True'}"/>
              <local when="{$XE_AUTHENTICATION_LOCAL='True'}"/>
            </login>
          </authentication>
          <?end?> <!-- end if {mdd:openconfig/oc-sys:system/aaa/authentication/config/authentication-method} -->
          <authorization>
            <?if {$XE_AUTHORIZATION_AAA_AUTHORIZATION_EVENT_CONFIG='True'}?>
            <exec>
              <name>default</name>
              <tacacsplus when="{$XE_AUTHORIZATION_TACACS='True'}"/>
              <local when="{$XE_AUTHORIZATION_LOCAL='True'}"/>
            </exec>
            <?end?> <!-- end if {$XE_AUTHORIZATION_AAA_AUTHORIZATION_EVENT_CONFIG='True'} -->
            <?if {$XE_AUTHORIZATION_AAA_AUTHORIZATION_EVENT_COMMAND='True'}?>
            <config-commands/>
            <commands>
              <level>15</level>
              <name>default</name>
              <tacacsplus when="{$XE_AUTHORIZATION_TACACS='True'}"/>
              <local when="{$XE_AUTHORIZATION_LOCAL='True'}"/>
            </commands>
            <?end?> <!-- end if {$XE_AUTHORIZATION_AAA_AUTHORIZATION_EVENT_COMMAND='True'} -->
          </authorization>
        </aaa>

        <?if {mdd:openconfig/oc-sys:system/aaa/authentication/users/user}?>
        <?foreach {mdd:openconfig/oc-sys:system/aaa/authentication/users/user}?>
        <username xmlns="urn:ios" tags="replace">
          <name>{current()/username}</name>
          <privilege when="{current()/config/role='SYSTEM_ROLE_ADMIN'}">15</privilege>
          <password>
            <type>0</type>
            <secret>{current()/config/password}</secret>
          </password>
        </username>
<!--        <?if {current()/config/ssh-key}?>-->
<!--        <ip xmlns="urn:ios">-->
<!--          <ssh>-->
<!--            <pubkey-chain>-->
<!--              <username>-->
<!--                <name>{current()/username}</name>-->
<!--                <key-hash>-->
<!--                  <key-type>ssh-rsa</key-type>-->
<!--                  <key-name>{current()/config/ssh-key}</key-name>-->
<!--                </key-hash>-->
<!--              </username>-->
<!--            </pubkey-chain>-->
<!--          </ssh>-->
<!--        </ip>-->
<!--        <?end?> &lt;!&ndash; end if {current()/config/ssh-key} &ndash;&gt;-->
        <?end?> <!-- end foreach {mdd:openconfig/oc-sys:system/aaa/authentication/users/user} -->
        <?end?> <!-- end if {mdd:openconfig/oc-sys:system/aaa/authentication/users/user} -->

<!--        Due to templating limitations, aaa server-groups are being configured in python-->

        <?end?> <!-- if {mdd:openconfig/oc-sys:system/aaa} -->

        <?if {mdd:openconfig/oc-sys:system/clock/config/timezone-name}?>
        <clock xmlns="urn:ios">
          <timezone>
            <?if {$XE_TIMEZONE}?>
            <zone>{$XE_TIMEZONE}</zone>
            <?end?> <!-- if {$XE_TIMEZONE} -->
            <?if {$XE_TIMEZONE_OFFSET_HOURS}?>
            <hours>{$XE_TIMEZONE_OFFSET_HOURS}</hours>
            <?end?> <!-- if {$XE_TIMEZONE_OFFSET_HOURS} -->
            <?if {$XE_TIMEZONE_OFFSET_MINUTES}?>
            <minutes>{$XE_TIMEZONE_OFFSET_MINUTES}</minutes>
            <?end?> <!-- if {$XE_TIMEZONE_OFFSET_MINUTES} -->
          </timezone>
        </clock>
        <?end?> <!-- if {mdd:openconfig/oc-sys:system/clock/config/timezone-name} -->

        <?if {mdd:openconfig/oc-sys:system/config}?>
        <?if {mdd:openconfig/oc-sys:system/config/hostname}?>
        <hostname xmlns="urn:ios">{mdd:openconfig/oc-sys:system/config/hostname}</hostname>
        <?end?> <!-- if {mdd:openconfig/oc-sys:system/config/hostname} -->

        <?if {mdd:openconfig/oc-sys:system/config/console-exec-timeout-seconds}?>
        <line xmlns="urn:ios">
          <console>
            <first>0</first>
            <exec-timeout>
              <minutes>{$XE_CONSOLE_EXEC_TIMEOUT_MINUTES}</minutes>
              <seconds>{$XE_CONSOLE_EXEC_TIMEOUT_SECONDS}</seconds>
            </exec-timeout>
          </console>
        </line>
        <?end?> <!-- if {mdd:openconfig/oc-sys:system/config/console-exec-timeout-seconds} -->

        <?if {mdd:openconfig/oc-sys:system/config/enable-secret}?>
        <enable xmlns="urn:ios">
          <secret>
            <type>0</type>
            <secret>{mdd:openconfig/oc-sys:system/config/enable-secret}</secret>
          </secret>
        </enable>
        <?end?> <!-- if {mdd:openconfig/oc-sys:system/config/enable-secret} -->

        <?if {mdd:openconfig/oc-sys:system/config/domain-name}?>
        <ip xmlns="urn:ios">
          <domain>
            <name>{mdd:openconfig/oc-sys:system/config/domain-name}</name>
          </domain>
        </ip>
        <?end?> <!-- if {mdd:openconfig/oc-sys:system/config/domain-name} -->

        <banner xmlns="urn:ios">
          <?if {mdd:openconfig/oc-sys:system/config/login-banner}?>
          <login>{mdd:openconfig/oc-sys:system/config/login-banner}</login>
          <?end?> <!-- if {mdd:openconfig/oc-sys:system/config/login-banner} -->
          <?if {mdd:openconfig/oc-sys:system/config/motd-banner}?>
          <motd>{mdd:openconfig/oc-sys:system/config/motd-banner}</motd>
          <?end?> <!-- if {mdd:openconfig/oc-sys:system/config/motd-banner} -->
        </banner>
        <?end?> <!-- if {mdd:openconfig/oc-sys:system/config} -->

        <?if {mdd:openconfig/oc-sys:system/dns/servers}?>
        <ip xmlns="urn:ios">
          <name-server tags="replace">
            <?foreach {mdd:openconfig/oc-sys:system/dns/servers/server}?>
            <name-server-list>
              <address>{current()/address}</address>
            </name-server-list>
            <?end?> <!-- foreach {mdd:openconfig/oc-sys:system/dns/servers/server} -->
          </name-server>
        </ip>
        <?end?> <!-- if {mdd:openconfig/oc-sys:system/dns/servers} -->

        <?if {mdd:openconfig/oc-sys:system/logging}?>
        <logging xmlns="urn:ios">
          <?if {$XE_CONSOLE_SEVERITY}?>
          <console>
            <severity-level>{$XE_CONSOLE_SEVERITY}</severity-level>
          </console>
          <monitor>
            <severity-level>{$XE_CONSOLE_SEVERITY}</severity-level>
          </monitor>
          <?end?> <!-- if {$XE_CONSOLE_SEVERITY} -->

          <?if {$XE_REMOTE_SEVERITY}?>
          <trap>{$XE_REMOTE_SEVERITY}</trap>
          <?end?> <!-- if {$XE_REMOTE_SEVERITY} -->

          <?if {$XE_CONSOLE_FACILITY or $XE_REMOTE_FACILITY}?>
          <facility>{$XE_CONSOLE_FACILITY}</facility>
          <?else?>
          <facility>{$XE_REMOTE_FACILITY}</facility>
          <?end?> <!-- if {$XE_CONSOLE_FACILITY or $XE_REMOTE_FACILITY} -->

          <?if {mdd:openconfig/oc-sys:system/logging/remote-servers/remote-server}?>
          <host tags="replace">
            <?foreach {mdd:openconfig/oc-sys:system/logging/remote-servers/remote-server}?>
            <?if {current()/config/use-vrf='' or current()/config/use-vrf='default' or not (current()/config/use-vrf)}?>
            <ipv4>
              <host>{current()/host}</host>
            </ipv4>
            <?else?> <!-- if {current()/config/use-vrf='' or current()/config/use-vrf='default'} -->
            <ipv4-vrf>
              <host>{current()/host}</host>
              <vrf>{current()/config/use-vrf}</vrf>
            </ipv4-vrf>
            <?end?> <!-- if {current()/config/use-vrf='' or current()/config/use-vrf='default'} -->
            <?end?> <!-- foreach {mdd:openconfig/oc-sys:system/logging/remote-servers/remote-server} -->
          </host>
          <?end?> <!-- if {mdd:openconfig/oc-sys:system/logging/remote-servers/remote-server} -->

          <?if {$XE_LOGGING_SOURCE_INF_NAME}?>
          <source-interface>
            <name>{$XE_LOGGING_SOURCE_INF_NAME}</name>
          </source-interface>
          <?end?> <!-- if {$XE_LOGGING_SOURCE_INF_NAME} -->
        </logging>
        <?end?> <!-- if {mdd:openconfig/oc-sys:system/logging} -->

        <?if {mdd:openconfig/oc-sys:system/ntp/servers/server}?>
        <ntp xmlns="urn:ios" tags="replace">
          <?if {mdd:openconfig/oc-sys:system/ntp/config/enabled='true'}?>
          <?if {mdd:openconfig/oc-sys:system/ntp/config/ntp-source-address}?>
          <?if {$XE_NTP_SOURCE_INF_TYPE}?>
          <source>
            <GigabitEthernet when="{$XE_NTP_SOURCE_INF_TYPE='GigabitEthernet'}">{$XE_NTP_SOURCE_INF_NUMBER}</GigabitEthernet>
            <TwoGigabitEthernet when="{$XE_NTP_SOURCE_INF_TYPE='TwoGigabitEthernet'}">{$XE_NTP_SOURCE_INF_NUMBER}</TwoGigabitEthernet>
            <TenGigabitEthernet when="{$XE_NTP_SOURCE_INF_TYPE='TenGigabitEthernet'}">{$XE_NTP_SOURCE_INF_NUMBER}</TenGigabitEthernet>
            <TwentyFiveGigE when="{$XE_NTP_SOURCE_INF_TYPE='TwentyFiveGigE'}">{$XE_NTP_SOURCE_INF_NUMBER}</TwentyFiveGigE>
            <FortyGigabitEthernet when="{$XE_NTP_SOURCE_INF_TYPE='FortyGigabitEthernet'}">{$XE_NTP_SOURCE_INF_NUMBER}</FortyGigabitEthernet>
            <HundredGigE when="{$XE_NTP_SOURCE_INF_TYPE='HundredGigE'}">{$XE_NTP_SOURCE_INF_NUMBER}</HundredGigE>
            <Loopback when="{$XE_NTP_SOURCE_INF_TYPE='Loopback'}">{$XE_NTP_SOURCE_INF_NUMBER}</Loopback>
            <Tunnel when="{$XE_NTP_SOURCE_INF_TYPE='Tunnel'}">{$XE_NTP_SOURCE_INF_NUMBER}</Tunnel>
            <Vlan when="{$XE_NTP_SOURCE_INF_TYPE='Vlan'}">{$XE_NTP_SOURCE_INF_NUMBER}</Vlan>
          </source>
          <?end?> <!-- if {$XE_NTP_SOURCE_INF_TYPE} -->
          <?end?> <!-- if {mdd:openconfig/oc-sys:system/ntp/config/ntp-source-address} -->

          <?if {mdd:openconfig/oc-sys:system/ntp/config/ntp-enable-logging='true'}?>
          <logging/>
          <?else?> <!-- if {mdd:openconfig/oc-sys:system/ntp/config/ntp-enable-logging='true'} -->
          <logging tags="delete"/>
          <?end?> <!-- if {mdd:openconfig/oc-sys:system/ntp/config/ntp-enable-logging='true'} -->


          <?if {mdd:openconfig/oc-sys:system/ntp/config/enable-ntp-auth='true'}?>
          <authenticate/>
          <?else?> <!-- if {mdd:openconfig/oc-sys:system/ntp/config/enable-ntp-auth='true'} -->
          <authenticate tags="delete"/>
          <?end?> <!-- if {mdd:openconfig/oc-sys:system/ntp/config/enable-ntp-auth='true'} -->

          <?if {mdd:openconfig/oc-sys:system/ntp/ntp-keys/ntp-key}?>
          <?foreach {mdd:openconfig/oc-sys:system/ntp/ntp-keys/ntp-key}?>
          <authentication-key tags="replace">
            <number>{current()/key-id}</number>
            <md5>
              <secret>{current()/config/key-value}</secret>
            </md5>
          </authentication-key>
          <trusted-key>
            <key-number>{current()/key-id}</key-number>
          </trusted-key>
          <?end?> <!-- foreach {mdd:openconfig/oc-sys:system/ntp/ntp-keys/ntp-key} -->
          <?end?> <!-- if {mdd:openconfig/oc-sys:system/ntp/ntp-keys/ntp-key} -->

          <?if {mdd:openconfig/oc-sys:system/ntp/servers/server}?>
          <server tags="replace">
            <?foreach {mdd:openconfig/oc-sys:system/ntp/servers/server}?>
            <?set AUTH-KEY = {current()/config/ntp-auth-key-id}?>
            <?set NTP-VRF = {current()/ntp-use-vrf}?>

            <?if {$NTP-VRF='' or $NTP-VRF='default' or not ($NTP-VRF)}?>
            <peer-list>
              <name>{current()/config/address}</name>
              <?if {$AUTH-KEY}?>
              <key>{$AUTH-KEY}</key>
              <?end?> <!-- if {$AUTH-KEY} -->
              <?if {current()/config/iburst='true'}?>
              <iburst/>
              <?end?> <!-- if {current()/config/iburst='true'} -->
              <?if {current()/config/prefer='true'}?>
              <prefer/>
              <?end?> <!-- if {current()/config/prefer='true'} -->
              <version>{current()/config/version}</version>
            </peer-list>
            <?else?> <!-- if {$NTP-VRF='' or $NTP-VRF='default' or not ($NTP-VRF)} -->
            <vrf>
              <name>{$NTP-VRF}</name>
              <peer-list>
                <name>{current()/config/address}</name>
                <?if {$AUTH-KEY}?>
                <key>{$AUTH-KEY}</key>
                <?end?> <!-- if {$AUTH-KEY} -->
                <?if {current()/config/iburst='true'}?>
                <iburst/>
                <?end?> <!-- if {current()/config/iburst='true'} -->
                <?if {current()/config/prefer='true'}?>
                <prefer/>
                <?end?> <!-- if {current()/config/prefer='true'} -->
                <version>{current()/config/version}</version>
              </peer-list>
            </vrf>
            <?end?> <!-- if {$NTP-VRF='' or $NTP-VRF='default' or not ($NTP-VRF)} -->
            <?end?> <!-- foreach {mdd:openconfig/oc-sys:system/ntp/servers/server} -->
          </server>
          <?end?> <!-- if {mdd:openconfig/oc-sys:system/ntp/servers/server} -->
          <?else?> <!-- if {mdd:openconfig/oc-sys:system/ntp/config/enabled='true'} -->
          <source tags="delete"/>
          <server tags="delete"/>
          <?end?> <!-- if {mdd:openconfig/oc-sys:system/ntp/config/enabled='true'} -->
        </ntp>
        <?end?>  <!-- if {mdd:openconfig/oc-sys:system/ntp/servers/server} -->

        <?if {mdd:openconfig/oc-sys:system/ssh-server}?>
        <ip xmlns="urn:ios">
          <ssh>
            <?if {mdd:openconfig/oc-sys:system/ssh-server/config/ssh-timeout}?>
            <time-out>{mdd:openconfig/oc-sys:system/ssh-server/config/ssh-timeout}</time-out>
            <?end?>  <!-- if  {mdd:openconfig/oc-sys:system/ssh-server/config/ssh-timeout} -->

            <?if {mdd:openconfig/oc-sys:system/ssh-server/config/ssh-source-interface}?>
            <source-interface>
              <GigabitEthernet when="{$XE_SSH_SOURCE_INF_TYPE='GigabitEthernet'}">{$XE_SSH_SOURCE_INF_NUMBER}</GigabitEthernet>
              <TwoGigabitEthernet when="{$XE_SSH_SOURCE_INF_TYPE='TwoGigabitEthernet'}">{$XE_SSH_SOURCE_INF_NUMBER}</TwoGigabitEthernet>
              <TenGigabitEthernet when="{$XE_SSH_SOURCE_INF_TYPE='TenGigabitEthernet'}">{$XE_SSH_SOURCE_INF_NUMBER}</TenGigabitEthernet>
              <TwentyFiveGigE when="{$XE_SSH_SOURCE_INF_TYPE='TwentyFiveGigE'}">{$XE_SSH_SOURCE_INF_NUMBER}</TwentyFiveGigE>
              <FortyGigabitEthernet when="{$XE_SSH_SOURCE_INF_TYPE='FortyGigabitEthernet'}">{$XE_SSH_SOURCE_INF_NUMBER}</FortyGigabitEthernet>
              <HundredGigE when="{$XE_SSH_SOURCE_INF_TYPE='HundredGigE'}">{$XE_SSH_SOURCE_INF_NUMBER}</HundredGigE>
              <Loopback when="{$XE_SSH_SOURCE_INF_TYPE='Loopback'}">{$XE_SSH_SOURCE_INF_NUMBER}</Loopback>
              <Tunnel when="{$XE_SSH_SOURCE_INF_TYPE='Tunnel'}">{$XE_SSH_SOURCE_INF_NUMBER}</Tunnel>
              <Vlan when="{$XE_SSH_SOURCE_INF_TYPE='Vlan'}">{$XE_SSH_SOURCE_INF_NUMBER}</Vlan>
            </source-interface>
            <?end?>  <!-- if {mdd:openconfig/oc-sys:system/ssh-server/config/ssh-source-interface} -->
          </ssh>
        </ip>


        <ip xmlns="urn:ios">
          <ssh>
            <version when="{mdd:openconfig/oc-sys:system/ssh-server/config/protocol-version='V2'}">2</version>
            <version when="{mdd:openconfig/oc-sys:system/ssh-server/config/protocol-version='V1'}">1</version>
            <version when="{mdd:openconfig/oc-sys:system/ssh-server/config/protocol-version='V1_V2'}" tags="delete"/>
          </ssh>
        </ip>
        <line xmlns="urn:ios">
          <vty>
            <first>0</first>
            <last>4</last>
            <exec-timeout>
              <minutes>{$XE_EXEC_TIMEOUT_MINUTES}</minutes>
              <seconds>{$XE_EXEC_TIMEOUT_SECONDS}</seconds>
            </exec-timeout>
            <session-limit>{mdd:openconfig/oc-sys:system/ssh-server/config/session-limit}</session-limit>

            <?if {mdd:openconfig/oc-sys:system/ssh-server/config/absolute-timeout-minutes}?>
            <absolute-timeout>{mdd:openconfig/oc-sys:system/ssh-server/config/ssh-timeout}</absolute-timeout>
            <?end?>  <!-- if {mdd:openconfig/oc-sys:system/ssh-server/config/absolute-timeout-minutes} -->

            <?if {mdd:openconfig/oc-sys:system/ssh-server/config/enable='true'}?>
            <transport>
              <input>ssh</input>
            </transport>
            <?end?> <!-- if {mdd:openconfig/oc-sys:system/ssh-server/config/enable='true'} -->
          </vty>
        </line>
        <?end?> <!-- if {mdd:openconfig/oc-sys:system/ssh-server} -->
      </config>
    </device>
  </devices>
</config-template>
