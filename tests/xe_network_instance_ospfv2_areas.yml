---
# ansible-playbook xe_network_instance_ospfv2_areas.yml --extra-vars "nso_ip=X.X.X.X device=xe1" --tags=all
# Test OSPF area
- hosts: "{{ device }}"
  connection: network_cli
  gather_facts: no
  tags:
    - all
    - area
  vars:
    ansible_network_os: 'cisco.ios.ios'
  roles:
    - ansible-pyats
  tasks:
    - name: collect config (before)
      ios_command:
        commands:
          - show run
      register: result_before

- hosts: localhost
  gather_facts: no
  tags:
    - all
    - area
  vars:
    device_name: "{{ device }}"
    content: |
      mdd:openconfig:
        openconfig-interfaces:interfaces:
          interface:
            - config:
                enabled: true
                name: Loopback10
                type: softwareLoopback
                description: TEST123
              name: Loopback10
              subinterfaces:
                subinterface:
                  - config:
                      index: '0'
                    index: '0'
                    openconfig-if-ip:ipv4:
                      addresses:
                        address:
                          - config:
                              ip: 172.16.1.2
                              prefix-length: 32
                            ip: 172.16.1.2
                      config:
                        dhcp-client: false
            - config:
                enabled: true
                name: GigabitEthernet10
                type: 'ethernetCsmacd'
              openconfig-if-ethernet:ethernet:
                config:
                  auto-negotiate: true
                  enable-flow-control: false
              hold-time:
                config:
                  down: '10'
              name: GigabitEthernet10
              subinterfaces:
                subinterface:
                  - config:
                      index: '0'
                    index: '0'
                    openconfig-if-ip:ipv4:
                      addresses:
                        address:
                          - config:
                              ip: 172.17.0.1
                              prefix-length: 24
                            ip: 172.17.0.1
                      config:
                        dhcp-client: false
        openconfig-network-instance:network-instances:
          network-instance:
            - name: 'default'
              config:
                name: 'default'
                type: 'DEFAULT_INSTANCE'
                enabled: true
              protocols:
                protocol:
                  - name: 1
                    identifier: OSPF
                    config:
                      enabled: True
                      identifier: OSPF
                      name: 1
                    ospfv2:
                      areas:
                        area:
                        - config:
                            identifier: 1
                          identifier: 1
                          interfaces:
                            interface:
                            - config:
                                id: Loopback10
                              id: Loopback10
                        - config:
                            identifier: 0
                          identifier: 0
                          interfaces:
                            interface:
                            - config:
                                id: GigabitEthernet10
                              id: GigabitEthernet10
              interfaces:
                interface:
                  - id: 'Loopback10'
                    config:
                      id: 'Loopback10'
                      interface: 'Loopback10'
                      subinterface: '0'
                  - id: 'GigabitEthernet10'
                    config:
                      id: 'GigabitEthernet10'
                      interface: 'GigabitEthernet10'
                      subinterface: '0'
  tasks:
    - name: Convert string to JSON
      set_fact:
        configs: "{{ content | from_yaml | to_json }}"
    - name: JSON configs
      debug:
        msg: "{{ configs }}"
    - name: OSPF area
      uri:
        url: "http://{{ nso_ip }}:8080/restconf/data/tailf-ncs:devices/device={{ device_name }}/mdd:openconfig"
        url_username: admin
        url_password: admin
        force_basic_auth: yes
        validate_certs: no
        status_code: [200,201,204]
        method: PUT
        headers: "{
          'Content-Type': 'application/yang-data+json',
          'Accept': 'application/yang-data+json'}"
        body_format: json
        body: "{{ configs }}"

- hosts: "{{ device }}"
  connection: network_cli
  gather_facts: no
  tags:
    - all
    - area
  vars:
    ansible_network_os: 'cisco.ios.ios'
    exclude_list:
      - (^Using.*)
      - (Building.*)
      - (Current.*)
      - (crypto pki certificate chain.*)
  roles:
    - ansible-pyats
  tasks:
    - name: collect config (after)
      ios_command:
        commands:
          - show run
      register: result_after
    - set_fact:
        changes: "{{ result_before.stdout[0] | genie_config_diff(result_after.stdout[0], mode='add', exclude=exclude_list) }}"
    - name: debug changes
      debug:
        msg: "{{ changes }}"
    - assert:
        that:
          - "'+router ospf 1:' in changes"
          - "'+ network 172.16.1.2 0.0.0.0 area 1:' in changes"
          - "'+ network 172.17.0.1 0.0.0.0 area 0:' in changes"
      ignore_errors: yes
- hosts: localhost
  gather_facts: no
  tags:
    - all
    - area
    - rollback
  tasks:
    - name: Rollback
      uri:
        url: "http://{{ nso_ip }}:8080/restconf/data/tailf-rollback:rollback-files/apply-rollback-file"
        url_username: admin
        url_password: admin
        force_basic_auth: yes
        validate_certs: no
        status_code: [ 204 ]
        method: POST
        headers: "{
          'Content-Type': 'application/yang-data+xml'}"
        body: |
          <input xmlns="http://tail-f.com/ns/rollback">
            <id>0</id>
          </input>
# Test OSPF network_type
- hosts: "{{ device }}"
  connection: network_cli
  gather_facts: no
  tags:
    - all
    - network_type
  vars:
    ansible_network_os: 'cisco.ios.ios'
  roles:
    - ansible-pyats
  tasks:
    - name: collect config (before)
      ios_command:
        commands:
          - show run
      register: result_before

- hosts: localhost
  gather_facts: no
  tags:
    - all
    - network_type
  vars:
    device_name: "{{ device }}"
    content: |
      mdd:openconfig:
        openconfig-interfaces:interfaces:
          interface:
            - config:
                enabled: true
                name: Loopback10
                type: softwareLoopback
                description: TEST123
              name: Loopback10
              subinterfaces:
                subinterface:
                  - config:
                      index: '0'
                    index: '0'
                    openconfig-if-ip:ipv4:
                      addresses:
                        address:
                          - config:
                              ip: 172.16.1.2
                              prefix-length: 32
                            ip: 172.16.1.2
                      config:
                        dhcp-client: false
        openconfig-network-instance:network-instances:
          network-instance:
            - name: 'default'
              config:
                name: 'default'
                type: 'DEFAULT_INSTANCE'
                enabled: true
              protocols:
                protocol:
                  - name: 1
                    identifier: OSPF
                    config:
                      enabled: True
                      identifier: OSPF
                      name: 1
                    ospfv2:
                      areas:
                        area:
                        - config:
                            identifier: 1
                          identifier: 1
                          interfaces:
                            interface:
                            - config:
                                id: Loopback10
                                network-type: 'BROADCAST_NETWORK'
                              id: Loopback10
              interfaces:
                interface:
                  - id: 'Loopback10'
                    config:
                      id: 'Loopback10'
                      interface: 'Loopback10'
                      subinterface: '0'
  tasks:
    - name: Convert string to JSON
      set_fact:
        configs: "{{ content | from_yaml | to_json }}"
    - name: JSON configs
      debug:
        msg: "{{ configs }}"
    - name: OSPF network_type
      uri:
        url: "http://{{ nso_ip }}:8080/restconf/data/tailf-ncs:devices/device={{ device_name }}/mdd:openconfig"
        url_username: admin
        url_password: admin
        force_basic_auth: yes
        validate_certs: no
        status_code: [200,201,204]
        method: PUT
        headers: "{
          'Content-Type': 'application/yang-data+json',
          'Accept': 'application/yang-data+json'}"
        body_format: json
        body: "{{ configs }}"

- hosts: "{{ device }}"
  connection: network_cli
  gather_facts: no
  tags:
    - all
    - network_type
  vars:
    ansible_network_os: 'cisco.ios.ios'
    exclude_list:
      - (^Using.*)
      - (Building.*)
      - (Current.*)
      - (crypto pki certificate chain.*)
  roles:
    - ansible-pyats
  tasks:
    - name: collect config (after)
      ios_command:
        commands:
          - show run
      register: result_after
    - set_fact:
        changes: "{{ result_before.stdout[0] | genie_config_diff(result_after.stdout[0], mode='add', exclude=exclude_list) }}"
    - name: debug changes
      debug:
        msg: "{{ changes }}"
    - assert:
        that:
          - "'+ ip ospf network broadcast:' in changes"
      ignore_errors: yes
- hosts: localhost
  gather_facts: no
  tags:
    - all
    - network_type
    - rollback
  tasks:
    - name: Rollback
      uri:
        url: "http://{{ nso_ip }}:8080/restconf/data/tailf-rollback:rollback-files/apply-rollback-file"
        url_username: admin
        url_password: admin
        force_basic_auth: yes
        validate_certs: no
        status_code: [ 204 ]
        method: POST
        headers: "{
          'Content-Type': 'application/yang-data+xml'}"
        body: |
          <input xmlns="http://tail-f.com/ns/rollback">
            <id>0</id>
          </input>
# Test OSPF interface_cost
- hosts: "{{ device }}"
  connection: network_cli
  gather_facts: no
  tags:
    - all
    - interface_cost
  vars:
    ansible_network_os: 'cisco.ios.ios'
  roles:
    - ansible-pyats
  tasks:
    - name: collect config (before)
      ios_command:
        commands:
          - show run
      register: result_before

- hosts: localhost
  gather_facts: no
  tags:
    - all
    - interface_cost
  vars:
    device_name: "{{ device }}"
    content: |
      mdd:openconfig:
        openconfig-interfaces:interfaces:
          interface:
            - config:
                enabled: true
                name: GigabitEthernet10
                type: 'ethernetCsmacd'
              openconfig-if-ethernet:ethernet:
                config:
                  auto-negotiate: true
                  enable-flow-control: false
              hold-time:
                config:
                  down: '10'
              name: GigabitEthernet10
              subinterfaces:
                subinterface:
                  - config:
                      index: '0'
                    index: '0'
                    openconfig-if-ip:ipv4:
                      addresses:
                        address:
                          - config:
                              ip: 172.17.0.1
                              prefix-length: 24
                            ip: 172.17.0.1
                      config:
                        dhcp-client: false
        openconfig-network-instance:network-instances:
          network-instance:
            - name: 'default'
              config:
                name: 'default'
                type: 'DEFAULT_INSTANCE'
                enabled: true
              protocols:
                protocol:
                  - name: 1
                    identifier: OSPF
                    config:
                      enabled: True
                      identifier: OSPF
                      name: 1
                    ospfv2:
                      areas:
                        area:
                        - config:
                            identifier: 0
                          identifier: 0
                          interfaces:
                            interface:
                            - config:
                                id: GigabitEthernet10
                                metric: 10
                              id: GigabitEthernet10
              interfaces:
                interface:
                  - id: 'GigabitEthernet10'
                    config:
                      id: 'GigabitEthernet10'
                      interface: 'GigabitEthernet10'
                      subinterface: '0'
  tasks:
    - name: Convert string to JSON
      set_fact:
        configs: "{{ content | from_yaml | to_json }}"
    - name: JSON configs
      debug:
        msg: "{{ configs }}"
    - name: OSPF interface_cost
      uri:
        url: "http://{{ nso_ip }}:8080/restconf/data/tailf-ncs:devices/device={{ device_name }}/mdd:openconfig"
        url_username: admin
        url_password: admin
        force_basic_auth: yes
        validate_certs: no
        status_code: [200,201,204]
        method: PUT
        headers: "{
          'Content-Type': 'application/yang-data+json',
          'Accept': 'application/yang-data+json'}"
        body_format: json
        body: "{{ configs }}"

- hosts: "{{ device }}"
  connection: network_cli
  gather_facts: no
  tags:
    - all
    - interface_cost
  vars:
    ansible_network_os: 'cisco.ios.ios'
    exclude_list:
      - (^Using.*)
      - (Building.*)
      - (Current.*)
      - (crypto pki certificate chain.*)
  roles:
    - ansible-pyats
  tasks:
    - name: collect config (after)
      ios_command:
        commands:
          - show run
      register: result_after
    - set_fact:
        changes: "{{ result_before.stdout[0] | genie_config_diff(result_after.stdout[0], mode='add', exclude=exclude_list) }}"
    - name: debug changes
      debug:
        msg: "{{ changes }}"
    - assert:
        that:
          - "'+ ip ospf cost 10:' in changes"
      ignore_errors: yes
- hosts: localhost
  gather_facts: no
  tags:
    - all
    - interface_cost
    - rollback
  tasks:
    - name: Rollback
      uri:
        url: "http://{{ nso_ip }}:8080/restconf/data/tailf-rollback:rollback-files/apply-rollback-file"
        url_username: admin
        url_password: admin
        force_basic_auth: yes
        validate_certs: no
        status_code: [ 204 ]
        method: POST
        headers: "{
          'Content-Type': 'application/yang-data+xml'}"
        body: |
          <input xmlns="http://tail-f.com/ns/rollback">
            <id>0</id>
          </input>
# Test OSPF passive_interface
- hosts: "{{ device }}"
  connection: network_cli
  gather_facts: no
  tags:
    - all
    - passive_interface
  vars:
    ansible_network_os: 'cisco.ios.ios'
  roles:
    - ansible-pyats
  tasks:
    - name: collect config (before)
      ios_command:
        commands:
          - show run
      register: result_before

- hosts: localhost
  gather_facts: no
  tags:
    - all
    - passive_interface
  vars:
    device_name: "{{ device }}"
    content: |
      mdd:openconfig:
        openconfig-interfaces:interfaces:
          interface:
            - config:
                enabled: true
                name: GigabitEthernet10
                type: 'ethernetCsmacd'
              openconfig-if-ethernet:ethernet:
                config:
                  auto-negotiate: true
                  enable-flow-control: false
              hold-time:
                config:
                  down: '10'
              name: GigabitEthernet10
              subinterfaces:
                subinterface:
                  - config:
                      index: '0'
                    index: '0'
                    openconfig-if-ip:ipv4:
                      addresses:
                        address:
                          - config:
                              ip: 172.17.0.1
                              prefix-length: 24
                            ip: 172.17.0.1
                      config:
                        dhcp-client: false
        openconfig-network-instance:network-instances:
          network-instance:
            - name: 'default'
              config:
                name: 'default'
                type: 'DEFAULT_INSTANCE'
                enabled: true
              protocols:
                protocol:
                  - name: 1
                    identifier: OSPF
                    config:
                      enabled: True
                      identifier: OSPF
                      name: 1
                    ospfv2:
                      areas:
                        area:
                        - config:
                            identifier: 0
                          identifier: 0
                          interfaces:
                            interface:
                            - config:
                                id: GigabitEthernet10
                                passive: True
                              id: GigabitEthernet10
              interfaces:
                interface:
                  - id: 'GigabitEthernet10'
                    config:
                      id: 'GigabitEthernet10'
                      interface: 'GigabitEthernet10'
                      subinterface: '0'
  tasks:
    - name: Convert string to JSON
      set_fact:
        configs: "{{ content | from_yaml | to_json }}"
    - name: JSON configs
      debug:
        msg: "{{ configs }}"
    - name: OSPF passive_interface
      uri:
        url: "http://{{ nso_ip }}:8080/restconf/data/tailf-ncs:devices/device={{ device_name }}/mdd:openconfig"
        url_username: admin
        url_password: admin
        force_basic_auth: yes
        validate_certs: no
        status_code: [200,201,204]
        method: PUT
        headers: "{
          'Content-Type': 'application/yang-data+json',
          'Accept': 'application/yang-data+json'}"
        body_format: json
        body: "{{ configs }}"

- hosts: "{{ device }}"
  connection: network_cli
  gather_facts: no
  tags:
    - all
    - passive_interface
  vars:
    ansible_network_os: 'cisco.ios.ios'
    exclude_list:
      - (^Using.*)
      - (Building.*)
      - (Current.*)
      - (crypto pki certificate chain.*)
  roles:
    - ansible-pyats
  tasks:
    - name: collect config (after)
      ios_command:
        commands:
          - show run
      register: result_after
    - set_fact:
        changes: "{{ result_before.stdout[0] | genie_config_diff(result_after.stdout[0], mode='add', exclude=exclude_list) }}"
    - name: debug changes
      debug:
        msg: "{{ changes }}"
    - assert:
        that:
          - "'+ passive-interface GigabitEthernet10:' in changes"
      ignore_errors: yes
- hosts: localhost
  gather_facts: no
  tags:
    - all
    - passive_interface
    - rollback
  tasks:
    - name: Rollback
      uri:
        url: "http://{{ nso_ip }}:8080/restconf/data/tailf-rollback:rollback-files/apply-rollback-file"
        url_username: admin
        url_password: admin
        force_basic_auth: yes
        validate_certs: no
        status_code: [ 204 ]
        method: POST
        headers: "{
          'Content-Type': 'application/yang-data+xml'}"
        body: |
          <input xmlns="http://tail-f.com/ns/rollback">
            <id>0</id>
          </input>
# Test OSPF priority
- hosts: "{{ device }}"
  connection: network_cli
  gather_facts: no
  tags:
    - all
    - priority
  vars:
    ansible_network_os: 'cisco.ios.ios'
  roles:
    - ansible-pyats
  tasks:
    - name: collect config (before)
      ios_command:
        commands:
          - show run
      register: result_before

- hosts: localhost
  gather_facts: no
  tags:
    - all
    - priority
  vars:
    device_name: "{{ device }}"
    content: |
      mdd:openconfig:
        openconfig-interfaces:interfaces:
          interface:
            - config:
                enabled: true
                name: GigabitEthernet10
                type: 'ethernetCsmacd'
              openconfig-if-ethernet:ethernet:
                config:
                  auto-negotiate: true
                  enable-flow-control: false
              hold-time:
                config:
                  down: '10'
              name: GigabitEthernet10
              subinterfaces:
                subinterface:
                  - config:
                      index: '0'
                    index: '0'
                    openconfig-if-ip:ipv4:
                      addresses:
                        address:
                          - config:
                              ip: 172.17.0.1
                              prefix-length: 24
                            ip: 172.17.0.1
                      config:
                        dhcp-client: false
        openconfig-network-instance:network-instances:
          network-instance:
            - name: 'default'
              config:
                name: 'default'
                type: 'DEFAULT_INSTANCE'
                enabled: true
              protocols:
                protocol:
                  - name: 1
                    identifier: OSPF
                    config:
                      enabled: True
                      identifier: OSPF
                      name: 1
                    ospfv2:
                      areas:
                        area:
                        - config:
                            identifier: 0
                          identifier: 0
                          interfaces:
                            interface:
                            - config:
                                id: GigabitEthernet10
                                priority: 10
                              id: GigabitEthernet10
              interfaces:
                interface:
                  - id: 'GigabitEthernet10'
                    config:
                      id: 'GigabitEthernet10'
                      interface: 'GigabitEthernet10'
                      subinterface: '0'
  tasks:
    - name: Convert string to JSON
      set_fact:
        configs: "{{ content | from_yaml | to_json }}"
    - name: JSON configs
      debug:
        msg: "{{ configs }}"
    - name: OSPF priority
      uri:
        url: "http://{{ nso_ip }}:8080/restconf/data/tailf-ncs:devices/device={{ device_name }}/mdd:openconfig"
        url_username: admin
        url_password: admin
        force_basic_auth: yes
        validate_certs: no
        status_code: [200,201,204]
        method: PUT
        headers: "{
          'Content-Type': 'application/yang-data+json',
          'Accept': 'application/yang-data+json'}"
        body_format: json
        body: "{{ configs }}"

- hosts: "{{ device }}"
  connection: network_cli
  gather_facts: no
  tags:
    - all
    - priority
  vars:
    ansible_network_os: 'cisco.ios.ios'
    exclude_list:
      - (^Using.*)
      - (Building.*)
      - (Current.*)
      - (crypto pki certificate chain.*)
  roles:
    - ansible-pyats
  tasks:
    - name: collect config (after)
      ios_command:
        commands:
          - show run
      register: result_after
    - set_fact:
        changes: "{{ result_before.stdout[0] | genie_config_diff(result_after.stdout[0], mode='add', exclude=exclude_list) }}"
    - name: debug changes
      debug:
        msg: "{{ changes }}"
    - assert:
        that:
          - "'+ ip ospf priority 10:' in changes"
      ignore_errors: yes
- hosts: localhost
  gather_facts: no
  tags:
    - all
    - priority
    - rollback
  tasks:
    - name: Rollback
      uri:
        url: "http://{{ nso_ip }}:8080/restconf/data/tailf-rollback:rollback-files/apply-rollback-file"
        url_username: admin
        url_password: admin
        force_basic_auth: yes
        validate_certs: no
        status_code: [ 204 ]
        method: POST
        headers: "{
          'Content-Type': 'application/yang-data+xml'}"
        body: |
          <input xmlns="http://tail-f.com/ns/rollback">
            <id>0</id>
          </input>
# Test OSPF ospf_bfd
- hosts: "{{ device }}"
  connection: network_cli
  gather_facts: no
  tags:
    - all
    - ospf_bfd
  vars:
    ansible_network_os: 'cisco.ios.ios'
  roles:
    - ansible-pyats
  tasks:
    - name: collect config (before)
      ios_command:
        commands:
          - show run
      register: result_before

- hosts: localhost
  gather_facts: no
  tags:
    - all
    - ospf_bfd
  vars:
    device_name: "{{ device }}"
    content: |
      mdd:openconfig:
        openconfig-interfaces:interfaces:
          interface:
            - config:
                enabled: true
                name: GigabitEthernet10
                type: 'ethernetCsmacd'
              openconfig-if-ethernet:ethernet:
                config:
                  auto-negotiate: true
                  enable-flow-control: false
              hold-time:
                config:
                  down: '10'
              name: GigabitEthernet10
              subinterfaces:
                subinterface:
                  - config:
                      index: '0'
                    index: '0'
                    openconfig-if-ip:ipv4:
                      addresses:
                        address:
                          - config:
                              ip: 172.17.0.1
                              prefix-length: 24
                            ip: 172.17.0.1
                      config:
                        dhcp-client: false
        openconfig-network-instance:network-instances:
          network-instance:
            - name: 'default'
              config:
                name: 'default'
                type: 'DEFAULT_INSTANCE'
                enabled: true
              protocols:
                protocol:
                  - name: 1
                    identifier: OSPF
                    config:
                      enabled: True
                      identifier: OSPF
                      name: 1
                    ospfv2:
                      areas:
                        area:
                        - config:
                            identifier: 0
                          identifier: 0
                          interfaces:
                            interface:
                            - config:
                                id: GigabitEthernet10
                              enable-bfd:
                                config:
                                  enabled: True
                              id: GigabitEthernet10
              interfaces:
                interface:
                  - id: 'GigabitEthernet10'
                    config:
                      id: 'GigabitEthernet10'
                      interface: 'GigabitEthernet10'
                      subinterface: '0'
  tasks:
    - name: Convert string to JSON
      set_fact:
        configs: "{{ content | from_yaml | to_json }}"
    - name: JSON configs
      debug:
        msg: "{{ configs }}"
    - name: OSPF ospf_bfd
      uri:
        url: "http://{{ nso_ip }}:8080/restconf/data/tailf-ncs:devices/device={{ device_name }}/mdd:openconfig"
        url_username: admin
        url_password: admin
        force_basic_auth: yes
        validate_certs: no
        status_code: [200,201,204]
        method: PUT
        headers: "{
          'Content-Type': 'application/yang-data+json',
          'Accept': 'application/yang-data+json'}"
        body_format: json
        body: "{{ configs }}"

- hosts: "{{ device }}"
  connection: network_cli
  gather_facts: no
  tags:
    - all
    - ospf_bfd
  vars:
    ansible_network_os: 'cisco.ios.ios'
    exclude_list:
      - (^Using.*)
      - (Building.*)
      - (Current.*)
      - (crypto pki certificate chain.*)
  roles:
    - ansible-pyats
  tasks:
    - name: collect config (after)
      ios_command:
        commands:
          - show run
      register: result_after
    - set_fact:
        changes: "{{ result_before.stdout[0] | genie_config_diff(result_after.stdout[0], mode='add', exclude=exclude_list) }}"
    - name: debug changes
      debug:
        msg: "{{ changes }}"
    - assert:
        that:
          - "'+ ip ospf bfd:' in changes"
      ignore_errors: yes
- hosts: localhost
  gather_facts: no
  tags:
    - all
    - ospf_bfd
    - rollback
  tasks:
    - name: Rollback
      uri:
        url: "http://{{ nso_ip }}:8080/restconf/data/tailf-rollback:rollback-files/apply-rollback-file"
        url_username: admin
        url_password: admin
        force_basic_auth: yes
        validate_certs: no
        status_code: [ 204 ]
        method: POST
        headers: "{
          'Content-Type': 'application/yang-data+xml'}"
        body: |
          <input xmlns="http://tail-f.com/ns/rollback">
            <id>0</id>
          </input>
# Test OSPF neighbor
- hosts: "{{ device }}"
  connection: network_cli
  gather_facts: no
  tags:
    - all
    - neighbor
  vars:
    ansible_network_os: 'cisco.ios.ios'
  roles:
    - ansible-pyats
  tasks:
    - name: collect config (before)
      ios_command:
        commands:
          - show run
      register: result_before

- hosts: localhost
  gather_facts: no
  tags:
    - all
    - neighbor
  vars:
    device_name: "{{ device }}"
    content: |
      mdd:openconfig:
        openconfig-interfaces:interfaces:
          interface:
            - config:
                enabled: true
                name: GigabitEthernet10
                type: 'ethernetCsmacd'
              openconfig-if-ethernet:ethernet:
                config:
                  auto-negotiate: true
                  enable-flow-control: false
              hold-time:
                config:
                  down: '10'
              name: GigabitEthernet10
              subinterfaces:
                subinterface:
                  - config:
                      index: '0'
                    index: '0'
                    openconfig-if-ip:ipv4:
                      addresses:
                        address:
                          - config:
                              ip: 172.17.0.1
                              prefix-length: 24
                            ip: 172.17.0.1
                      config:
                        dhcp-client: false
        openconfig-network-instance:network-instances:
          network-instance:
            - name: 'default'
              config:
                name: 'default'
                type: 'DEFAULT_INSTANCE'
                enabled: true
              protocols:
                protocol:
                  - name: 1
                    identifier: OSPF
                    config:
                      enabled: True
                      identifier: OSPF
                      name: 1
                    ospfv2:
                      areas:
                        area:
                        - config:
                            identifier: 0
                          identifier: 0
                          interfaces:
                            interface:
                            - config:
                                id: GigabitEthernet10
                              neighbors:
                                neighbor:
                                - config:
                                    metric: 100
                                    router-id: 10.10.10.10
                                  router-id: 10.10.10.10
                              id: GigabitEthernet10
              interfaces:
                interface:
                  - id: 'GigabitEthernet10'
                    config:
                      id: 'GigabitEthernet10'
                      interface: 'GigabitEthernet10'
                      subinterface: '0'
  tasks:
    - name: Convert string to JSON
      set_fact:
        configs: "{{ content | from_yaml | to_json }}"
    - name: JSON configs
      debug:
        msg: "{{ configs }}"
    - name: OSPF neighbor
      uri:
        url: "http://{{ nso_ip }}:8080/restconf/data/tailf-ncs:devices/device={{ device_name }}/mdd:openconfig"
        url_username: admin
        url_password: admin
        force_basic_auth: yes
        validate_certs: no
        status_code: [200,201,204]
        method: PUT
        headers: "{
          'Content-Type': 'application/yang-data+json',
          'Accept': 'application/yang-data+json'}"
        body_format: json
        body: "{{ configs }}"

- hosts: "{{ device }}"
  connection: network_cli
  gather_facts: no
  tags:
    - all
    - neighbor
  vars:
    ansible_network_os: 'cisco.ios.ios'
    exclude_list:
      - (^Using.*)
      - (Building.*)
      - (Current.*)
      - (crypto pki certificate chain.*)
  roles:
    - ansible-pyats
  tasks:
    - name: collect config (after)
      ios_command:
        commands:
          - show run
      register: result_after
    - set_fact:
        changes: "{{ result_before.stdout[0] | genie_config_diff(result_after.stdout[0], mode='add', exclude=exclude_list) }}"
    - name: debug changes
      debug:
        msg: "{{ changes }}"
    - assert:
        that:
          - "'+router ospf 1:' in changes"
          - "'+ neighbor 1.1.1.1 cost 100:' in changes"
      ignore_errors: yes
- hosts: localhost
  gather_facts: no
  tags:
    - all
    - neighbor
    - rollback
  tasks:
    - name: Rollback
      uri:
        url: "http://{{ nso_ip }}:8080/restconf/data/tailf-rollback:rollback-files/apply-rollback-file"
        url_username: admin
        url_password: admin
        force_basic_auth: yes
        validate_certs: no
        status_code: [ 204 ]
        method: POST
        headers: "{
          'Content-Type': 'application/yang-data+xml'}"
        body: |
          <input xmlns="http://tail-f.com/ns/rollback">
            <id>0</id>
          </input>
# Test OSPF interface_timers
- hosts: "{{ device }}"
  connection: network_cli
  gather_facts: no
  tags:
    - all
    - interface_timers
  vars:
    ansible_network_os: 'cisco.ios.ios'
  roles:
    - ansible-pyats
  tasks:
    - name: collect config (before)
      ios_command:
        commands:
          - show run
      register: result_before

- hosts: localhost
  gather_facts: no
  tags:
    - all
    - interface_timers
  vars:
    device_name: "{{ device }}"
    content: |
      mdd:openconfig:
        openconfig-interfaces:interfaces:
          interface:
            - config:
                enabled: true
                name: GigabitEthernet10
                type: 'ethernetCsmacd'
              openconfig-if-ethernet:ethernet:
                config:
                  auto-negotiate: true
                  enable-flow-control: false
              hold-time:
                config:
                  down: '10'
              name: GigabitEthernet10
              subinterfaces:
                subinterface:
                  - config:
                      index: '0'
                    index: '0'
                    openconfig-if-ip:ipv4:
                      addresses:
                        address:
                          - config:
                              ip: 172.17.0.1
                              prefix-length: 24
                            ip: 172.17.0.1
                      config:
                        dhcp-client: false
        openconfig-network-instance:network-instances:
          network-instance:
            - name: 'default'
              config:
                name: 'default'
                type: 'DEFAULT_INSTANCE'
                enabled: true
              protocols:
                protocol:
                  - name: 1
                    identifier: OSPF
                    config:
                      enabled: True
                      identifier: OSPF
                      name: 1
                    ospfv2:
                      areas:
                        area:
                        - config:
                            identifier: 0
                          identifier: 0
                          interfaces:
                            interface:
                            - config:
                                id: GigabitEthernet10
                              timers:
                                config:
                                  dead-interval: 60
                                  hello-interval: 15
                                  retransmission-interval: 10
                              id: GigabitEthernet10
              interfaces:
                interface:
                  - id: 'GigabitEthernet10'
                    config:
                      id: 'GigabitEthernet10'
                      interface: 'GigabitEthernet10'
                      subinterface: '0'
  tasks:
    - name: Convert string to JSON
      set_fact:
        configs: "{{ content | from_yaml | to_json }}"
    - name: JSON configs
      debug:
        msg: "{{ configs }}"
    - name: OSPF interface_timers
      uri:
        url: "http://{{ nso_ip }}:8080/restconf/data/tailf-ncs:devices/device={{ device_name }}/mdd:openconfig"
        url_username: admin
        url_password: admin
        force_basic_auth: yes
        validate_certs: no
        status_code: [200,201,204]
        method: PUT
        headers: "{
          'Content-Type': 'application/yang-data+json',
          'Accept': 'application/yang-data+json'}"
        body_format: json
        body: "{{ configs }}"

- hosts: "{{ device }}"
  connection: network_cli
  gather_facts: no
  tags:
    - all
    - interface_timers
  vars:
    ansible_network_os: 'cisco.ios.ios'
    exclude_list:
      - (^Using.*)
      - (Building.*)
      - (Current.*)
      - (crypto pki certificate chain.*)
  roles:
    - ansible-pyats
  tasks:
    - name: collect config (after)
      ios_command:
        commands:
          - show run
      register: result_after
    - set_fact:
        changes: "{{ result_before.stdout[0] | genie_config_diff(result_after.stdout[0], mode='add', exclude=exclude_list) }}"
    - name: debug changes
      debug:
        msg: "{{ changes }}"
    - assert:
        that:
          - "'+ ip ospf dead-interval 60:' in changes"
          - "'+ ip ospf hello-interval 15:' in changes"
          - "'+ ip ospf retransmit-interval 10:' in changes"
      ignore_errors: yes
- hosts: localhost
  gather_facts: no
  tags:
    - all
    - interface_timers
    - rollback
  tasks:
    - name: Rollback
      uri:
        url: "http://{{ nso_ip }}:8080/restconf/data/tailf-rollback:rollback-files/apply-rollback-file"
        url_username: admin
        url_password: admin
        force_basic_auth: yes
        validate_certs: no
        status_code: [ 204 ]
        method: POST
        headers: "{
          'Content-Type': 'application/yang-data+xml'}"
        body: |
          <input xmlns="http://tail-f.com/ns/rollback">
            <id>0</id>
          </input>
# Test OSPF mpls_traffic_eng_area
- hosts: "{{ device }}"
  connection: network_cli
  gather_facts: no
  tags:
    - all
    - mpls_traffic_eng_area
  vars:
    ansible_network_os: 'cisco.ios.ios'
  roles:
    - ansible-pyats
  tasks:
    - name: collect config (before)
      ios_command:
        commands:
          - show run
      register: result_before

- hosts: localhost
  gather_facts: no
  tags:
    - all
    - mpls_traffic_eng_area
  vars:
    device_name: "{{ device }}"
    content: |
      mdd:openconfig:
        openconfig-interfaces:interfaces:
          interface:
            - config:
                enabled: true
                name: GigabitEthernet10
                type: 'ethernetCsmacd'
              openconfig-if-ethernet:ethernet:
                config:
                  auto-negotiate: true
                  enable-flow-control: false
              hold-time:
                config:
                  down: '10'
              name: GigabitEthernet10
              subinterfaces:
                subinterface:
                  - config:
                      index: '0'
                    index: '0'
                    openconfig-if-ip:ipv4:
                      addresses:
                        address:
                          - config:
                              ip: 172.17.0.1
                              prefix-length: 24
                            ip: 172.17.0.1
                      config:
                        dhcp-client: false
        openconfig-network-instance:network-instances:
          network-instance:
            - name: 'default'
              config:
                name: 'default'
                type: 'DEFAULT_INSTANCE'
                enabled: true
              protocols:
                protocol:
                  - name: 1
                    identifier: OSPF
                    config:
                      enabled: True
                      identifier: OSPF
                      name: 1
                    ospfv2:
                      areas:
                        area:
                        - config:
                            identifier: 0
                          identifier: 0
                          interfaces:
                            interface:
                            - config:
                                id: GigabitEthernet10
                              id: GigabitEthernet10
                          mpls:
                            config:
                              traffic-engineering-enabled: True
              interfaces:
                interface:
                  - id: 'GigabitEthernet10'
                    config:
                      id: 'GigabitEthernet10'
                      interface: 'GigabitEthernet10'
                      subinterface: '0'
  tasks:
    - name: Convert string to JSON
      set_fact:
        configs: "{{ content | from_yaml | to_json }}"
    - name: JSON configs
      debug:
        msg: "{{ configs }}"
    - name: OSPF mpls_traffic_eng_area
      uri:
        url: "http://{{ nso_ip }}:8080/restconf/data/tailf-ncs:devices/device={{ device_name }}/mdd:openconfig"
        url_username: admin
        url_password: admin
        force_basic_auth: yes
        validate_certs: no
        status_code: [200,201,204]
        method: PUT
        headers: "{
          'Content-Type': 'application/yang-data+json',
          'Accept': 'application/yang-data+json'}"
        body_format: json
        body: "{{ configs }}"

- hosts: "{{ device }}"
  connection: network_cli
  gather_facts: no
  tags:
    - all
    - mpls_traffic_eng_area
  vars:
    ansible_network_os: 'cisco.ios.ios'
    exclude_list:
      - (^Using.*)
      - (Building.*)
      - (Current.*)
      - (crypto pki certificate chain.*)
  roles:
    - ansible-pyats
  tasks:
    - name: collect config (after)
      ios_command:
        commands:
          - show run
      register: result_after
    - set_fact:
        changes: "{{ result_before.stdout[0] | genie_config_diff(result_after.stdout[0], mode='add', exclude=exclude_list) }}"
    - name: debug changes
      debug:
        msg: "{{ changes }}"
    - assert:
        that:
          - "'+ mpls traffic-eng area 0:' in changes"
      ignore_errors: yes
- hosts: localhost
  gather_facts: no
  tags:
    - all
    - mpls_traffic_eng_area
    - rollback
  tasks:
    - name: Rollback
      uri:
        url: "http://{{ nso_ip }}:8080/restconf/data/tailf-rollback:rollback-files/apply-rollback-file"
        url_username: admin
        url_password: admin
        force_basic_auth: yes
        validate_certs: no
        status_code: [ 204 ]
        method: POST
        headers: "{
          'Content-Type': 'application/yang-data+xml'}"
        body: |
          <input xmlns="http://tail-f.com/ns/rollback">
            <id>0</id>
          </input>
# Test OSPF virtual_link
- hosts: "{{ device }}"
  connection: network_cli
  gather_facts: no
  tags:
    - all
    - virtual_link
  vars:
    ansible_network_os: 'cisco.ios.ios'
  roles:
    - ansible-pyats
  tasks:
    - name: collect config (before)
      ios_command:
        commands:
          - show run
      register: result_before

- hosts: localhost
  gather_facts: no
  tags:
    - all
    - virtual_link
  vars:
    device_name: "{{ device }}"
    content: |
      mdd:openconfig:
        openconfig-interfaces:interfaces:
          interface:
            - config:
                enabled: true
                name: GigabitEthernet10
                type: 'ethernetCsmacd'
              openconfig-if-ethernet:ethernet:
                config:
                  auto-negotiate: true
                  enable-flow-control: false
              hold-time:
                config:
                  down: '10'
              name: GigabitEthernet10
              subinterfaces:
                subinterface:
                  - config:
                      index: '0'
                    index: '0'
                    openconfig-if-ip:ipv4:
                      addresses:
                        address:
                          - config:
                              ip: 172.17.0.1
                              prefix-length: 24
                            ip: 172.17.0.1
                      config:
                        dhcp-client: false
        openconfig-network-instance:network-instances:
          network-instance:
            - name: 'default'
              config:
                name: 'default'
                type: 'DEFAULT_INSTANCE'
                enabled: true
              protocols:
                protocol:
                  - name: 1
                    identifier: OSPF
                    config:
                      enabled: True
                      identifier: OSPF
                      name: 1
                    ospfv2:
                      areas:
                        area:
                        - config:
                            identifier: 0
                          identifier: 0
                          interfaces:
                            interface:
                            - config:
                                id: GigabitEthernet10
                              id: GigabitEthernet10
                          virtual-links:
                            virtual-link:
                            - config:
                                remote-router-id: 10.200.200.200
                              remote-router-id: 10.200.200.200
              interfaces:
                interface:
                  - id: 'GigabitEthernet10'
                    config:
                      id: 'GigabitEthernet10'
                      interface: 'GigabitEthernet10'
                      subinterface: '0'
  tasks:
    - name: Convert string to JSON
      set_fact:
        configs: "{{ content | from_yaml | to_json }}"
    - name: JSON configs
      debug:
        msg: "{{ configs }}"
    - name: OSPF virtual_link
      uri:
        url: "http://{{ nso_ip }}:8080/restconf/data/tailf-ncs:devices/device={{ device_name }}/mdd:openconfig"
        url_username: admin
        url_password: admin
        force_basic_auth: yes
        validate_certs: no
        status_code: [200,201,204]
        method: PUT
        headers: "{
          'Content-Type': 'application/yang-data+json',
          'Accept': 'application/yang-data+json'}"
        body_format: json
        body: "{{ configs }}"

- hosts: "{{ device }}"
  connection: network_cli
  gather_facts: no
  tags:
    - all
    - virtual_link
  vars:
    ansible_network_os: 'cisco.ios.ios'
    exclude_list:
      - (^Using.*)
      - (Building.*)
      - (Current.*)
      - (crypto pki certificate chain.*)
  roles:
    - ansible-pyats
  tasks:
    - name: collect config (after)
      ios_command:
        commands:
          - show run
      register: result_after
    - set_fact:
        changes: "{{ result_before.stdout[0] | genie_config_diff(result_after.stdout[0], mode='add', exclude=exclude_list) }}"
    - name: debug changes
      debug:
        msg: "{{ changes }}"
    - assert:
        that:
          - "'+ area 0 virtual-link 10.200.200.200:' in changes"
      ignore_errors: yes
- hosts: localhost
  gather_facts: no
  tags:
    - all
    - virtual_link
    - rollback
  tasks:
    - name: Rollback
      uri:
        url: "http://{{ nso_ip }}:8080/restconf/data/tailf-rollback:rollback-files/apply-rollback-file"
        url_username: admin
        url_password: admin
        force_basic_auth: yes
        validate_certs: no
        status_code: [ 204 ]
        method: POST
        headers: "{
          'Content-Type': 'application/yang-data+xml'}"
        body: |
          <input xmlns="http://tail-f.com/ns/rollback">
            <id>0</id>
          </input>