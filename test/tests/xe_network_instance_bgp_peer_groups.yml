---
- name: test network instance bgp peer groups
  hosts: "{{ lookup('env', 'TEST_DEVICE_XEROUTER') | default('xe1', True) }}"
  gather_facts: no
  connection: network_cli
  vars:
    device: "{{ lookup('env', 'TEST_DEVICE_XEROUTER') | default('xe1', True) }}"
    ansible_network_os: 'cisco.ios.ios'
  tasks:
    - name: test peer_group_create
      tags:
        - peer_group_create
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-network-instance:network-instances:
              network-instance:
                - name: 'default'
                  config:
                    name: 'default'
                    type: 'DEFAULT_INSTANCE'
                    enabled: true
                  protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                          peer-groups:
                            peer-group:
                              - config:
                                  peer-group-name: 'test'
                                peer-group-name: 'test'
        api_method: PUT
        rollback: true
        assertion_ignore_errors: false
        assertions:
          - "'+ neighbor test peer-group:' in changes"

    - name: test peer_group_neighbor_test
      tags:
        - peer_group_neighbor_test
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-network-instance:network-instances:
              network-instance:
                - name: 'default'
                  config:
                    name: 'default'
                    type: 'DEFAULT_INSTANCE'
                    enabled: true
                  protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                          neighbors:
                            neighbor:
                              config:
                                neighbor-address: '10.11.11.2'
                                peer-group: 'test'
                                peer-as: 2
                              neighbor-address: '10.11.11.2'
                          peer-groups:
                            peer-group:
                              - config:
                                  peer-group-name: 'test'
                                peer-group-name: 'test'
        api_method: PUT
        rollback: true
        assertion_ignore_errors: false
        assertions:
          - "'+ neighbor 10.11.11.2 peer-group test:' in changes"

    - name: test peer_group_peer_as_test
      tags:
        - peer_group_peer_as_test
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-network-instance:network-instances:
              network-instance:
                - name: 'default'
                  config:
                    name: 'default'
                    type: 'DEFAULT_INSTANCE'
                    enabled: true
                  protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                          peer-groups:
                            peer-group:
                              - config:
                                  peer-group-name: 'test'
                                  peer-as: 2
                                peer-group-name: 'test'
        api_method: PUT
        rollback: true
        assertion_ignore_errors: false
        assertions:
          - "'+ neighbor test remote-as 2:' in changes"

    - name: test peer_group_auth_test
      tags:
        - peer_group_auth_test
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-network-instance:network-instances:
              network-instance:
                - name: 'default'
                  config:
                    name: 'default'
                    type: 'DEFAULT_INSTANCE'
                    enabled: true
                  protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                          peer-groups:
                            peer-group:
                              - config:
                                  peer-group-name: 'test'
                                  auth-password: 'super_secret'
                                peer-group-name: 'test'
        api_method: PUT
        rollback: true
        assertion_ignore_errors: false
        assertions:
          - "'+ neighbor test password super_secret:' in changes"

    - name: test peer_group_description_test
      tags:
        - peer_group_description_test
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-network-instance:network-instances:
              network-instance:
                - name: 'default'
                  config:
                    name: 'default'
                    type: 'DEFAULT_INSTANCE'
                    enabled: true
                  protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                          peer-groups:
                            peer-group:
                              - config:
                                  peer-group-name: 'test'
                                  description: 'my_description'
                                peer-group-name: 'test'
        api_method: PUT
        rollback: true
        assertion_ignore_errors: false
        assertions:
          - "'+ neighbor test description my_description:' in changes"

    - name: test peer_group_local_as_test
      tags:
        - peer_group_local_as_test
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-network-instance:network-instances:
              network-instance:
                - name: 'default'
                  config:
                    name: 'default'
                    type: 'DEFAULT_INSTANCE'
                    enabled: true
                  protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                          peer-groups:
                            peer-group:
                              - config:
                                  peer-group-name: 'test'
                                  local-as: 100
                                peer-group-name: 'test'
        api_method: PUT
        rollback: true
        assertion_ignore_errors: false
        assertions:
          - "'+ neighbor test local-as 100:' in changes"

    - name: test peer_group_remove_private_as_all_test
      tags:
        - peer_group_remove_private_as_all_test
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-network-instance:network-instances:
              network-instance:
                - name: 'default'
                  config:
                    name: 'default'
                    type: 'DEFAULT_INSTANCE'
                    enabled: true
                  protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                          peer-groups:
                            peer-group:
                              - config:
                                  peer-group-name: 'test'
                                  remove-private-as: 'PRIVATE_AS_REMOVE_ALL'
                                peer-group-name: 'test'
        api_method: PUT
        rollback: true
        assertion_ignore_errors: false
        assertions:
          - "'+ neighbor test remove-private-as all:' in changes"

    - name: test peer_group_remove_private_as_replace_as_test
      tags:
        - peer_group_remove_private_as_replace_as_test
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-network-instance:network-instances:
              network-instance:
                - name: 'default'
                  config:
                    name: 'default'
                    type: 'DEFAULT_INSTANCE'
                    enabled: true
                  protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                          peer-groups:
                            peer-group:
                              - config:
                                  peer-group-name: 'test'
                                  remove-private-as: 'PRIVATE_AS_REPLACE_ALL'
                                peer-group-name: 'test'
        api_method: PUT
        rollback: true
        assertion_ignore_errors: false
        assertions:
          - "'+ neighbor test remove-private-as all replace-as:' in changes"

    - name: test peer_group_send_community_standard_test
      tags:
        - peer_group_send_community_standard_test
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-network-instance:network-instances:
              network-instance:
                - name: 'default'
                  config:
                    name: 'default'
                    type: 'DEFAULT_INSTANCE'
                    enabled: true
                  protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                          peer-groups:
                            peer-group:
                              - config:
                                  peer-group-name: 'test'
                                  send-community: 'STANDARD'
                                peer-group-name: 'test'
        api_method: PUT
        rollback: true
        assertion_ignore_errors: false
        assertions:
          - "'+ neighbor test send-community:' in changes"

    - name: test peer_group_send_community_extended_test
      tags:
        - peer_group_send_community_extended_test
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-network-instance:network-instances:
              network-instance:
                - name: 'default'
                  config:
                    name: 'default'
                    type: 'DEFAULT_INSTANCE'
                    enabled: true
                  protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                          peer-groups:
                            peer-group:
                              - config:
                                  peer-group-name: 'test'
                                  send-community: 'EXTENDED'
                                peer-group-name: 'test'
        api_method: PUT
        rollback: true
        assertion_ignore_errors: false
        assertions:
          - "'+ neighbor test send-community extended:' in changes"

    - name: test peer_group_send_community_both_test
      tags:
        - peer_group_send_community_both_test
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-network-instance:network-instances:
              network-instance:
                - name: 'default'
                  config:
                    name: 'default'
                    type: 'DEFAULT_INSTANCE'
                    enabled: true
                  protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                          peer-groups:
                            peer-group:
                              - config:
                                  peer-group-name: 'test'
                                  send-community: 'BOTH'
                                peer-group-name: 'test'
        api_method: PUT
        rollback: true
        assertion_ignore_errors: false
        assertions:
          - "'+ neighbor test send-community both:' in changes"

    - name: test peer_group_ebgp_multihop_test
      tags:
        - peer_group_ebgp_multihop_test
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-network-instance:network-instances:
              network-instance:
                - name: 'default'
                  config:
                    name: 'default'
                    type: 'DEFAULT_INSTANCE'
                    enabled: true
                  protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                          peer-groups:
                            peer-group:
                              - config:
                                  peer-group-name: 'test'
                                ebgp-multihop:
                                  config:
                                    enabled: True
                                    multihop-ttl: 2
                                peer-group-name: 'test'
        api_method: PUT
        rollback: true
        assertion_ignore_errors: false
        assertions:
          - "'+ neighbor test ebgp-multihop 2:' in changes"

    - name: test peer_group_route_reflector_client_test
      tags:
        - peer_group_route_reflector_client_test
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-network-instance:network-instances:
              network-instance:
                - name: 'default'
                  config:
                    name: 'default'
                    type: 'DEFAULT_INSTANCE'
                    enabled: true
                  protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                          peer-groups:
                            peer-group:
                              - peer-group-name: 'test'
                                config:
                                  peer-group-name: 'test'
                                  peer-as: 1
                                route-reflector:
                                  config:
                                    route-reflector-client: True
                                    route-reflector-cluster-id: '1.1.1.1'

        api_method: PUT
        rollback: true
        assertion_ignore_errors: false
        assertions:
          - "'+ neighbor test route-reflector-client:' in changes"
          - "'+ neighbor test cluster-id 1.1.1.1:' in changes"

    - name: test peer_group_route_reflector_client_test_ad_ipv4
      tags:
        - peer_group_route_reflector_client_test_ad_ipv4
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-network-instance:network-instances:
              network-instance:
                - name: 'default'
                  config:
                    name: 'default'
                    type: 'DEFAULT_INSTANCE'
                    enabled: true
                  protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                            afi-safis:
                              afi-safi:
                                - afi-safi-name: 'IPV4_UNICAST'
                                  config:
                                    afi-safi-name: 'IPV4_UNICAST'
                                    enabled: true
                          peer-groups:
                            peer-group:
                              - peer-group-name: 'test'
                                config:
                                  peer-group-name: 'test'
                                  peer-as: 1
                                route-reflector:
                                  config:
                                    route-reflector-client: True
                                    route-reflector-cluster-id: '1.1.1.1'
                                afi-safis:
                                  afi-safi:
                                    - afi-safi-name: 'IPV4_UNICAST'
                                      config:
                                        afi-safi-name: 'IPV4_UNICAST'
                                        enabled: true
        api_method: PUT
        rollback: true
        assertion_ignore_errors: false
        assertions:
          - "'+ neighbor test cluster-id 1.1.1.1:' in changes"
          - "'+ address-family ipv4:' in changes"
          - "'+  neighbor test route-reflector-client:' in changes"

    - name: test peer_group_route_reflector_client_test_ad_vpnv4
      tags:
        - peer_group_route_reflector_client_test_ad_vpnv4
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-network-instance:network-instances:
              network-instance:
                - name: 'default'
                  config:
                    name: 'default'
                    type: 'DEFAULT_INSTANCE'
                    enabled: true
                  protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                            afi-safis:
                              afi-safi:
                                - afi-safi-name: 'L3VPN_IPV4_UNICAST'
                                  config:
                                    afi-safi-name: 'L3VPN_IPV4_UNICAST'
                                    enabled: true
                          peer-groups:
                            peer-group:
                              - peer-group-name: 'test'
                                config:
                                  peer-group-name: 'test'
                                  peer-as: 1
                                route-reflector:
                                  config:
                                    route-reflector-client: True
                                    route-reflector-cluster-id: '1.1.1.1'
                                afi-safis:
                                  afi-safi:
                                    - afi-safi-name: 'L3VPN_IPV4_UNICAST'
                                      config:
                                        afi-safi-name: 'L3VPN_IPV4_UNICAST'
                                        enabled: true
        api_method: PUT
        rollback: true
        assertion_ignore_errors: false
        assertions:
          - "'+ neighbor test cluster-id 1.1.1.1:' in changes"
          - "'+ address-family vpnv4:' in changes"
          - "'+  neighbor test route-reflector-client:' in changes"

    - name: test peer_group_route_reflector_client_test_ad_ipv4_vrf
      tags:
        - peer_group_route_reflector_client_test_ad_ipv4_vrf
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-network-instance:network-instances:
              network-instance:
                - name: 'default'
                  config:
                    name: 'default'
                    type: 'DEFAULT_INSTANCE'
                    enabled: true
                  protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                            afi-safis:
                              afi-safi:
                                - afi-safi-name: 'IPV4_UNICAST'
                                  config:
                                    afi-safi-name: 'IPV4_UNICAST'
                                    enabled: true
                - name: 'abc'
                  config:
                    name: 'abc'
                    type: 'L3VRF'
                    enabled: true
                    enabled-address-families:
                      - 'IPV4'
                    route-distinguisher: '1:1'
                    openconfig-network-instance-ext:route-targets-import:
                      - '100:100'
                      - '101:101'
                    openconfig-network-instance-ext:route-targets-export:
                      - '200:200'
                      - '202:202'
                  openconfig-network-instance:protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                            afi-safis:
                              afi-safi:
                                - afi-safi-name: 'IPV4_UNICAST'
                                  config:
                                    afi-safi-name: 'IPV4_UNICAST'
                                    enabled: true
                          peer-groups:
                            peer-group:
                              - peer-group-name: 'test'
                                config:
                                  peer-group-name: 'test'
                                  peer-as: 1
                                route-reflector:
                                  config:
                                    route-reflector-client: True
                                    route-reflector-cluster-id: '1.1.1.1'
                                afi-safis:
                                  afi-safi:
                                    - afi-safi-name: 'IPV4_UNICAST'
                                      config:
                                        afi-safi-name: 'IPV4_UNICAST'
                                        enabled: true
        api_method: PUT
        rollback: true
        assertion_ignore_errors: false
        assertions:
          - "'+ address-family ipv4 vrf abc:' in changes"
          - "'+  neighbor test route-reflector-client:' in changes"
          - "'+  neighbor test cluster-id 1.1.1.1:' in changes"

    - name: test peer_group_timers_test
      tags:
        - peer_group_timers_test
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-network-instance:network-instances:
              network-instance:
                - name: 'default'
                  config:
                    name: 'default'
                    type: 'DEFAULT_INSTANCE'
                    enabled: true
                  protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                          peer-groups:
                            peer-group:
                              - peer-group-name: 'test'
                                config:
                                  peer-group-name: 'test'
                                timers:
                                  config:
                                    hold-time: 90
                                    keepalive-interval: 30
        api_method: PUT
        rollback: true
        assertion_ignore_errors: false
        assertions:
          - "'+ neighbor test timers 30 90:' in changes"

    - name: test peer_group_transport_mtud_disable_test
      tags:
        - peer_group_transport_mtud_disable_test
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-network-instance:network-instances:
              network-instance:
                - name: 'default'
                  config:
                    name: 'default'
                    type: 'DEFAULT_INSTANCE'
                    enabled: true
                  protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                          peer-groups:
                            peer-group:
                              - peer-group-name: 'test'
                                config:
                                  peer-group-name: 'test'
                                transport:
                                  config:
                                    mtu-discovery: False
        api_method: PUT
        rollback: true
        assertion_ignore_errors: false
        assertions:
          - "'+ neighbor test transport path-mtu-discovery disable:' in changes"

#    - name: test peer_group_transport_mtud_enable_test  Doesn't show because default
#      tags:
#        - peer_group_transport_mtud_enable_test
#      import_role:
#        name: nso-openconfig-test
#      vars:
#        content: |
#          mdd:openconfig:
#            openconfig-network-instance:network-instances:
#              network-instance:
#                - name: 'default'
#                  config:
#                    name: 'default'
#                    type: 'DEFAULT_INSTANCE'
#                    enabled: true
#                  protocols:
#                    protocol:
#                      - name: 'BGP'
#                        identifier: 'BGP'
#                        config:
#                          enabled: True
#                          identifier: 'BGP'
#                          name: 'BGP'
#                        bgp:
#                          global:
#                            config:
#                              as: 1
#                          peer-groups:
#                            peer-group:
#                              - peer-group-name: 'test'
#                                config:
#                                  peer-group-name: 'test'
#                                transport:
#                                  config:
#                                    mtu-discovery: True
#        api_method: PUT
#        rollback: true
#        assertion_ignore_errors: false
#        assertions:
#          - "'+ neighbor test transport path-mtu-discovery:' in changes"

    - name: test peer_group_transport_passive_mode_test
      tags:
        - peer_group_transport_passive_mode_test
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-network-instance:network-instances:
              network-instance:
                - name: 'default'
                  config:
                    name: 'default'
                    type: 'DEFAULT_INSTANCE'
                    enabled: true
                  protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                          peer-groups:
                            peer-group:
                              - peer-group-name: 'test'
                                config:
                                  peer-group-name: 'test'
                                transport:
                                  config:
                                    passive-mode: True
        api_method: PUT
        rollback: true
        assertion_ignore_errors: false
        assertions:
          - "'+ neighbor test transport connection-mode passive:' in changes"

    - name: test peer_group_transport_local_address_test
      tags:
        - peer_group_transport_local_address_test
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-interfaces:interfaces:
              interface:
                - config:
                    enabled: true
                    name: 'Loopback10'
                    type: 'softwareLoopback'
                    description: 'TEST123'
                  name: 'Loopback10'
                  subinterfaces:
                    subinterface:
                      - config:
                          index: 0
                        index: 0
                        openconfig-if-ip:ipv4:
                          addresses:
                            address:
                              - config:
                                  ip: '172.27.1.2'
                                  prefix-length: 32
                                ip: '172.27.1.2'
                          config:
                            dhcp-client: false
            openconfig-network-instance:network-instances:
              network-instance:
                - name: 'default'
                  config:
                    name: 'default'
                    type: 'DEFAULT_INSTANCE'
                    enabled: true
                  protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                          peer-groups:
                            peer-group:
                              - peer-group-name: 'test'
                                config:
                                  peer-group-name: 'test'
                                transport:
                                  config:
                                    local-address: 'Loopback10'
        api_method: PUT
        rollback: true
        assertion_ignore_errors: false
        assertions:
          - "'+ neighbor test update-source Loopback10:' in changes"

    - name: test peer_group_route_map_in
      tags:
        - peer_group_route_map_in
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-routing-policy:routing-policy:
              defined-sets:
                openconfig-bgp-policy:bgp-defined-sets:
                  as-path-sets:
                    as-path-set:
                      - as-path-set-name: '1'
                        config:
                          as-path-set-name: '1'
                          as-path-set-member:
                            - "^$"
              policy-definitions:
                policy-definition:
                  - name: 'test'
                    config:
                      name: 'test'
                    statements:
                      openconfig-routing-policy:statement:
                        - name: '10'
                          config:
                            name: '10'
                          conditions:
                            openconfig-bgp-policy:bgp-conditions:
                              openconfig-bgp-policy:match-as-path-set:
                                openconfig-bgp-policy:config:
                                  openconfig-bgp-policy:as-path-set: '1'
                                  openconfig-bgp-policy:match-set-options: 'ANY'
                          openconfig-routing-policy:actions:
                            config:
                              policy-result: 'ACCEPT_ROUTE'  # or REJECT_ROUTE
                            openconfig-bgp-policy:bgp-actions:
                              openconfig-bgp-policy:set-community:
                                openconfig-bgp-policy:config:
                                  openconfig-bgp-policy:method: 'INLINE'  # INLINE or REFERENCE
                                  openconfig-bgp-policy:options: 'ADD'  # ADD, REMOVE, REPLACE
                                openconfig-bgp-policy:inline:
                                  openconfig-bgp-policy:config:
                                    openconfig-bgp-policy:communities:
                                      - '100:100'
                        - name: '20'
                          config:
                            name: '20'
                          actions:
                            config:
                              policy-result: 'ACCEPT_ROUTE'  # or REJECT_ROUTE
            openconfig-network-instance:network-instances:
              network-instance:
                - name: 'default'
                  config:
                    name: 'default'
                    type: 'DEFAULT_INSTANCE'
                    enabled: true
                  protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                          peer-groups:
                            peer-group:
                              - config:
                                  peer-group-name: 'test'
                                peer-group-name: 'test'
                                apply-policy:
                                  config:
                                    import-policy:
                                    - 'test'
        api_method: PUT
        rollback: true
        assertion_ignore_errors: false
        assertions:
          - "'+ neighbor test route-map test in:' in changes"

    - name: test peer_group_route_map_out
      tags:
        - peer_group_route_map_out
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-routing-policy:routing-policy:
              defined-sets:
                openconfig-bgp-policy:bgp-defined-sets:
                  as-path-sets:
                    as-path-set:
                      - as-path-set-name: '1'
                        config:
                          as-path-set-name: '1'
                          as-path-set-member:
                            - "^$"
              policy-definitions:
                policy-definition:
                  - name: 'test'
                    config:
                      name: 'test'
                    statements:
                      openconfig-routing-policy:statement:
                        - name: '10'
                          config:
                            name: '10'
                          conditions:
                            openconfig-bgp-policy:bgp-conditions:
                              openconfig-bgp-policy:match-as-path-set:
                                openconfig-bgp-policy:config:
                                  openconfig-bgp-policy:as-path-set: '1'
                                  openconfig-bgp-policy:match-set-options: 'ANY'
                          openconfig-routing-policy:actions:
                            config:
                              policy-result: 'ACCEPT_ROUTE'  # or REJECT_ROUTE
                            openconfig-bgp-policy:bgp-actions:
                              openconfig-bgp-policy:set-community:
                                openconfig-bgp-policy:config:
                                  openconfig-bgp-policy:method: 'INLINE'  # INLINE or REFERENCE
                                  openconfig-bgp-policy:options: 'ADD'  # ADD, REMOVE, REPLACE
                                openconfig-bgp-policy:inline:
                                  openconfig-bgp-policy:config:
                                    openconfig-bgp-policy:communities:
                                      - '100:100'
                        - name: '20'
                          config:
                            name: '20'
                          actions:
                            config:
                              policy-result: 'ACCEPT_ROUTE'  # or REJECT_ROUTE
            openconfig-network-instance:network-instances:
              network-instance:
                - name: 'default'
                  config:
                    name: 'default'
                    type: 'DEFAULT_INSTANCE'
                    enabled: true
                  protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                          peer-groups:
                            peer-group:
                              - config:
                                  peer-group-name: 'test'
                                peer-group-name: 'test'
                                apply-policy:
                                  config:
                                    export-policy:
                                    - 'test'
        api_method: PUT
        rollback: true
        assertion_ignore_errors: false
        assertions:
          - "'+ neighbor test route-map test out:' in changes"

    - name: test ad-ipv4-route-map-in
      tags:
        - ad-ipv4-route-map-in
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-routing-policy:routing-policy:
              defined-sets:
                openconfig-bgp-policy:bgp-defined-sets:
                  as-path-sets:
                    as-path-set:
                      - as-path-set-name: '1'
                        config:
                          as-path-set-name: '1'
                          as-path-set-member:
                            - "^$"
              policy-definitions:
                policy-definition:
                  - name: 'test'
                    config:
                      name: 'test'
                    statements:
                      openconfig-routing-policy:statement:
                        - name: '10'
                          config:
                            name: '10'
                          conditions:
                            openconfig-bgp-policy:bgp-conditions:
                              openconfig-bgp-policy:match-as-path-set:
                                openconfig-bgp-policy:config:
                                  openconfig-bgp-policy:as-path-set: '1'
                                  openconfig-bgp-policy:match-set-options: 'ANY'
                          openconfig-routing-policy:actions:
                            config:
                              policy-result: 'ACCEPT_ROUTE'  # or REJECT_ROUTE
                            openconfig-bgp-policy:bgp-actions:
                              openconfig-bgp-policy:set-community:
                                openconfig-bgp-policy:config:
                                  openconfig-bgp-policy:method: 'INLINE'  # INLINE or REFERENCE
                                  openconfig-bgp-policy:options: 'ADD'  # ADD, REMOVE, REPLACE
                                openconfig-bgp-policy:inline:
                                  openconfig-bgp-policy:config:
                                    openconfig-bgp-policy:communities:
                                      - '100:100'
                        - name: '20'
                          config:
                            name: '20'
                          actions:
                            config:
                              policy-result: 'ACCEPT_ROUTE'  # or REJECT_ROUTE
            openconfig-network-instance:network-instances:
              network-instance:
                - name: 'default'
                  config:
                    name: 'default'
                    type: 'DEFAULT_INSTANCE'
                    enabled: true
                  protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                            afi-safis:
                              afi-safi:
                                - afi-safi-name: 'IPV4_UNICAST'
                                  config:
                                    afi-safi-name: 'IPV4_UNICAST'
                                    enabled: true
                          peer-groups:
                            peer-group:
                              - config:
                                  peer-group-name: 'test'
                                peer-group-name: 'test'
                                afi-safis:
                                  afi-safi:
                                    - afi-safi-name: 'IPV4_UNICAST'
                                      config:
                                        afi-safi-name: 'IPV4_UNICAST'
                                        enabled: true
                                      apply-policy:
                                        config:
                                          import-policy:
                                          - 'test'
        api_method: PUT
        rollback: true
        assertion_ignore_errors: false
        assertions:
          - "'+ address-family ipv4:' in changes"
          - "'+  neighbor test route-map test in:' in changes"

    - name: test ad-ipv4-route-map-out
      tags:
        - ad-ipv4-route-map-out
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-routing-policy:routing-policy:
              defined-sets:
                openconfig-bgp-policy:bgp-defined-sets:
                  as-path-sets:
                    as-path-set:
                      - as-path-set-name: '1'
                        config:
                          as-path-set-name: '1'
                          as-path-set-member:
                            - "^$"
              policy-definitions:
                policy-definition:
                  - name: 'test'
                    config:
                      name: 'test'
                    statements:
                      openconfig-routing-policy:statement:
                        - name: '10'
                          config:
                            name: '10'
                          conditions:
                            openconfig-bgp-policy:bgp-conditions:
                              openconfig-bgp-policy:match-as-path-set:
                                openconfig-bgp-policy:config:
                                  openconfig-bgp-policy:as-path-set: '1'
                                  openconfig-bgp-policy:match-set-options: 'ANY'
                          openconfig-routing-policy:actions:
                            config:
                              policy-result: 'ACCEPT_ROUTE'  # or REJECT_ROUTE
                            openconfig-bgp-policy:bgp-actions:
                              openconfig-bgp-policy:set-community:
                                openconfig-bgp-policy:config:
                                  openconfig-bgp-policy:method: 'INLINE'  # INLINE or REFERENCE
                                  openconfig-bgp-policy:options: 'ADD'  # ADD, REMOVE, REPLACE
                                openconfig-bgp-policy:inline:
                                  openconfig-bgp-policy:config:
                                    openconfig-bgp-policy:communities:
                                      - '100:100'
                        - name: '20'
                          config:
                            name: '20'
                          actions:
                            config:
                              policy-result: 'ACCEPT_ROUTE'  # or REJECT_ROUTE
            openconfig-network-instance:network-instances:
              network-instance:
                - name: 'default'
                  config:
                    name: 'default'
                    type: 'DEFAULT_INSTANCE'
                    enabled: true
                  protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                            afi-safis:
                              afi-safi:
                                - afi-safi-name: 'IPV4_UNICAST'
                                  config:
                                    afi-safi-name: 'IPV4_UNICAST'
                                    enabled: true
                          peer-groups:
                            peer-group:
                              - config:
                                  peer-group-name: 'test'
                                peer-group-name: 'test'
                                afi-safis:
                                  afi-safi:
                                    - afi-safi-name: 'IPV4_UNICAST'
                                      config:
                                        afi-safi-name: 'IPV4_UNICAST'
                                        enabled: true
                                      apply-policy:
                                        config:
                                          export-policy:
                                          - 'test'
        api_method: PUT
        rollback: true
        assertion_ignore_errors: false
        assertions:
          - "'+ address-family ipv4:' in changes"
          - "'+  neighbor test route-map test out:' in changes"

    - name: test ad-vpnv4-activate-route-map-in
      tags:
        - ad-vpnv4-activate-route-map-in
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-routing-policy:routing-policy:
              defined-sets:
                openconfig-bgp-policy:bgp-defined-sets:
                  as-path-sets:
                    as-path-set:
                      - as-path-set-name: '1'
                        config:
                          as-path-set-name: '1'
                          as-path-set-member:
                            - "^$"
              policy-definitions:
                policy-definition:
                  - name: 'test'
                    config:
                      name: 'test'
                    statements:
                      openconfig-routing-policy:statement:
                        - name: '10'
                          config:
                            name: '10'
                          conditions:
                            openconfig-bgp-policy:bgp-conditions:
                              openconfig-bgp-policy:match-as-path-set:
                                openconfig-bgp-policy:config:
                                  openconfig-bgp-policy:as-path-set: '1'
                                  openconfig-bgp-policy:match-set-options: 'ANY'
                          openconfig-routing-policy:actions:
                            config:
                              policy-result: 'ACCEPT_ROUTE'  # or REJECT_ROUTE
                            openconfig-bgp-policy:bgp-actions:
                              openconfig-bgp-policy:set-community:
                                openconfig-bgp-policy:config:
                                  openconfig-bgp-policy:method: 'INLINE'  # INLINE or REFERENCE
                                  openconfig-bgp-policy:options: 'ADD'  # ADD, REMOVE, REPLACE
                                openconfig-bgp-policy:inline:
                                  openconfig-bgp-policy:config:
                                    openconfig-bgp-policy:communities:
                                      - '100:100'
                        - name: '20'
                          config:
                            name: '20'
                          actions:
                            config:
                              policy-result: 'ACCEPT_ROUTE'  # or REJECT_ROUTE
            openconfig-network-instance:network-instances:
              network-instance:
                - name: 'default'
                  config:
                    name: 'default'
                    type: 'DEFAULT_INSTANCE'
                    enabled: true
                  protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                            afi-safis:
                              afi-safi:
                                - afi-safi-name: 'L3VPN_IPV4_UNICAST'
                                  config:
                                    afi-safi-name: 'L3VPN_IPV4_UNICAST'
                                    enabled: true
                          peer-groups:
                            peer-group:
                              - config:
                                  peer-group-name: 'test'
                                peer-group-name: 'test'
                                afi-safis:
                                  afi-safi:
                                    - afi-safi-name: 'L3VPN_IPV4_UNICAST'
                                      config:
                                        afi-safi-name: 'L3VPN_IPV4_UNICAST'
                                        enabled: true
                                      apply-policy:
                                        config:
                                          import-policy:
                                          - 'test'
        api_method: PUT
        rollback: true
        assertion_ignore_errors: false
        assertions:
          - "'+ address-family vpnv4:' in changes"
          - "'+  neighbor test route-map test in:' in changes"

    - name: test ad-vpnv4-activate-route-map-out
      tags:
        - ad-vpnv4-activate-route-map-out
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-routing-policy:routing-policy:
              defined-sets:
                openconfig-bgp-policy:bgp-defined-sets:
                  as-path-sets:
                    as-path-set:
                      - as-path-set-name: '1'
                        config:
                          as-path-set-name: '1'
                          as-path-set-member:
                            - "^$"
              policy-definitions:
                policy-definition:
                  - name: 'test'
                    config:
                      name: 'test'
                    statements:
                      openconfig-routing-policy:statement:
                        - name: '10'
                          config:
                            name: '10'
                          conditions:
                            openconfig-bgp-policy:bgp-conditions:
                              openconfig-bgp-policy:match-as-path-set:
                                openconfig-bgp-policy:config:
                                  openconfig-bgp-policy:as-path-set: '1'
                                  openconfig-bgp-policy:match-set-options: 'ANY'
                          openconfig-routing-policy:actions:
                            config:
                              policy-result: 'ACCEPT_ROUTE'  # or REJECT_ROUTE
                            openconfig-bgp-policy:bgp-actions:
                              openconfig-bgp-policy:set-community:
                                openconfig-bgp-policy:config:
                                  openconfig-bgp-policy:method: 'INLINE'  # INLINE or REFERENCE
                                  openconfig-bgp-policy:options: 'ADD'  # ADD, REMOVE, REPLACE
                                openconfig-bgp-policy:inline:
                                  openconfig-bgp-policy:config:
                                    openconfig-bgp-policy:communities:
                                      - '100:100'
                        - name: '20'
                          config:
                            name: '20'
                          actions:
                            config:
                              policy-result: 'ACCEPT_ROUTE'  # or REJECT_ROUTE
            openconfig-network-instance:network-instances:
              network-instance:
                - name: 'default'
                  config:
                    name: 'default'
                    type: 'DEFAULT_INSTANCE'
                    enabled: true
                  protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                            afi-safis:
                              afi-safi:
                                - afi-safi-name: 'L3VPN_IPV4_UNICAST'
                                  config:
                                    afi-safi-name: 'L3VPN_IPV4_UNICAST'
                                    enabled: true
                          peer-groups:
                            peer-group:
                              - config:
                                  peer-group-name: 'test'
                                peer-group-name: 'test'
                                afi-safis:
                                  afi-safi:
                                    - afi-safi-name: 'L3VPN_IPV4_UNICAST'
                                      config:
                                        afi-safi-name: 'L3VPN_IPV4_UNICAST'
                                        enabled: true
                                      apply-policy:
                                        config:
                                          export-policy:
                                          - 'test'
        api_method: PUT
        rollback: true
        assertion_ignore_errors: false
        assertions:
          - "'+ address-family vpnv4:' in changes"
          - "'+  neighbor test route-map test out:' in changes"

    - name: test ad-ipv4-activate-vrf-route-map-in
      tags:
        - ad-ipv4-activate-vrf-route-map-in
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-routing-policy:routing-policy:
              defined-sets:
                openconfig-bgp-policy:bgp-defined-sets:
                  as-path-sets:
                    as-path-set:
                      - as-path-set-name: '1'
                        config:
                          as-path-set-name: '1'
                          as-path-set-member:
                            - "^$"
              policy-definitions:
                policy-definition:
                  - name: 'test'
                    config:
                      name: 'test'
                    statements:
                      openconfig-routing-policy:statement:
                        - name: '10'
                          config:
                            name: '10'
                          conditions:
                            openconfig-bgp-policy:bgp-conditions:
                              openconfig-bgp-policy:match-as-path-set:
                                openconfig-bgp-policy:config:
                                  openconfig-bgp-policy:as-path-set: '1'
                                  openconfig-bgp-policy:match-set-options: 'ANY'
                          openconfig-routing-policy:actions:
                            config:
                              policy-result: 'ACCEPT_ROUTE'  # or REJECT_ROUTE
                            openconfig-bgp-policy:bgp-actions:
                              openconfig-bgp-policy:set-community:
                                openconfig-bgp-policy:config:
                                  openconfig-bgp-policy:method: 'INLINE'  # INLINE or REFERENCE
                                  openconfig-bgp-policy:options: 'ADD'  # ADD, REMOVE, REPLACE
                                openconfig-bgp-policy:inline:
                                  openconfig-bgp-policy:config:
                                    openconfig-bgp-policy:communities:
                                      - '100:100'
                        - name: '20'
                          config:
                            name: '20'
                          actions:
                            config:
                              policy-result: 'ACCEPT_ROUTE'  # or REJECT_ROUTE
            openconfig-network-instance:network-instances:
              network-instance:
                - name: 'default'
                  config:
                    name: 'default'
                    type: 'DEFAULT_INSTANCE'
                    enabled: true
                  protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                            afi-safis:
                              afi-safi:
                                - afi-safi-name: 'IPV4_UNICAST'
                                  config:
                                    afi-safi-name: 'IPV4_UNICAST'
                                    enabled: true
                - name: 'abc'
                  config:
                    name: 'abc'
                    type: 'L3VRF'
                    enabled: true
                    enabled-address-families:
                      - 'IPV4'
                    route-distinguisher: '1:1'
                    openconfig-network-instance-ext:route-targets-import:
                      - '100:100'
                      - '101:101'
                    openconfig-network-instance-ext:route-targets-export:
                      - '200:200'
                      - '202:202'
                  openconfig-network-instance:protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                            afi-safis:
                              afi-safi:
                                - afi-safi-name: 'IPV4_UNICAST'
                                  config:
                                    afi-safi-name: 'IPV4_UNICAST'
                                    enabled: true
                          peer-groups:
                            peer-group:
                              - config:
                                  peer-group-name: 'test'
                                peer-group-name: 'test'
                                afi-safis:
                                  afi-safi:
                                    - afi-safi-name: 'IPV4_UNICAST'
                                      config:
                                        afi-safi-name: 'IPV4_UNICAST'
                                        enabled: true
                                      apply-policy:
                                        config:
                                          import-policy:
                                          - 'test'
        api_method: PUT
        rollback: true
        assertion_ignore_errors: false
        assertions:
          - "'+ address-family ipv4 vrf abc:' in changes"
          - "'+  neighbor test peer-group:' in changes"
          - "'+  neighbor test route-map test in:' in changes"

    - name: test ad-ipv4-activate-vrf-route-map-out
      tags:
        - ad-ipv4-activate-vrf-route-map-out
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-routing-policy:routing-policy:
              defined-sets:
                openconfig-bgp-policy:bgp-defined-sets:
                  as-path-sets:
                    as-path-set:
                      - as-path-set-name: '1'
                        config:
                          as-path-set-name: '1'
                          as-path-set-member:
                            - "^$"
              policy-definitions:
                policy-definition:
                  - name: 'test'
                    config:
                      name: 'test'
                    statements:
                      openconfig-routing-policy:statement:
                        - name: '10'
                          config:
                            name: '10'
                          conditions:
                            openconfig-bgp-policy:bgp-conditions:
                              openconfig-bgp-policy:match-as-path-set:
                                openconfig-bgp-policy:config:
                                  openconfig-bgp-policy:as-path-set: '1'
                                  openconfig-bgp-policy:match-set-options: 'ANY'
                          openconfig-routing-policy:actions:
                            config:
                              policy-result: 'ACCEPT_ROUTE'  # or REJECT_ROUTE
                            openconfig-bgp-policy:bgp-actions:
                              openconfig-bgp-policy:set-community:
                                openconfig-bgp-policy:config:
                                  openconfig-bgp-policy:method: 'INLINE'  # INLINE or REFERENCE
                                  openconfig-bgp-policy:options: 'ADD'  # ADD, REMOVE, REPLACE
                                openconfig-bgp-policy:inline:
                                  openconfig-bgp-policy:config:
                                    openconfig-bgp-policy:communities:
                                      - '100:100'
                        - name: '20'
                          config:
                            name: '20'
                          actions:
                            config:
                              policy-result: 'ACCEPT_ROUTE'  # or REJECT_ROUTE
            openconfig-network-instance:network-instances:
              network-instance:
                - name: 'default'
                  config:
                    name: 'default'
                    type: 'DEFAULT_INSTANCE'
                    enabled: true
                  protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                            afi-safis:
                              afi-safi:
                                - afi-safi-name: 'IPV4_UNICAST'
                                  config:
                                    afi-safi-name: 'IPV4_UNICAST'
                                    enabled: true
                - name: 'abc'
                  config:
                    name: 'abc'
                    type: 'L3VRF'
                    enabled: true
                    enabled-address-families:
                      - 'IPV4'
                    route-distinguisher: '1:1'
                    openconfig-network-instance-ext:route-targets-import:
                      - '100:100'
                      - '101:101'
                    openconfig-network-instance-ext:route-targets-export:
                      - '200:200'
                      - '202:202'
                  openconfig-network-instance:protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                            afi-safis:
                              afi-safi:
                                - afi-safi-name: 'IPV4_UNICAST'
                                  config:
                                    afi-safi-name: 'IPV4_UNICAST'
                                    enabled: true
                          peer-groups:
                            - peer-group:
                                config:
                                  peer-group-name: 'test'
                                peer-group-name: 'test'
                                afi-safis:
                                  afi-safi:
                                    - afi-safi-name: 'IPV4_UNICAST'
                                      config:
                                        afi-safi-name: 'IPV4_UNICAST'
                                        enabled: true
                                      apply-policy:
                                        config:
                                          export-policy:
                                          - 'test'
        api_method: PUT
        rollback: true
        assertion_ignore_errors: false
        assertions:
          - "'+ address-family ipv4 vrf abc:' in changes"
          - "'+  neighbor test peer-group:' in changes"
          - "'+  neighbor test route-map test out:' in changes"

    - name: test ad-ipv4-activate-vrf-send-label
      tags:
        - ad-ipv4-activate-vrf-send-label
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-routing-policy:routing-policy:
              defined-sets:
                openconfig-bgp-policy:bgp-defined-sets:
                  as-path-sets:
                    as-path-set:
                      - as-path-set-name: '1'
                        config:
                          as-path-set-name: '1'
                          as-path-set-member:
                            - "^$"
              policy-definitions:
                policy-definition:
                  - name: 'test'
                    config:
                      name: 'test'
                    statements:
                      openconfig-routing-policy:statement:
                        - name: '10'
                          config:
                            name: '10'
                          conditions:
                            openconfig-bgp-policy:bgp-conditions:
                              openconfig-bgp-policy:match-as-path-set:
                                openconfig-bgp-policy:config:
                                  openconfig-bgp-policy:as-path-set: '1'
                                  openconfig-bgp-policy:match-set-options: 'ANY'
                          openconfig-routing-policy:actions:
                            config:
                              policy-result: 'ACCEPT_ROUTE'  # or REJECT_ROUTE
                            openconfig-bgp-policy:bgp-actions:
                              openconfig-bgp-policy:set-community:
                                openconfig-bgp-policy:config:
                                  openconfig-bgp-policy:method: 'INLINE'  # INLINE or REFERENCE
                                  openconfig-bgp-policy:options: 'ADD'  # ADD, REMOVE, REPLACE
                                openconfig-bgp-policy:inline:
                                  openconfig-bgp-policy:config:
                                    openconfig-bgp-policy:communities:
                                      - '100:100'
                        - name: '20'
                          config:
                            name: '20'
                          actions:
                            config:
                              policy-result: 'ACCEPT_ROUTE'  # or REJECT_ROUTE
            openconfig-network-instance:network-instances:
              network-instance:
                - name: 'default'
                  config:
                    name: 'default'
                    type: 'DEFAULT_INSTANCE'
                    enabled: true
                  protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                            afi-safis:
                              afi-safi:
                                - afi-safi-name: 'IPV4_UNICAST'
                                  config:
                                    afi-safi-name: 'IPV4_UNICAST'
                                    enabled: true
                - name: 'abc'
                  config:
                    name: 'abc'
                    type: 'L3VRF'
                    enabled: true
                    enabled-address-families:
                      - 'IPV4'
                    route-distinguisher: '1:1'
                    openconfig-network-instance-ext:route-targets-import:
                      - '100:100'
                      - '101:101'
                    openconfig-network-instance-ext:route-targets-export:
                      - '200:200'
                      - '202:202'
                  openconfig-network-instance:protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                            afi-safis:
                              afi-safi:
                                - afi-safi-name: 'IPV4_LABELED_UNICAST'
                                  config:
                                    afi-safi-name: 'IPV4_LABELED_UNICAST'
                                    enabled: true
                          peer-groups:
                            peer-group:
                              - config:
                                  peer-group-name: 'test'
                                peer-group-name: 'test'
                                afi-safis:
                                  afi-safi:
                                    - afi-safi-name: 'IPV4_LABELED_UNICAST'
                                      config:
                                        afi-safi-name: 'IPV4_LABELED_UNICAST'
                                        enabled: true
                                      apply-policy:
                                        config:
                                          export-policy:
                                          - 'test'
        api_method: PUT
        rollback: true
        assertion_ignore_errors: false
        assertions:
          - "'+ address-family ipv4 vrf abc:' in changes"
          - "'+  neighbor test peer-group:' in changes"
          - "'+  neighbor test route-map test out:' in changes"
          - "'+  neighbor test send-label:' in changes"

    - name: test ad-ipv4-activate-vrf-as-override
      tags:
        - ad-ipv4-activate-vrf-as-override
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-network-instance:network-instances:
              network-instance:
                - name: 'default'
                  config:
                    name: 'default'
                    type: 'DEFAULT_INSTANCE'
                    enabled: true
                  protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                            afi-safis:
                              afi-safi:
                                - afi-safi-name: 'IPV4_UNICAST'
                                  config:
                                    afi-safi-name: 'IPV4_UNICAST'
                                    enabled: true
                - name: 'abc'
                  config:
                    name: 'abc'
                    type: 'L3VRF'
                    enabled: true
                    enabled-address-families:
                      - 'IPV4'
                    route-distinguisher: '1:1'
                    openconfig-network-instance-ext:route-targets-import:
                      - '100:100'
                      - '101:101'
                    openconfig-network-instance-ext:route-targets-export:
                      - '200:200'
                      - '202:202'
                  openconfig-network-instance:protocols:
                    protocol:
                      - name: 'BGP'
                        identifier: 'BGP'
                        config:
                          enabled: True
                          identifier: 'BGP'
                          name: 'BGP'
                        bgp:
                          global:
                            config:
                              as: 1
                            afi-safis:
                              afi-safi:
                                - afi-safi-name: 'IPV4_UNICAST'
                                  config:
                                    afi-safi-name: 'IPV4_UNICAST'
                                    enabled: true
                          peer-groups:
                            peer-group:
                              - config:
                                  peer-group-name: 'test'
                                peer-group-name: 'test'
                                afi-safis:
                                  afi-safi:
                                    - afi-safi-name: 'IPV4_UNICAST'
                                      config:
                                        afi-safi-name: 'IPV4_UNICAST'
                                        enabled: true
                                as-path-options:
                                  config:
                                    replace-peer-as: True
        api_method: PUT
        rollback: true
        assertion_ignore_errors: false
        assertions:
          - "'+ address-family ipv4 vrf abc:' in changes"
          - "'+  neighbor test peer-group:' in changes"
          - "'+  neighbor test as-override:' in changes"
