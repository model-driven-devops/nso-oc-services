---
# Test apply_ntp_serve_acl
- hosts: xe1
  connection: network_cli
  gather_facts: no
  tags:
    - all
    - apply_ntp_serve_acl
  vars:
    ansible_network_os: 'cisco.ios.ios'
  roles:
    - ansible-pyats
  tasks:
    - name: collect config (before)
      ios_command:
        commands:
          - show run
      register: result_before

- hosts: localhost
  gather_facts: no
  tags:
    - all
    - apply_ntp_serve_acl
  vars:
    device_name: xe1
    content: |
      mdd:openconfig:
        openconfig-acl:acl:
          acl-sets:
            acl-set:
              - config:
                  name: '11'
                  type: 'openconfig-acl-ext:ACL_IPV4_STANDARD'
                name: '11'
                type: 'openconfig-acl-ext:ACL_IPV4_STANDARD'
                acl-entries:
                  acl-entry:
                    - actions:
                        config:
                          forwarding-action: 'ACCEPT'
                          log-action: 'LOG_NONE'
                      config:
                        sequence-id: '10'
                      openconfig-acl-ext:ipv4:
                        source-address: '0.0.0.0/0'
                      sequence-id: '10'
          openconfig-acl-ext:ntp:
            openconfig-acl-ext:serve:
              openconfig-acl-ext:serve-acl-set: '11'

  tasks:
    - name: Convert string to JSON
      set_fact:
        configs: "{{ content | from_yaml | to_json }}"
    - name: JSON configs
      debug:
        msg: "{{ configs }}"
    - name: ACL apply_ntp_serve_acl
      uri:
        url: "http://{{ hostvars['nso'].ansible_host }}:8080/restconf/data/tailf-ncs:devices/device=xe1/mdd:openconfig"
        url_username: admin
        url_password: admin
        force_basic_auth: yes
        validate_certs: no
        status_code: [200,201,204]
        method: PUT
        headers: "{
          'Content-Type': 'application/yang-data+json',
          'Accept': 'application/yang-data+json'}"
        body_format: json
        body: "{{ configs }}"

- hosts: xe1
  connection: network_cli
  gather_facts: no
  tags:
    - all
    - apply_ntp_serve_acl
  vars:
    ansible_network_os: 'cisco.ios.ios'
    exclude_list:
      - (^Using.*)
      - (Building.*)
      - (Current.*)
      - (crypto pki certificate chain.*)
  roles:
    - ansible-pyats
  tasks:
    - name: collect config (after)
      ios_command:
        commands:
          - show run
      register: result_after
    - set_fact:
        changes: "{{ result_before.stdout[0] | genie_config_diff(result_after.stdout[0], mode='add', exclude=exclude_list) }}"
    - name: debug changes
      debug:
        msg: "{{ changes }}"
    - assert:
        that:
          - "'+ntp access-group serve 11:' in changes"
      ignore_errors: yes
- hosts: localhost
  gather_facts: no
  tags:
    - all
    - apply_ntp_serve_acl
    - rollback
  tasks:
    - name: Rollback
      uri:
        url: "http://{{ hostvars['nso'].ansible_host }}:8080/restconf/data/tailf-rollback:rollback-files/apply-rollback-file"
        url_username: admin
        url_password: admin
        force_basic_auth: yes
        validate_certs: no
        status_code: [ 204 ]
        method: POST
        headers: "{
          'Content-Type': 'application/yang-data+xml'}"
        body: |
          <input xmlns="http://tail-f.com/ns/rollback">
            <id>0</id>
          </input>

# Test apply_ntp_peer_acl
- hosts: xe1
  connection: network_cli
  gather_facts: no
  tags:
    - all
    - apply_ntp_peer_acl
  vars:
    ansible_network_os: 'cisco.ios.ios'
  roles:
    - ansible-pyats
  tasks:
    - name: collect config (before)
      ios_command:
        commands:
          - show run
      register: result_before

- hosts: localhost
  gather_facts: no
  tags:
    - all
    - apply_ntp_peer_acl
  vars:
    device_name: xe1
    content: |
      mdd:openconfig:
        openconfig-acl:acl:
          acl-sets:
            acl-set:
              - config:
                  name: '11'
                  type: 'openconfig-acl-ext:ACL_IPV4_STANDARD'
                name: '11'
                type: 'openconfig-acl-ext:ACL_IPV4_STANDARD'
                acl-entries:
                  acl-entry:
                    - actions:
                        config:
                          forwarding-action: 'ACCEPT'
                          log-action: 'LOG_NONE'
                      config:
                        sequence-id: '10'
                      openconfig-acl-ext:ipv4:
                        source-address: '0.0.0.0/0'
                      sequence-id: '10'
          openconfig-acl-ext:ntp:
            openconfig-acl-ext:peer:
              openconfig-acl-ext:peer-acl-set: '11'

  tasks:
    - name: Convert string to JSON
      set_fact:
        configs: "{{ content | from_yaml | to_json }}"
    - name: JSON configs
      debug:
        msg: "{{ configs }}"
    - name: ACL apply_ntp_peer_acl
      uri:
        url: "http://{{ hostvars['nso'].ansible_host }}:8080/restconf/data/tailf-ncs:devices/device=xe1/mdd:openconfig"
        url_username: admin
        url_password: admin
        force_basic_auth: yes
        validate_certs: no
        status_code: [200,201,204]
        method: PUT
        headers: "{
          'Content-Type': 'application/yang-data+json',
          'Accept': 'application/yang-data+json'}"
        body_format: json
        body: "{{ configs }}"

- hosts: xe1
  connection: network_cli
  gather_facts: no
  tags:
    - all
    - apply_ntp_peer_acl
  vars:
    ansible_network_os: 'cisco.ios.ios'
    exclude_list:
      - (^Using.*)
      - (Building.*)
      - (Current.*)
      - (crypto pki certificate chain.*)
  roles:
    - ansible-pyats
  tasks:
    - name: collect config (after)
      ios_command:
        commands:
          - show run
      register: result_after
    - set_fact:
        changes: "{{ result_before.stdout[0] | genie_config_diff(result_after.stdout[0], mode='add', exclude=exclude_list) }}"
    - name: debug changes
      debug:
        msg: "{{ changes }}"
    - assert:
        that:
          - "'+ntp access-group peer 11:' in changes"
      ignore_errors: yes
- hosts: localhost
  gather_facts: no
  tags:
    - all
    - apply_ntp_peer_acl
    - rollback
  tasks:
    - name: Rollback
      uri:
        url: "http://{{ hostvars['nso'].ansible_host }}:8080/restconf/data/tailf-rollback:rollback-files/apply-rollback-file"
        url_username: admin
        url_password: admin
        force_basic_auth: yes
        validate_certs: no
        status_code: [ 204 ]
        method: POST
        headers: "{
          'Content-Type': 'application/yang-data+xml'}"
        body: |
          <input xmlns="http://tail-f.com/ns/rollback">
            <id>0</id>
          </input>
