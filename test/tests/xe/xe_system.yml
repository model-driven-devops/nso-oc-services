---
- hosts: nso
  connection: local
  gather_facts: no
  roles:
    - nso-rollback-save
  run_once: true
  vars:
    rollback_file: "{{ lookup('env', 'PWD') }}/rollback.yaml"

- hosts: localhost
  gather_facts: no
  tags:
    - disable_ned_checks
  vars:
    device_name: "{{ lookup('env', 'TEST_DEVICE_XEROUTER') | default('xe1', True) }}"
    content: |
      config-warning: 
        - warning: .*
  tasks:
    - name: Convert string to JSON
      set_fact:
        configs: "{{ content | from_yaml | to_json }}"
    - name: JSON configs
      debug:
        msg: "{{ configs }}"
    - name: DISABLE NED checks - For error message from deleting radius server before removing radius server group
      uri:
        url: "http://{{ lookup('env', 'NSO_HOST') }}:8080/restconf/data/tailf-ncs:devices/device={{device_name}}/ned-settings/tailf-ned-cisco-ios-meta:cisco-ios/write/config-warning"
        url_username: "{{ lookup('env', 'NSO_USERNAME') }}"
        url_password: "{{ lookup('env', 'NSO_PASSWORD') }}"
        force_basic_auth: yes
        validate_certs: no
        status_code: [200,201,204]
        method: PATCH
        headers: "{
          'Content-Type': 'application/yang-data+json',
          'Accept': 'application/yang-data+json'}"
        body_format: json
        body: "{{ configs }}"

- name: test system
  hosts: "{{ lookup('env', 'TEST_DEVICE_XEROUTER') | default('xe1', True) }}"
  gather_facts: no
  connection: network_cli
  vars:
    device: "{{ lookup('env', 'TEST_DEVICE_XEROUTER') | default('xe1', True) }}"
    ansible_network_os: 'cisco.ios.ios'
  tasks:
    - name: test system_config
      tags:
        - system_config
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-system:system:
              config:
                openconfig-system-ext:enable-secret: 'password'
                openconfig-system-ext:console-exec-timeout-seconds: 800
                domain-name: 'test123.com'
                hostname: 'rxx'
                login-banner: |
                  This is the login-banner.
                motd-banner: |
                  This is the motd-banner.
        api_method: PUT
        api_ignore_errors: false
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+hostname rxx:' in changes"
          - "'+ip domain name test123.com:' in changes"
          - "'+banner login ^CThis is the login-banner.:' in changes"
          - "'+banner motd ^CThis is the motd-banner.:' in changes"
          - "' line con 0:' in changes"
          - "'+ exec-timeout 13 20:' in changes"

    - name: test ip_option_drop
      tags:
        - ip_option_drop
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-system:system:
              config:
                openconfig-system-ext:ip-options: 'DROP'
        api_method: PUT
        api_ignore_errors: false
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+ip options drop:' in changes"
    - name: test ip_option_ignore
      tags:
        - ip_option_ignore
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-system:system:
              config:
                openconfig-system-ext:ip-options: 'IGNORE'
        api_method: PUT
        api_ignore_errors: false
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+ip options ignore:' in changes"
    - name: test ip_option_enable
      tags:
        - ip_option_enable
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-system:system:
              config:
                openconfig-system-ext:ip-options: 'ENABLE'
        api_method: PUT
        api_ignore_errors: false
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'-ip options ignore:' in changes"

    - name: test ssh_server
      tags:
        - ssh_server
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-interfaces:interfaces:
              interface:
                - config:
                    enabled: true
                    name: 'GigabitEthernet6'
                    type: 'ethernetCsmacd'
                  openconfig-if-ethernet:ethernet:
                    config:
                      auto-negotiate: true
                      enable-flow-control: false
                  hold-time:
                    config:
                      down: 10
                  name: 'GigabitEthernet6'
                  subinterfaces:
                    subinterface:
                      - config:
                          index: 0
                        index: 0
                        openconfig-if-ip:ipv4:
                          addresses:
                            address:
                              - config:
                                  ip: '10.6.0.1'
                                  prefix-length: 30
                                ip: '10.6.0.1'
                          config:
                            dhcp-client: false
            openconfig-system:system:
              ssh-server:
                config:
                  openconfig-system-ext:absolute-timeout-minutes: 1200
                  openconfig-system-ext:ssh-timeout: 55
                  openconfig-system-ext:ssh-source-interface: 'GigabitEthernet6'
                  enable: true
                  protocol-version: 'V2'
                  session-limit: 16
                  timeout: 1800
        api_method: PUT
        api_ignore_errors: false
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+ absolute-timeout 1200:' in changes"
          - "'+ip ssh time-out 55:' in changes"
          - "'+ip ssh source-interface GigabitEthernet6:' in changes"
          - "'+ip ssh version 2:' in changes"
          - "'+ session-limit 16:' in changes"
          - "'+ exec-timeout 30 0:' in changes"

    - name: test ntp_server
      tags:
        - ntp_server
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-interfaces:interfaces:
              interface:
                - config:
                    enabled: true
                    name: 'GigabitEthernet6'
                    type: 'ethernetCsmacd'
                  openconfig-if-ethernet:ethernet:
                    config:
                      auto-negotiate: true
                      enable-flow-control: false
                  hold-time:
                    config:
                      down: 10
                  name: 'GigabitEthernet6'
                  subinterfaces:
                    subinterface:
                      - config:
                          index: 0
                        index: 0
                        openconfig-if-ip:ipv4:
                          addresses:
                            address:
                              - config:
                                  ip: '10.6.0.1'
                                  prefix-length: 30
                                ip: '10.6.0.1'
                          config:
                            dhcp-client: false
                - config:
                    enabled: true
                    name: 'GigabitEthernet7'
                    type: 'ethernetCsmacd'
                  openconfig-if-ethernet:ethernet:
                    config:
                      auto-negotiate: true
                      enable-flow-control: false
                  hold-time:
                    config:
                      down: 10
                  name: 'GigabitEthernet7'
                  subinterfaces:
                    subinterface:
                      - config:
                          index: 0
                        index: 0
                        openconfig-if-ip:ipv4:
                          addresses:
                            address:
                              - config:
                                  ip: '10.7.0.1'
                                  prefix-length: 30
                                ip: '10.7.0.1'
                          config:
                            dhcp-client: false
            openconfig-network-instance:network-instances:
              network-instance:
                - name: 'default'  # All interfaces are in default unless listed under other VRF
                  config:
                    name: 'default'
                    type: 'DEFAULT_INSTANCE'
                    enabled: true
                  interfaces:
                    interface:
                      - id: 'GigabitEthernet6'
                        config:
                          id: 'GigabitEthernet6'
                          interface: 'GigabitEthernet6'
                          subinterface: 0
                - name: 'abc'
                  config:
                    name: 'abc'
                    type: 'L3VRF'  # oc-ni-types:DEFAULT_INSTANCE
                    enabled: true  # not in IOS
                    enabled-address-families:
                      - 'IPV4'
                  interfaces:
                    interface:
                      - id: 'GigabitEthernet7'
                        config:
                          id: 'GigabitEthernet7'
                          interface: 'GigabitEthernet7'
                          subinterface: 0
            openconfig-system:system:
              ntp:
                config:
                  enabled: true
                  enable-ntp-auth: true
                  openconfig-system-ext:ntp-enable-logging: true
                  ntp-source-address: '10.6.0.1'
                ntp-keys:
                  ntp-key:
                    - config:
                        key-id: 1
                        key-type: 'NTP_AUTH_MD5'
                        key-value: 'password1'
                      key-id: 1
                    - config:
                        key-id: 2
                        key-type: 'NTP_AUTH_MD5'
                        key-value: 'password2'
                      key-id: 2
                servers:
                  server:
                    - address: '10.0.0.1'
                      config:
                        openconfig-system-ext:ntp-auth-key-id: 1
                        openconfig-system-ext:ntp-use-vrf: 'default'
                        address: '10.0.0.1'
                        association-type: 'SERVER'  # SERVER, PEER, POOL
                        iburst: true
                        port: 123  # always 123 for ios
                        prefer: false
                        version: 4
                    - address: '10.0.0.2'
                      config:
                        openconfig-system-ext:ntp-auth-key-id: 2
                        openconfig-system-ext:ntp-use-vrf: 'abc'
                        address: '10.0.0.2'
                        association-type: 'PEER'
                        iburst: true
                        port: 123  # always 123 for ios
                        prefer: false
                        version: 4
                    - address: '10.0.0.3'
                      config:
                        openconfig-system-ext:ntp-auth-key-id: 1
                        openconfig-system-ext:ntp-source-address: '10.6.0.1'
                        address: '10.0.0.3'
                        association-type: 'SERVER'  # SERVER, PEER, POOL
                        iburst: true
                        port: 123  # always 123 for ios
                        prefer: true
                        version: 3
        api_method: PUT
        api_ignore_errors: false
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+ntp authenticate:' in changes"
          - "'+ntp logging:' in changes"
          - "'+ntp source GigabitEthernet6:' in changes"
          - "'+ntp server 10.0.0.1 key 1:' in changes"
          - "'+ntp peer vrf abc 10.0.0.2 key 2:' in changes"
          - "'+ntp trusted-key 1:' in changes"
          - "'+ntp trusted-key 2:' in changes"
          - "'+ntp server 10.0.0.1 key 1:' in changes"
          - "'+ntp peer vrf abc 10.0.0.2 key 2:' in changes"
          - "'+ntp server 10.0.0.3 key 1 prefer source GigabitEthernet6 version 3:' in changes"
#Hashes Change#          - "'+ntp authentication-key 1 md5 044B0A151C36435C0D48 7:' in changes"  #Hashes Change
#Hashes Change#          - "'+ntp authentication-key 2 md5 071F205F5D1E16171340 7:' in changes"

    - name: test logging_server
      tags:
        - logging_server
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-interfaces:interfaces:
              interface:
                - config:
                    enabled: true
                    name: 'GigabitEthernet6'
                    type: 'ethernetCsmacd'
                  openconfig-if-ethernet:ethernet:
                    config:
                      auto-negotiate: true
                      enable-flow-control: false
                  hold-time:
                    config:
                      down: 10
                  name: 'GigabitEthernet6'
                  subinterfaces:
                    subinterface:
                      - config:
                          index: 0
                        index: 0
                        openconfig-if-ip:ipv4:
                          addresses:
                            address:
                              - config:
                                  ip: '10.6.0.1'
                                  prefix-length: 30
                                ip: '10.6.0.1'
                          config:
                            dhcp-client: false
                - config:
                    enabled: true
                    name: 'GigabitEthernet7'
                    type: 'ethernetCsmacd'
                  openconfig-if-ethernet:ethernet:
                    config:
                      auto-negotiate: true
                      enable-flow-control: false
                  hold-time:
                    config:
                      down: 10
                  name: 'GigabitEthernet7'
                  subinterfaces:
                    subinterface:
                      - config:
                          index: 0
                        index: 0
                        openconfig-if-ip:ipv4:
                          addresses:
                            address:
                              - config:
                                  ip: '10.7.0.1'
                                  prefix-length: 30
                                ip: '10.7.0.1'
                          config:
                            dhcp-client: false
            openconfig-network-instance:network-instances:
              network-instance:
                - name: 'default'  # All interfaces are in default unless listed under other VRF
                  config:
                    name: 'default'
                    type: 'DEFAULT_INSTANCE'
                    enabled: true
                - name: 'abc'
                  config:
                    name: 'abc'
                    type: 'L3VRF'  # oc-ni-types:DEFAULT_INSTANCE
                    enabled: true  # not in IOS
                    enabled-address-families:
                      - 'IPV4'
                  interfaces:
                    interface:
                      - id: 'GigabitEthernet7'
                        config:
                          id: 'GigabitEthernet7'
                          interface: 'GigabitEthernet7'
                          subinterface: 0
            openconfig-system:system:
              logging:  # facility must be same for all in IOS
                console:  # set console
                  config: { }
                  selectors:
                    selector:
                      - config:
                          facility: 'SYSLOG'
                          severity: 'INFORMATIONAL'  # logging console
                        facility: 'SYSLOG'
                        severity: 'INFORMATIONAL'
                openconfig-system-ext:terminal-monitor: # set monitor
                  selectors:
                    selector:
                      - config:
                          facility: 'SYSLOG'
                          severity: 'ALERT'  # logging monitor
                        facility: 'SYSLOG'
                        severity: 'ALERT'
                remote-servers:
                  remote-server:
                    - config:
                        host: '10.0.0.1'  # logging host x.x.x.x
                        remote-port: 514
                        source-address: '10.7.0.1'
                        openconfig-system-ext:use-vrf: 'abc'
                      host: '10.0.0.1'
                      selectors:
                        selector:
                          - config:
                              facility: 'SYSLOG'
                              severity: 'CRITICAL'
                            facility: 'SYSLOG'
                            severity: 'CRITICAL'
                    - config:
                        host: '10.0.0.2'  # logging host x.x.x.x
                        remote-port: 514
                        source-address: '10.6.0.1'
                        openconfig-system-ext:use-vrf: 'default'
                      host: '10.0.0.2'
                      selectors:
                        selector:
                          - config:
                              facility: 'SYSLOG'
                              severity: 'CRITICAL'
                            facility: 'SYSLOG'
                            severity: 'CRITICAL'
                    - config:
                        host: '10.0.0.3'  # logging host x.x.x.x
                        remote-port: 514
                        source-address: '10.6.0.1'
                      host: '10.0.0.3'
                      selectors:
                        selector:
                          - config:
                              facility: 'SYSLOG'
                              severity: 'CRITICAL'
                            facility: 'SYSLOG'
                            severity: 'CRITICAL'
        api_method: PUT
        api_ignore_errors: false
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+logging console informational:' in changes"
          - "'+logging monitor alerts:' in changes"
          - "'+logging trap critical:' in changes"
          - "'+logging facility syslog:' in changes"
          - "'+logging host 10.0.0.1 vrf abc:' in changes"
          - "'+logging source-interface GigabitEthernet7 vrf abc:' in changes"
          - "'+logging host 10.0.0.2:' in changes"
          - "'+logging host 10.0.0.3:' in changes"
          - "'+logging source-interface GigabitEthernet6:' in changes"

    - name: test dns-servers
      tags:
        - dns-servers
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-network-instance:network-instances:
              network-instance:
                - name: 'default'  # All interfaces are in default unless listed under other VRF
                  config:
                    name: 'default'
                    type: 'DEFAULT_INSTANCE'
                    enabled: true
                - name: 'abc'
                  config:
                    name: 'abc'
                    type: 'L3VRF'  # oc-ni-types:DEFAULT_INSTANCE
                    enabled: true  # not in IOS
                    enabled-address-families:
                      - 'IPV4'
            openconfig-system:system:
              dns:
                servers:
                  server:
                    - address: '8.8.8.8'
                      config:
                        address: '8.8.8.8'
                        port: 53  # always 53 for ios
                    - address: '8.8.4.4'
                      config:
                        address: '8.8.4.4'
                        port: 53  # always 53 for ios
                    - address: '8.8.5.5'
                      config:
                        address: '8.8.5.5'
                        port: 53  # always 53 for ios
                        openconfig-system-ext:use-vrf: 'abc'
        api_method: PUT
        api_ignore_errors: false
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+ip name-server 8.8.8.8 8.8.4.4:' in changes"
          - "'+ip name-server vrf abc 8.8.5.5:' in changes"

    - name: test clock_timezone
      tags:
        - clock_timezone
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-system:system:
              clock:
                config:
                  timezone-name: 'CST -6 0'
        api_method: PUT
        api_ignore_errors: false
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+clock timezone CST -6 0:' in changes"

- name: test system
  hosts: "{{ lookup('env', 'TEST_DEVICE_XEROUTER') | default('xe1', True) }}"
  gather_facts: no
  connection: network_cli
  vars:
    device: "{{ lookup('env', 'TEST_DEVICE_XEROUTER') | default('xe1', True) }}"
    ansible_network_os: 'cisco.ios.ios'
  tasks:
    - name: test http_server
      tags:
        - http_server
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-system:system:
              openconfig-system-ext:services:
                openconfig-system-ext:http:
                  openconfig-system-ext:config:
                    openconfig-system-ext:http-enabled: true
                    openconfig-system-ext:https-enabled: true
                    openconfig-system-ext:ip-http-max-connections: 4
                    openconfig-system-ext:ip-http-secure-ciphersuite:
                      - 'aes-256-cbc-sha'
                      - 'aes-128-cbc-sha'
        api_method: PUT
        api_ignore_errors: false
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+ip http secure-server:' in changes"
          - "'+ip http server:' in changes"
          - "'+ip http max-connections 4:' in changes"
          - "'+ip http secure-ciphersuite aes-128-cbc-sha aes-256-cbc-sha:' in changes"
    - name: test http_server
      tags:
        - http_server
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-system:system:
              openconfig-system-ext:services:
                openconfig-system-ext:http:
                  openconfig-system-ext:config:
                    openconfig-system-ext:http-enabled: false
                    openconfig-system-ext:https-enabled: false
        api_method: PATCH
        api_ignore_errors: false
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+no ip http secure-server:' in changes"
          - "'+no ip http server:' in changes"
    - name: test finger_service
      tags:
        - finger_service
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-system:system:
              openconfig-system-ext:services:
                openconfig-system-ext:config:
                  finger: true
        api_method: PATCH
        api_ignore_errors: false
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+ip finger:' in changes"
    - name: test set_up
      tags:
        - set_up
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-system:system:
              openconfig-system-ext:services:
                openconfig-system-ext:config:
                  finger: false
        api_method: PATCH
        api_ignore_errors: false
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'-ip finger:' in changes"

- name: test system
  hosts: "{{ lookup('env', 'TEST_DEVICE_XEROUTER') | default('xe1', True) }}"
  gather_facts: no
  connection: network_cli
  vars:
    device: "{{ lookup('env', 'TEST_DEVICE_XEROUTER') | default('xe1', True) }}"
    ansible_network_os: 'cisco.ios.ios'
  tasks:
    - name: test http_timeout_policy
      tags:
        - http_timeout_policy
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-system:system:
              openconfig-system-ext:services:
                openconfig-system-ext:http:
                  openconfig-system-ext:ip-http-timeout-policy:
                    openconfig-system-ext:idle:
                      openconfig-system-ext:config:
                        openconfig-system-ext:connection: 240
                        openconfig-system-ext:life: 240
                        openconfig-system-ext:requests: 3
        api_method: PUT
        api_ignore_errors: false
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+ip http timeout-policy idle 240 life 240 requests 3:' in changes"

    - name: test timestamps_datetime
      tags:
        - timestamps_datetime
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-system:system:
              openconfig-system-ext:timestamps:
                openconfig-system-ext:logging:
                  openconfig-system-ext:config:
                    openconfig-system-ext:enabled: true
                    openconfig-system-ext:datetime: true
                    openconfig-system-ext:uptime: false
                    openconfig-system-ext:localtime: true
                openconfig-system-ext:debugging:
                  openconfig-system-ext:config:
                    openconfig-system-ext:enabled: true
                    openconfig-system-ext:datetime: true
                    openconfig-system-ext:uptime: false
                    openconfig-system-ext:localtime: true
        api_method: PUT
        api_ignore_errors: false
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+service timestamps debug datetime msec localtime:' in changes"
          - "'+service timestamps log datetime msec localtime:' in changes"

    - name: test timestamps_uptime
      tags:
        - timestamps_uptime
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-system:system:
              openconfig-system-ext:timestamps:
                openconfig-system-ext:logging:
                  openconfig-system-ext:config:
                    openconfig-system-ext:enabled: true
                    openconfig-system-ext:datetime: false
                    openconfig-system-ext:uptime: true
                    openconfig-system-ext:localtime: true
                openconfig-system-ext:debugging:
                  openconfig-system-ext:config:
                    openconfig-system-ext:enabled: true
                    openconfig-system-ext:datetime: false
                    openconfig-system-ext:uptime: true
                    openconfig-system-ext:localtime: true
        api_method: PUT
        api_ignore_errors: false
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+service timestamps debug uptime:' in changes"
          - "'+service timestamps log uptime:' in changes"

    - name: test console-and-monitor-severity-emergency
      tags:
        - console-and-monitor-severity-emergency
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-system:system:
              logging:  # facility must be same for all in IOS
                console:  # set console and monitor
                  config: { }
                  selectors:
                    selector:
                      - config:
                          facility: 'SYSLOG'
                          severity: 'EMERGENCY'
                        facility: 'SYSLOG'
                        severity: 'EMERGENCY'
                openconfig-system-ext:terminal-monitor:
                  selectors:
                    selector:
                      - config:
                          facility: 'SYSLOG'
                          severity: 'EMERGENCY'
                        facility: 'SYSLOG'
                        severity: 'EMERGENCY'
        api_method: PUT
        api_ignore_errors: false
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+logging facility syslog:' in changes"
          - "'+logging console emergencies:' in changes"
          - "'+logging monitor emergencies:' in changes"

    - name: test remote-servers-severity-emergency
      tags:
        - remote-servers-severity-emergency
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-system:system:
              logging:  # facility must be same for all in IOS
                remote-servers:
                  remote-server:
                    - config:
                        host: '10.0.0.1'  # logging host x.x.x.x
                        remote-port: 514
                      host: '10.0.0.1'
                      selectors:
                        selector:
                          - config:
                              facility: 'SYSLOG'
                              severity: 'EMERGENCY'
                            facility: 'SYSLOG'
                            severity: 'EMERGENCY'
        api_method: PUT
        api_ignore_errors: false
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+logging trap emergencies:' in changes"

    - name: test any-emergency
      tags:
        - any-emergency
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-system:system:
              logging:  # facility must be same for all in IOS
                console:  # set console and monitor
                  config: { }
                  selectors:
                    selector:
                      - config:
                          facility: 'SYSLOG'
                          severity: 'CRITICAL'
                        facility: 'SYSLOG'
                        severity: 'CRITICAL'
                openconfig-system-ext:terminal-monitor:  # set console and monitor
                  selectors:
                    selector:
                      - config:
                          facility: 'SYSLOG'
                          severity: 'CRITICAL'
                        facility: 'SYSLOG'
                        severity: 'CRITICAL'
                remote-servers:
                  remote-server:
                    - config:
                        host: '10.0.0.1'  # logging host x.x.x.x
                        remote-port: 514
                      host: '10.0.0.1'
                      selectors:
                        selector:
                          - config:
                              facility: 'SYSLOG'
                              severity: 'ERROR'
                            facility: 'SYSLOG'
                            severity: 'ERROR'
        api_method: PUT
        api_ignore_errors: false
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+logging console critical:' in changes"
          - "'+logging monitor critical:' in changes"
          - "'+logging trap errors:' in changes"

    - name: test aaa-all
      tags:
        - aaa-all
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-interfaces:interfaces:
              interface:
                - config:
                    enabled: true
                    name: 'GigabitEthernet6'
                    type: 'ethernetCsmacd'
                  openconfig-if-ethernet:ethernet:
                    config:
                      auto-negotiate: true
                      enable-flow-control: false
                  hold-time:
                    config:
                      down: 10
                  name: 'GigabitEthernet6'
                  subinterfaces:
                    subinterface:
                      - config:
                          index: 0
                        index: 0
                        openconfig-if-ip:ipv4:
                          addresses:
                            address:
                              - config:
                                  ip: '10.6.0.1'
                                  prefix-length: 30
                                ip: '10.6.0.1'
                          config:
                            dhcp-client: false
            openconfig-system:system:
              config:
                openconfig-system-ext:enable-secret: 'admin'
              aaa:
                accounting:
                  config:
                    accounting-method:  # group name, TACACS_ALL
                      - 'TACACS-GROUP-1'
                      - 'TACACS_ALL'
                  events:
                    event:  # OC supports command and login
                      - config:
                          event-type: 'AAA_ACCOUNTING_EVENT_LOGIN'  # IOS aaa accounting exec for ios
                          record: 'STOP'  # or START_STOP
                        event-type: 'AAA_ACCOUNTING_EVENT_LOGIN'
                      - config:
                          event-type: 'AAA_ACCOUNTING_EVENT_COMMAND'  # IOS aaa accounting commanda and priv 15
                          record: 'STOP'  # or START_STOP
                        event-type: 'AAA_ACCOUNTING_EVENT_COMMAND'
                authentication:
                  admin-user:
                    config:
                      admin-password: 'admin'
                      admin-password-hashed: ''
                  config:
                    authentication-method:
                      - 'LOCAL'
                  users:
                    user:
                      - config:
                          username: 'user1'
                          password: 'Password123'
                          password-hashed: ''
                          role: 'SYSTEM_ROLE_ADMIN'  # This is the one role in model
                          ssh-key: ''
                        username: 'user1'
                      - config:
                          username: 'user2'
                          password: 'Password123'
                          password-hashed: ''
                          role: 'SYSTEM_ROLE_ADMIN'  # This is the one role in model
                          ssh-key: ''
                        username: 'user2'
                authorization:
                  config:
                    authorization-method:
          #                - 'TACACS_ALL'
                      - 'LOCAL'
                  events:
                    event:
                      - config:
                          event-type: 'AAA_AUTHORIZATION_EVENT_CONFIG'  # Specifies configuration (e.g., EXEC) events for AAA
                        event-type: 'AAA_AUTHORIZATION_EVENT_CONFIG'
          #                - config:
          #                    event-type: 'AAA_AUTHORIZATION_EVENT_COMMAND'  # Specifies interactive command events for AAA authorization
          #                  event-type: 'AAA_AUTHORIZATION_EVENT_COMMAND'
                config: { }
                server-groups:
                  server-group:
                    - config:
                        name: 'TACACS-GROUP-1'
                        type: 'TACACS'
                      name: 'TACACS-GROUP-1'
                      servers:
                        server:
                          - address: '10.1.1.1'
                            config:
                              address: '10.1.1.1'
                              name: 'TACACSSVR1'
                              timeout: 10
                            tacacs:
                              config:
                                port: 49
                                secret-key: 'Password123'
                                source-address: '10.6.0.1'  # For each group, sources must be the same
                          - address: '10.2.2.2'
                            config:
                              address: '10.2.2.2'
                              name: 'TACACSSVR2'
                              timeout: 10
                            tacacs:
                              config:
                                port: 49
                                secret-key: 'Password123'
                                source-address: '10.6.0.1'  # For each group, sources must be the same
                    - config:
                        name: 'TACACS-GROUP-2'
                        type: 'TACACS'
                      name: 'TACACS-GROUP-2'
                      servers:
                        server:
                          - address: '10.3.3.3'
                            config:
                              address: '10.3.3.3'
                              name: 'TACACSSVR3'
                              timeout: 10
                            tacacs:
                              config:
                                port: 49
                                secret-key: 'Password123'
                                source-address: '10.6.0.1'  # For each group, sources must be the same
                          - address: '10.4.4.4'
                            config:
                              address: '10.4.4.4'
                              name: 'TACACSSVR4'
                              timeout: 10
                            tacacs:
                              config:
                                port: 49
                                secret-key: 'Password123'
                                source-address: '10.6.0.1'  # For each group, sources must be the same
                    - config:
                        name: 'RADIUS-GROUP-1'
                        type: 'RADIUS'
                      name: 'RADIUS-GROUP-1'
                      servers:
                        server:
                          - address: '10.5.5.5'
                            config:
                              address: '10.5.5.5'
                              name: 'RADIUSSVR1'
                              timeout: 10
                            radius:
                              config:
                                acct-port: 1853
                                auth-port: 1852
                                secret-key: 'Password123'
                                source-address: '10.6.0.1'  # For each group, sources must be the same
                          - address: '10.6.6.6'
                            config:
                              address: '10.6.6.6'
                              name: 'RADIUSSVR2'
                              timeout: 10
                            radius:
                              config:
                                acct-port: 1853
                                auth-port: 1852
                                secret-key: 'Password123'
                                source-address: '10.6.0.1'  # For each group, sources must be the same
        api_method: PUT
        api_ignore_errors: false
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+aaa new-model:' in changes"
          - "'+aaa accounting commands 15 default stop-only group TACACS-GROUP-1 group tacacs+:' in changes"
          - "'+aaa accounting exec default stop-only group TACACS-GROUP-1 group tacacs+:' in changes"
          - "'+aaa authentication login default local:' in changes"
          - "'+aaa authorization exec default local:' in changes"
          - "'+aaa group server tacacs+ TACACS-GROUP-1:' in changes"
          - "'+ server name TACACSSVR1:' in changes"
          - "'+ server name TACACSSVR2:' in changes"
          - "'+ ip tacacs source-interface GigabitEthernet6:' in changes"
          - "'+aaa group server tacacs+ TACACS-GROUP-2:' in changes"
          - "'+ server name TACACSSVR3:' in changes"
          - "'+ server name TACACSSVR4:' in changes"
          - "'+ ip tacacs source-interface GigabitEthernet6:' in changes"
          - "'+tacacs server TACACSSVR1:' in changes"
          - "'+ address ipv4 10.2.2.2:' in changes"
          - "'+ key Password123:' in changes"
          - "'+tacacs server TACACSSVR2:' in changes"
          - "'+ address ipv4 10.2.2.2:' in changes"
          - "'+ key Password123:' in changes"
          - "'+tacacs server TACACSSVR3:' in changes"
          - "'+ address ipv4 10.3.3.3:' in changes"
          - "'+ key Password123:' in changes"
          - "'+tacacs server TACACSSVR4:' in changes"
          - "'+ address ipv4 10.4.4.4:' in changes"
          - "'+ key Password123:' in changes"
          - "'+aaa group server radius RADIUS-GROUP-1:' in changes"
          - "'+ server name RADIUSSVR1:' in changes"
          - "'+ server name RADIUSSVR2:' in changes"
          - "'+ ip radius source-interface GigabitEthernet6:' in changes"
          - "'+radius server RADIUSSVR1:' in changes"
          - "'+ address ipv4 10.5.5.5 auth-port 1852 acct-port 1853:' in changes"
          - "'+ key Password123:' in changes"
          - "'+radius server RADIUSSVR2:' in changes"
          - "'+ address ipv4 10.6.6.6 auth-port 1852 acct-port 1853:' in changes"
          - "'+ key Password123:' in changes"
#          - "'+username admin privilege 15 secret 0 admin:' in changes"  # passwords will be hashed
#          - "'+username user1 privilege 15 secret 0 Password123:' in changes"
#          - "'+username user2 privilege 15 secret 0 Password123:' in changes"

# xe1(config)#no radius server RADIUSSVR1
#xe1(config)#
#*Feb 24 21:44:33.502: %RADIUS-4-SERVREFNAME: Warning: Server RADIUSSVR1 is still referenced by server group.
# Command still works hence disregarding NED errors at the top of file

    - name: test aaa-authentication-login-lists
      tags:
        - aaa-authentication-login-lists
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-system:system:
              config:
                openconfig-system-ext:enable-secret: 'admin'
              aaa:
                authentication:
                  admin-user:
                    config:
                      admin-password: 'admin'
                      admin-password-hashed: ''
                  config:
                    authentication-method:
                      - 'LOCAL'
                  openconfig-system-ext:authentication-lists-login:
                    openconfig-system-ext:config:
                      openconfig-system-ext:name: 'USETACACS'
                      openconfig-system-ext:authentication-method: 
                        - 'LOCAL'
        api_method: PATCH
        api_ignore_errors: false
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+aaa authentication login USETACACS local:' in changes"

- name: test services
  hosts: "{{ lookup('env', 'TEST_DEVICE_XEROUTER') | default('xe1', True) }}"
  gather_facts: no
  connection: network_cli
  vars:
    device: "{{ lookup('env', 'TEST_DEVICE_XEROUTER') | default('xe1', True) }}"
    ansible_network_os: 'cisco.ios.ios'
  tasks:
    - name: test tcp_udp_gratuitous_arp_password_encryption configuration
      tags:
        - tcp_udp_gratuitous_arp_password_encryption
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-system:system:
              openconfig-system-ext:services:
                openconfig-system-ext:config:
                  ip-gratuitous-arps: true
                  service-password-encryption: true
                  service-tcp-small-servers: true
                  service-udp-small-servers: true
        api_method: PUT
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+ip gratuitous-arps:' in changes"
          - "'+service password-encryption:' in changes"
          - "'+service tcp-small-servers:' in changes"
          - "'+service udp-small-servers:' in changes"

- name: test services
  hosts: "{{ lookup('env', 'TEST_DEVICE_XEROUTER') | default('xe1', True) }}"
  gather_facts: no
  connection: network_cli
  vars:
    device: "{{ lookup('env', 'TEST_DEVICE_XEROUTER') | default('xe1', True) }}"
    ansible_network_os: 'cisco.ios.ios'
  tasks:
    - name: test no_tcp_udp_gratuitous_arp_password_encryption configuration
      tags:
        - no_tcp_udp_gratuitous_arp_password_encryption
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-system:system:
              openconfig-system-ext:services:
                openconfig-system-ext:config:
                  ip-gratuitous-arps: false
                  service-password-encryption: false
                  service-tcp-small-servers: false
                  service-udp-small-servers: false
                  finger: true
        api_method: PATCH
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'-ip gratuitous-arps:' in changes"
          - "'-service password-encryption:' in changes"
          - "'-service tcp-small-servers:' in changes"
          - "'-service udp-small-servers:' in changes"

    - name: test logging_buffered
      tags:
        - logging_buffered
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-system:system:
              logging:
               openconfig-system-ext:buffered:
                  openconfig-system-ext:config:
                      openconfig-system-ext:enabled: true
                      openconfig-system-ext:severity: 'INFORMATIONAL'
                      openconfig-system-ext:buffer-size: 200000
        api_method: PUT
        api_ignore_errors: false
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+logging buffered 200000 informational:' in changes"

    - name: test logging_buffered
      tags:
        - logging_buffered
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-system:system:
              logging:
               openconfig-system-ext:buffered:
                  openconfig-system-ext:config:
                      openconfig-system-ext:enabled: false
        api_method: PUT
        api_ignore_errors: false
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+no logging buffered:' in changes"

    - name: test no_logging_console
      tags:
        - no_logging_console
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-system:system:
              logging:
               console:
                 config:
                   openconfig-system-ext:enabled: false
        api_method: PUT
        api_ignore_errors: false
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+no logging console:' in changes"

    - name: test no_ip_domain_lookup
      tags:
        - no_ip_domain_lookup
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-system:system:
              openconfig-system-ext:services:
                openconfig-system-ext:config:
                  openconfig-system-ext:ip-domain-lookup: false
        api_method: PUT
        api_ignore_errors: false
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+no ip domain lookup:' in changes"

- hosts: nso
  connection: local
  gather_facts: no
  roles:
    - nso-rollback-load
  run_once: true
  vars:
    rollback_file: "{{ lookup('env', 'PWD') }}/rollback.yaml"