---
- name: test stp
  hosts: "{{ lookup('env', 'TEST_DEVICE_XESWITCH') | default('xeswitch1', True) }}"
  gather_facts: no
  connection: network_cli
  vars:
    device: "{{ lookup('env', 'TEST_DEVICE_XESWITCH') | default('xeswitch1', True) }}"
    ansible_network_os: 'cisco.ios.ios'
  tasks:
    - name: stp_global
      tags:
        - stp_global
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-network-instance:network-instances:
              openconfig-network-instance:network-instance:
                - openconfig-network-instance:name: 'default'
                  openconfig-network-instance:config:
                    openconfig-network-instance:name: 'default'
                    openconfig-network-instance:type: 'DEFAULT_INSTANCE'
                    openconfig-network-instance:enabled: true
                  openconfig-network-instance:vlans:
                    openconfig-network-instance:vlan:
                      - openconfig-network-instance:vlan-id: 100
                        openconfig-network-instance:config:
                          openconfig-network-instance:vlan-id: 100
                          openconfig-network-instance:name: 'VLAN100'
                          openconfig-network-instance:status: 'ACTIVE'
            openconfig-spanning-tree:stp:
              openconfig-spanning-tree:global:
                openconfig-spanning-tree:config:
                  openconfig-spanning-tree:loop-guard: true
                  openconfig-spanning-tree:etherchannel-misconfig-guard: false
                  openconfig-spanning-tree:bpdu-guard: true
                  openconfig-spanning-tree:bpdu-filter: true
                  openconfig-spanning-tree:enabled-protocol:
                    - PVST
        api_method: PUT
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+spanning-tree loopguard default:' in changes"
          - "'+no spanning-tree etherchannel guard misconfig:' in changes"
          - "'+spanning-tree portfast edge bpduguard default:' in changes"
          - "'+spanning-tree portfast edge bpdufilter default:' in changes"

- name: test stp
  hosts: "{{ lookup('env', 'TEST_DEVICE_XESWITCH') | default('xeswitch1', True) }}"
  gather_facts: no
  connection: network_cli
  vars:
    device: "{{ lookup('env', 'TEST_DEVICE_XESWITCH') | default('xeswitch1', True) }}"
    ansible_network_os: 'cisco.ios.ios'
  tasks:
    - name: stp_rpvst
      tags:
        - stp_rpvst
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-interfaces:interfaces:
              openconfig-interfaces:interface:
                - openconfig-interfaces:name: 'GigabitEthernet1/0'
                  openconfig-interfaces:config:
                    openconfig-interfaces:description: 'Access Port Example'
                    openconfig-interfaces:enabled: true
                    openconfig-interfaces:loopback-mode: false
                    openconfig-interfaces:name: 'GigabitEthernet1/0'
                    openconfig-interfaces:type: 'l2vlan'
                  openconfig-if-ethernet:ethernet:
                    openconfig-if-ethernet:config:
                      openconfig-if-ethernet:auto-negotiate: true
                      openconfig-if-ethernet:enable-flow-control: false
                    openconfig-vlan:switched-vlan:
                      openconfig-vlan:config:
                        openconfig-vlan:access-vlan: 100
                        openconfig-vlan:interface-mode: 'ACCESS'
                  openconfig-interfaces:hold-time:
                    openconfig-interfaces:config:
                      openconfig-interfaces:down: 0
                      openconfig-interfaces:up: 0
                - openconfig-interfaces:name: 'GigabitEthernet1/1'
                  openconfig-interfaces:config:
                    openconfig-interfaces:description: 'Trunk Port Example'
                    openconfig-interfaces:enabled: true
                    openconfig-interfaces:loopback-mode: false
                    openconfig-interfaces:name: 'GigabitEthernet1/1'
                    openconfig-interfaces:type: 'l2vlan'
                  openconfig-if-ethernet:ethernet:
                    openconfig-if-ethernet:config:
                      openconfig-if-ethernet:auto-negotiate: true
                      openconfig-if-ethernet:enable-flow-control: false
                    openconfig-vlan:switched-vlan:
                      openconfig-vlan:config:
                        openconfig-vlan:interface-mode: 'TRUNK'
                        openconfig-vlan:native-vlan: 99
                        openconfig-vlan:trunk-vlans:
                          - 100
                          - 200
                  openconfig-interfaces:hold-time:
                    openconfig-interfaces:config:
                      openconfig-interfaces:down: 0
                      openconfig-interfaces:up: 0
            openconfig-network-instance:network-instances:
              openconfig-network-instance:network-instance:
                - openconfig-network-instance:name: 'default'
                  openconfig-network-instance:config:
                    openconfig-network-instance:name: 'default'
                    openconfig-network-instance:type: 'DEFAULT_INSTANCE'
                    openconfig-network-instance:enabled: true
                  openconfig-network-instance:vlans:
                    openconfig-network-instance:vlan:
                      - openconfig-network-instance:vlan-id: 100
                        openconfig-network-instance:config:
                          openconfig-network-instance:vlan-id: 100
                          openconfig-network-instance:name: 'VLAN100'
                          openconfig-network-instance:status: 'ACTIVE'
                      - openconfig-network-instance:vlan-id: 200
                        openconfig-network-instance:config:
                          openconfig-network-instance:vlan-id: 200
                          openconfig-network-instance:name: 'VLAN200'
                          openconfig-network-instance:status: 'ACTIVE'
            openconfig-spanning-tree:stp:
              openconfig-spanning-tree:global:
                openconfig-spanning-tree:config:
                  openconfig-spanning-tree:loop-guard: true
                  openconfig-spanning-tree:etherchannel-misconfig-guard: true
                  openconfig-spanning-tree:bpdu-guard: true
                  openconfig-spanning-tree:bpdu-filter: false
                  openconfig-spanning-tree:enabled-protocol:
                    - RAPID_PVST
              openconfig-spanning-tree:rapid-pvst:
                openconfig-spanning-tree:vlan:
                  - openconfig-spanning-tree:vlan-id: 100
                    openconfig-spanning-tree:config:
                      openconfig-spanning-tree:vlan-id: 100
                      openconfig-spanning-tree:forwarding-delay: 20  # 4 to 30
                      openconfig-spanning-tree:hello-time: 3  # 1 to 10
                      openconfig-spanning-tree:max-age: 40  # 6 to 40
                      openconfig-spanning-tree:bridge-priority: 16384  # 0 to 61440
                    openconfig-spanning-tree:interfaces:
                      openconfig-spanning-tree:interface:
                        - openconfig-spanning-tree:name: GigabitEthernet1/0
                          openconfig-spanning-tree:config:
                            openconfig-spanning-tree:name: GigabitEthernet1/0
                            openconfig-spanning-tree:cost: 10
                            openconfig-spanning-tree:port-priority: 64
                        - openconfig-spanning-tree:name: GigabitEthernet1/1
                          openconfig-spanning-tree:config:
                            openconfig-spanning-tree:name: GigabitEthernet1/1
                            openconfig-spanning-tree:cost: 200
                            openconfig-spanning-tree:port-priority: 96
                  - openconfig-spanning-tree:vlan-id: 200
                    openconfig-spanning-tree:config:
                      openconfig-spanning-tree:vlan-id: 200
                      openconfig-spanning-tree:forwarding-delay: 20  # 4 to 30
                      openconfig-spanning-tree:hello-time: 3  # 1 to 10
                      openconfig-spanning-tree:max-age: 40  # 6 to 40
                      openconfig-spanning-tree:bridge-priority: 61440  # 0 to 61440
                    openconfig-spanning-tree:interfaces:
                      openconfig-spanning-tree:interface:
                        - openconfig-spanning-tree:name: GigabitEthernet1/0
                          openconfig-spanning-tree:config:
                            openconfig-spanning-tree:name: GigabitEthernet1/0
                            openconfig-spanning-tree:cost: 10
                            openconfig-spanning-tree:port-priority: 64
                        - openconfig-spanning-tree:name: GigabitEthernet1/1
                          openconfig-spanning-tree:config:
                            openconfig-spanning-tree:name: GigabitEthernet1/1
                            openconfig-spanning-tree:cost: 200
                            openconfig-spanning-tree:port-priority: 96
        api_method: PUT
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+spanning-tree mode rapid-pvst:' in changes"
          - "'+spanning-tree vlan 100,200 forward-time 20:' in changes"
          - "'+spanning-tree vlan 100,200 hello-time 3:' in changes"
          - "'+spanning-tree vlan 100,200 max-age 40:' in changes"
          - "'+spanning-tree vlan 100 priority 16384:' in changes"
          - "'+spanning-tree vlan 200 priority 61440:' in changes"
          - "' interface GigabitEthernet1/0:' in changes"
          - "'+ spanning-tree cost 10:' in changes"
          - "'+ spanning-tree port-priority 64:' in changes"
          - "' interface GigabitEthernet1/1:' in changes"
          - "'+ spanning-tree cost 200:' in changes"
          - "'+ spanning-tree port-priority 96:' in changes"

- name: test stp
  hosts: "{{ lookup('env', 'TEST_DEVICE_XESWITCH') | default('xeswitch1', True) }}"
  gather_facts: no
  connection: network_cli
  vars:
    device: "{{ lookup('env', 'TEST_DEVICE_XESWITCH') | default('xeswitch1', True) }}"
    ansible_network_os: 'cisco.ios.ios'
  tasks:
    - name: stp_pvst
      tags:
        - stp_pvst
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-interfaces:interfaces:
              openconfig-interfaces:interface:
                - openconfig-interfaces:name: 'GigabitEthernet1/0'
                  openconfig-interfaces:config:
                    openconfig-interfaces:description: 'Access Port Example'
                    openconfig-interfaces:enabled: true
                    openconfig-interfaces:loopback-mode: false
                    openconfig-interfaces:name: 'GigabitEthernet1/0'
                    openconfig-interfaces:type: 'l2vlan'
                  openconfig-if-ethernet:ethernet:
                    openconfig-if-ethernet:config:
                      openconfig-if-ethernet:auto-negotiate: true
                      openconfig-if-ethernet:enable-flow-control: false
                    openconfig-vlan:switched-vlan:
                      openconfig-vlan:config:
                        openconfig-vlan:access-vlan: 100
                        openconfig-vlan:interface-mode: 'ACCESS'
                  openconfig-interfaces:hold-time:
                    openconfig-interfaces:config:
                      openconfig-interfaces:down: 0
                      openconfig-interfaces:up: 0
                - openconfig-interfaces:name: 'GigabitEthernet1/1'
                  openconfig-interfaces:config:
                    openconfig-interfaces:description: 'Trunk Port Example'
                    openconfig-interfaces:enabled: true
                    openconfig-interfaces:loopback-mode: false
                    openconfig-interfaces:name: 'GigabitEthernet1/1'
                    openconfig-interfaces:type: 'l2vlan'
                  openconfig-if-ethernet:ethernet:
                    openconfig-if-ethernet:config:
                      openconfig-if-ethernet:auto-negotiate: true
                      openconfig-if-ethernet:enable-flow-control: false
                    openconfig-vlan:switched-vlan:
                      openconfig-vlan:config:
                        openconfig-vlan:interface-mode: 'TRUNK'
                        openconfig-vlan:native-vlan: 99
                        openconfig-vlan:trunk-vlans:
                          - 100
                          - 200
                  openconfig-interfaces:hold-time:
                    openconfig-interfaces:config:
                      openconfig-interfaces:down: 0
                      openconfig-interfaces:up: 0
            openconfig-spanning-tree:stp:
              openconfig-spanning-tree:global:
                openconfig-spanning-tree:config:
                  openconfig-spanning-tree:loop-guard: true
                  openconfig-spanning-tree:etherchannel-misconfig-guard: true
                  openconfig-spanning-tree:bpdu-guard: true
                  openconfig-spanning-tree:bpdu-filter: false
                  openconfig-spanning-tree-ext:uplinkfast: true
                  openconfig-spanning-tree-ext:backbonefast: true
                  openconfig-spanning-tree:enabled-protocol:
                    - 'PVST'
              openconfig-spanning-tree-ext:pvst:
                openconfig-spanning-tree-ext:vlan:
                  - openconfig-spanning-tree-ext:vlan-id: 100
                    openconfig-spanning-tree-ext:config:
                      openconfig-spanning-tree-ext:vlan-id: 100
                      openconfig-spanning-tree-ext:forwarding-delay: 10  # 4 to 30
                      openconfig-spanning-tree-ext:hello-time: 4  # 1 to 10
                      openconfig-spanning-tree-ext:max-age: 30  # 6 to 40
                      openconfig-spanning-tree-ext:bridge-priority: 61440  # 0 to 61440
                    openconfig-spanning-tree-ext:interfaces:
                      openconfig-spanning-tree-ext:interface:
                        - openconfig-spanning-tree-ext:name: GigabitEthernet1/0
                          openconfig-spanning-tree-ext:config:
                            openconfig-spanning-tree-ext:name: GigabitEthernet1/0
                            openconfig-spanning-tree-ext:cost: 11
                            openconfig-spanning-tree-ext:port-priority: 96
                        - openconfig-spanning-tree-ext:name: GigabitEthernet1/1
                          openconfig-spanning-tree-ext:config:
                            openconfig-spanning-tree-ext:name: GigabitEthernet1/1
                            openconfig-spanning-tree-ext:cost: 201
                            openconfig-spanning-tree-ext:port-priority: 64
                  - openconfig-spanning-tree-ext:vlan-id: 200
                    openconfig-spanning-tree-ext:config:
                      openconfig-spanning-tree-ext:vlan-id: 200
                      openconfig-spanning-tree-ext:forwarding-delay: 10  # 4 to 30
                      openconfig-spanning-tree-ext:hello-time: 4  # 1 to 10
                      openconfig-spanning-tree-ext:max-age: 30  # 6 to 40
                      openconfig-spanning-tree-ext:bridge-priority: 16384  # 0 to 61440
                    openconfig-spanning-tree-ext:interfaces:
                      openconfig-spanning-tree-ext:interface:
                        - openconfig-spanning-tree-ext:name: GigabitEthernet1/0
                          openconfig-spanning-tree-ext:config:
                            openconfig-spanning-tree-ext:name: GigabitEthernet1/0
                            openconfig-spanning-tree-ext:cost: 11
                            openconfig-spanning-tree-ext:port-priority: 96
                        - openconfig-spanning-tree-ext:name: GigabitEthernet1/1
                          openconfig-spanning-tree-ext:config:
                            openconfig-spanning-tree-ext:name: GigabitEthernet1/1
                            openconfig-spanning-tree-ext:cost: 201
                            openconfig-spanning-tree-ext:port-priority: 64
        api_method: PUT
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+spanning-tree vlan 100,200 forward-time 10:' in changes"
          - "'+spanning-tree vlan 100,200 hello-time 4:' in changes"
          - "'+spanning-tree vlan 100,200 max-age 30:' in changes"
          - "'+spanning-tree vlan 100 priority 16384:' in changes"
          - "'+spanning-tree vlan 200 priority 61440:' in changes"
          - "'+spanning-tree uplinkfast:' in changes"
          - "'+spanning-tree backbonefast:' in changes"
          - "' interface GigabitEthernet1/0:' in changes"
          - "'+ spanning-tree cost 11:' in changes"
          - "'+ spanning-tree port-priority 96:' in changes"
          - "' interface GigabitEthernet1/1:' in changes"
          - "'+ spanning-tree cost 201:' in changes"
          - "'+ spanning-tree port-priority 64:' in changes"
#          - "'+spanning-tree mode pvst:' in changes" # default

    - name: stp_interface_rstp_manual_edge
      tags:
        - stp_interface_rstp_manual_edge
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-interfaces:interfaces:
              openconfig-interfaces:interface:
                - openconfig-interfaces:name: 'GigabitEthernet1/0'
                  openconfig-interfaces:config:
                    openconfig-interfaces:description: 'Access Port Example'
                    openconfig-interfaces:enabled: true
                    openconfig-interfaces:loopback-mode: false
                    openconfig-interfaces:name: 'GigabitEthernet1/0'
                    openconfig-interfaces:type: 'l2vlan'
                  openconfig-if-ethernet:ethernet:
                    openconfig-if-ethernet:config:
                      openconfig-if-ethernet:auto-negotiate: true
                      openconfig-if-ethernet:enable-flow-control: false
                    openconfig-vlan:switched-vlan:
                      openconfig-vlan:config:
                        openconfig-vlan:access-vlan: 200
                        openconfig-vlan:interface-mode: 'ACCESS'
                  openconfig-interfaces:hold-time:
                    openconfig-interfaces:config:
                      openconfig-interfaces:down: 0
                      openconfig-interfaces:up: 0
                - openconfig-interfaces:name: 'GigabitEthernet1/1'
                  openconfig-interfaces:config:
                    openconfig-interfaces:description: 'Trunk Port Example'
                    openconfig-interfaces:enabled: true
                    openconfig-interfaces:loopback-mode: false
                    openconfig-interfaces:name: 'GigabitEthernet1/1'
                    openconfig-interfaces:type: 'l2vlan'
                  openconfig-if-ethernet:ethernet:
                    openconfig-if-ethernet:config:
                      openconfig-if-ethernet:auto-negotiate: true
                      openconfig-if-ethernet:enable-flow-control: false
                    openconfig-vlan:switched-vlan:
                      openconfig-vlan:config:
                        openconfig-vlan:interface-mode: 'TRUNK'
                        openconfig-vlan:native-vlan: 99
                        openconfig-vlan:trunk-vlans:
                          - 100
                          - 200
                          - 300
                  openconfig-interfaces:hold-time:
                    openconfig-interfaces:config:
                      openconfig-interfaces:down: 0
                      openconfig-interfaces:up: 0
                - openconfig-interfaces:name: 'Port-channel1'
                  openconfig-if-aggregate:aggregation:
                    openconfig-if-aggregate:config:
                      openconfig-if-aggregate:lag-type: 'LACP'
                    openconfig-vlan:switched-vlan:
                      openconfig-vlan:config:
                        openconfig-vlan:interface-mode: 'TRUNK'
                        openconfig-vlan:native-vlan: 99
                        openconfig-vlan:trunk-vlans:
                          - 100
                          - 200
                          - 300
                  openconfig-interfaces:config:
                    openconfig-interfaces:description: 'LACP Example PO1'
                    openconfig-interfaces:enabled: true
                    openconfig-interfaces:mtu: 1500
                    openconfig-interfaces:name: 'Port-channel1'
                    openconfig-interfaces:type: 'ieee8023adLag'
                - openconfig-interfaces:name: 'GigabitEthernet1/2'
                  openconfig-interfaces:config:
                    openconfig-interfaces:description: 'LACP Link Trunk Port Example'
                    openconfig-interfaces:enabled: true
                    openconfig-interfaces:mtu: 1500
                    openconfig-interfaces:name: 'GigabitEthernet1/2'
                    openconfig-interfaces:type: 'ethernetCsmacd'
                  openconfig-if-ethernet:ethernet:
                    openconfig-if-ethernet:config:
                      openconfig-if-aggregate:aggregate-id: 'Port-channel1'
                    openconfig-vlan:switched-vlan:
                      openconfig-vlan:config:
                        openconfig-vlan:interface-mode: 'TRUNK'
                        openconfig-vlan:native-vlan: 99
                        openconfig-vlan:trunk-vlans:
                          - 100
                          - 200
                          - 300
                - openconfig-interfaces:name: 'GigabitEthernet1/3'
                  openconfig-interfaces:config:
                    openconfig-interfaces:description: 'Trunk Port To Server Example'
                    openconfig-interfaces:enabled: true
                    openconfig-interfaces:loopback-mode: false
                    openconfig-interfaces:name: 'GigabitEthernet1/3'
                    openconfig-interfaces:type: 'l2vlan'
                  openconfig-if-ethernet:ethernet:
                    openconfig-if-ethernet:config:
                      openconfig-if-ethernet:auto-negotiate: true
                      openconfig-if-ethernet:enable-flow-control: false
                    openconfig-vlan:switched-vlan:
                      openconfig-vlan:config:
                        openconfig-vlan:interface-mode: 'TRUNK'
                        openconfig-vlan:native-vlan: 99
                        openconfig-vlan:trunk-vlans:
                          - 100
                          - 200
                          - 300
                  openconfig-interfaces:hold-time:
                    openconfig-interfaces:config:
                      openconfig-interfaces:down: 0
                      openconfig-interfaces:up: 0
            openconfig-network-instance:network-instances:
              openconfig-network-instance:network-instance:
                - openconfig-network-instance:name: 'default'
                  openconfig-network-instance:config:
                    openconfig-network-instance:name: 'default'
                    openconfig-network-instance:type: 'DEFAULT_INSTANCE'
                    openconfig-network-instance:enabled: true
                  openconfig-network-instance:vlans:
                    openconfig-network-instance:vlan:
                      - openconfig-network-instance:vlan-id: 99
                        openconfig-network-instance:config:
                          openconfig-network-instance:vlan-id: 99
                          openconfig-network-instance:name: 'VLAN99'
                          openconfig-network-instance:status: 'ACTIVE'
                      - openconfig-network-instance:vlan-id: 100
                        openconfig-network-instance:config:
                          openconfig-network-instance:vlan-id: 100
                          openconfig-network-instance:name: 'VLAN100'
                          openconfig-network-instance:status: 'ACTIVE'
                      - openconfig-network-instance:vlan-id: 200
                        openconfig-network-instance:config:
                          openconfig-network-instance:vlan-id: 200
                          openconfig-network-instance:name: 'VLAN200'
                          openconfig-network-instance:status: 'ACTIVE'
                      - openconfig-network-instance:vlan-id: 300
                        openconfig-network-instance:config:
                          openconfig-network-instance:vlan-id: 300
                          openconfig-network-instance:name: 'VLAN300'
                          openconfig-network-instance:status: 'ACTIVE'
            openconfig-spanning-tree:stp:
              openconfig-spanning-tree:global:
                openconfig-spanning-tree:config:
                  openconfig-spanning-tree:enabled-protocol:
                    - RAPID_PVST
              openconfig-spanning-tree:interfaces:
                openconfig-spanning-tree:interface:
                  - openconfig-spanning-tree:name: 'GigabitEthernet1/0'
                    openconfig-spanning-tree:config:
                      openconfig-spanning-tree:name: 'GigabitEthernet1/0'
                      openconfig-spanning-tree:guard: ROOT  # ROOT, LOOP, NONE
                      openconfig-spanning-tree:bpdu-guard: true  # true or false
                      openconfig-spanning-tree:link-type: P2P  # P2P or SHARED  shared or point-to-point
                      openconfig-spanning-tree:bpdu-filter: false  # true or false
                      openconfig-spanning-tree:edge-port: EDGE_ENABLE  # EDGE_AUTO, EDGE_DISABLE spanning-tree portfast disable, EDGE_ENABLE
                  - openconfig-spanning-tree:name: 'GigabitEthernet1/1'
                    openconfig-spanning-tree:config:
                      openconfig-spanning-tree:name: 'GigabitEthernet1/1'
                      openconfig-spanning-tree:guard: LOOP
                      openconfig-spanning-tree:bpdu-guard: false
                      openconfig-spanning-tree:link-type: P2P
                      openconfig-spanning-tree:bpdu-filter: false
                  - openconfig-spanning-tree:name: 'GigabitEthernet1/2'
                    openconfig-spanning-tree:config:
                      openconfig-spanning-tree:name: 'GigabitEthernet1/2'
                      openconfig-spanning-tree:guard: LOOP
                      openconfig-spanning-tree:bpdu-guard: false
                      openconfig-spanning-tree:link-type: P2P
                      openconfig-spanning-tree:bpdu-filter: false
                  - openconfig-spanning-tree:name: 'GigabitEthernet1/3'
                    openconfig-spanning-tree:config:
                      openconfig-spanning-tree:name: 'GigabitEthernet1/3'
                      openconfig-spanning-tree:guard: ROOT
                      openconfig-spanning-tree:bpdu-guard: true  # true or false
                      openconfig-spanning-tree:link-type: P2P
                      openconfig-spanning-tree:bpdu-filter: false
                      openconfig-spanning-tree:edge-port: 'EDGE_ENABLE'
                  - openconfig-spanning-tree:name: 'Port-channel1'
                    openconfig-spanning-tree:config:
                      openconfig-spanning-tree:name: 'Port-channel1'
                      openconfig-spanning-tree:guard: LOOP
                      openconfig-spanning-tree:bpdu-guard: false
                      openconfig-spanning-tree:link-type: P2P
                      openconfig-spanning-tree:bpdu-filter: false
        api_method: PUT
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+spanning-tree mode rapid-pvst:' in changes"
          - "'+interface Port-channel1:' in changes"
          - "'+ description LACP Example PO1:' in changes"
          - "'+ spanning-tree bpdufilter disable:' in changes"
          - "'+ spanning-tree guard loop:' in changes"
          - "'+ spanning-tree link-type point-to-point:' in changes"
          - "'+ switchport mode trunk:' in changes"
          - "' interface GigabitEthernet1/0:' in changes"
          - "'+ spanning-tree guard root:' in changes"
          - "'+ spanning-tree link-type point-to-point:' in changes"
          - "'+ spanning-tree bpduguard enable:' in changes"
          - "'+ spanning-tree portfast edge:' in changes"
          - "' interface GigabitEthernet1/1:' in changes"
          - "'+ spanning-tree bpdufilter disable:' in changes"
          - "'+ spanning-tree guard loop:' in changes"
          - "'+ spanning-tree link-type point-to-point:' in changes"
          - "'+ switchport mode trunk:' in changes"
          - "' interface GigabitEthernet1/2:' in changes"
          - "'+ spanning-tree bpdufilter disable:' in changes"
          - "'+ spanning-tree guard loop:' in changes"
          - "'+ spanning-tree link-type point-to-point:' in changes"
          - "'+ switchport mode trunk:' in changes"
          - "' interface GigabitEthernet1/3:' in changes"
          - "'+ spanning-tree bpdufilter disable:' in changes"
          - "'+ spanning-tree guard root:' in changes"
          - "'+ spanning-tree link-type point-to-point:' in changes"
          - "'+ spanning-tree bpduguard enable:' in changes"
          - "'+ spanning-tree portfast edge trunk:' in changes"

    - name: stp_interface_rstp_disable_edge
      tags:
        - stp_interface_rstp_disable_edge
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-interfaces:interfaces:
              openconfig-interfaces:interface:
                - openconfig-interfaces:name: 'GigabitEthernet1/0'
                  openconfig-interfaces:config:
                    openconfig-interfaces:description: 'Access Port Example'
                    openconfig-interfaces:enabled: true
                    openconfig-interfaces:loopback-mode: false
                    openconfig-interfaces:name: 'GigabitEthernet1/0'
                    openconfig-interfaces:type: 'l2vlan'
                  openconfig-if-ethernet:ethernet:
                    openconfig-if-ethernet:config:
                      openconfig-if-ethernet:auto-negotiate: true
                      openconfig-if-ethernet:enable-flow-control: false
                    openconfig-vlan:switched-vlan:
                      openconfig-vlan:config:
                        openconfig-vlan:access-vlan: 200
                        openconfig-vlan:interface-mode: 'ACCESS'
                  openconfig-interfaces:hold-time:
                    openconfig-interfaces:config:
                      openconfig-interfaces:down: 0
                      openconfig-interfaces:up: 0
                - openconfig-interfaces:name: 'GigabitEthernet1/3'
                  openconfig-interfaces:config:
                    openconfig-interfaces:description: 'Trunk Port To Server Example'
                    openconfig-interfaces:enabled: true
                    openconfig-interfaces:loopback-mode: false
                    openconfig-interfaces:name: 'GigabitEthernet1/3'
                    openconfig-interfaces:type: 'l2vlan'
                  openconfig-if-ethernet:ethernet:
                    openconfig-if-ethernet:config:
                      openconfig-if-ethernet:auto-negotiate: true
                      openconfig-if-ethernet:enable-flow-control: false
                    openconfig-vlan:switched-vlan:
                      openconfig-vlan:config:
                        openconfig-vlan:interface-mode: 'TRUNK'
                        openconfig-vlan:native-vlan: 99
                        openconfig-vlan:trunk-vlans:
                          - 100
                          - 200
                          - 300
                  openconfig-interfaces:hold-time:
                    openconfig-interfaces:config:
                      openconfig-interfaces:down: 0
                      openconfig-interfaces:up: 0
            openconfig-network-instance:network-instances:
              openconfig-network-instance:network-instance:
                - openconfig-network-instance:name: 'default'
                  openconfig-network-instance:config:
                    openconfig-network-instance:name: 'default'
                    openconfig-network-instance:type: 'DEFAULT_INSTANCE'
                    openconfig-network-instance:enabled: true
                  openconfig-network-instance:vlans:
                    openconfig-network-instance:vlan:
                      - openconfig-network-instance:vlan-id: 99
                        openconfig-network-instance:config:
                          openconfig-network-instance:vlan-id: 99
                          openconfig-network-instance:name: 'VLAN99'
                          openconfig-network-instance:status: 'ACTIVE'
                      - openconfig-network-instance:vlan-id: 100
                        openconfig-network-instance:config:
                          openconfig-network-instance:vlan-id: 100
                          openconfig-network-instance:name: 'VLAN100'
                          openconfig-network-instance:status: 'ACTIVE'
                      - openconfig-network-instance:vlan-id: 200
                        openconfig-network-instance:config:
                          openconfig-network-instance:vlan-id: 200
                          openconfig-network-instance:name: 'VLAN200'
                          openconfig-network-instance:status: 'ACTIVE'
                      - openconfig-network-instance:vlan-id: 300
                        openconfig-network-instance:config:
                          openconfig-network-instance:vlan-id: 300
                          openconfig-network-instance:name: 'VLAN300'
                          openconfig-network-instance:status: 'ACTIVE'
            openconfig-spanning-tree:stp:
              openconfig-spanning-tree:global:
                openconfig-spanning-tree:config:
                  openconfig-spanning-tree:enabled-protocol:
                    - RAPID_PVST
              openconfig-spanning-tree:interfaces:
                openconfig-spanning-tree:interface:
                  - openconfig-spanning-tree:name: 'GigabitEthernet1/0'
                    openconfig-spanning-tree:config:
                      openconfig-spanning-tree:name: 'GigabitEthernet1/0'
                      openconfig-spanning-tree:guard: ROOT
                      openconfig-spanning-tree:bpdu-guard: true
                      openconfig-spanning-tree:link-type: P2P
                      openconfig-spanning-tree:bpdu-filter: false
                      openconfig-spanning-tree:edge-port: EDGE_DISABLE
                  - openconfig-spanning-tree:name: 'GigabitEthernet1/3'
                    openconfig-spanning-tree:config:
                      openconfig-spanning-tree:name: 'GigabitEthernet1/3'
                      openconfig-spanning-tree:guard: ROOT
                      openconfig-spanning-tree:bpdu-guard: true
                      openconfig-spanning-tree:link-type: P2P
                      openconfig-spanning-tree:bpdu-filter: false
                      openconfig-spanning-tree:edge-port: EDGE_DISABLE
        api_method: PUT
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "' interface GigabitEthernet1/0:' in changes"
          - "'+ spanning-tree portfast disable:' in changes"
          - "' interface GigabitEthernet1/3:' in changes"
          - "'+ spanning-tree portfast disable:' in changes"

    - name: stp_interface_rstp_edge_auto
      tags:
        - stp_interface_rstp_edge_auto
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-interfaces:interfaces:
              openconfig-interfaces:interface:
                - openconfig-interfaces:name: 'GigabitEthernet1/0'
                  openconfig-interfaces:config:
                    openconfig-interfaces:description: 'Access Port Example'
                    openconfig-interfaces:enabled: true
                    openconfig-interfaces:loopback-mode: false
                    openconfig-interfaces:name: 'GigabitEthernet1/0'
                    openconfig-interfaces:type: 'l2vlan'
                  openconfig-if-ethernet:ethernet:
                    openconfig-if-ethernet:config:
                      openconfig-if-ethernet:auto-negotiate: true
                      openconfig-if-ethernet:enable-flow-control: false
                    openconfig-vlan:switched-vlan:
                      openconfig-vlan:config:
                        openconfig-vlan:access-vlan: 200
                        openconfig-vlan:interface-mode: 'ACCESS'
                  openconfig-interfaces:hold-time:
                    openconfig-interfaces:config:
                      openconfig-interfaces:down: 0
                      openconfig-interfaces:up: 0
            openconfig-network-instance:network-instances:
              openconfig-network-instance:network-instance:
                - openconfig-network-instance:name: 'default'
                  openconfig-network-instance:config:
                    openconfig-network-instance:name: 'default'
                    openconfig-network-instance:type: 'DEFAULT_INSTANCE'
                    openconfig-network-instance:enabled: true
                  openconfig-network-instance:vlans:
                    openconfig-network-instance:vlan:
                      - openconfig-network-instance:vlan-id: 99
                        openconfig-network-instance:config:
                          openconfig-network-instance:vlan-id: 99
                          openconfig-network-instance:name: 'VLAN99'
                          openconfig-network-instance:status: 'ACTIVE'
                      - openconfig-network-instance:vlan-id: 100
                        openconfig-network-instance:config:
                          openconfig-network-instance:vlan-id: 100
                          openconfig-network-instance:name: 'VLAN100'
                          openconfig-network-instance:status: 'ACTIVE'
                      - openconfig-network-instance:vlan-id: 200
                        openconfig-network-instance:config:
                          openconfig-network-instance:vlan-id: 200
                          openconfig-network-instance:name: 'VLAN200'
                          openconfig-network-instance:status: 'ACTIVE'
                      - openconfig-network-instance:vlan-id: 300
                        openconfig-network-instance:config:
                          openconfig-network-instance:vlan-id: 300
                          openconfig-network-instance:name: 'VLAN300'
                          openconfig-network-instance:status: 'ACTIVE'
            openconfig-spanning-tree:stp:
              openconfig-spanning-tree:global:
                openconfig-spanning-tree:config:
                  openconfig-spanning-tree:enabled-protocol:
                    - RAPID_PVST
              openconfig-spanning-tree:interfaces:
                openconfig-spanning-tree:interface:
                  - openconfig-spanning-tree:name: 'GigabitEthernet1/0'
                    openconfig-spanning-tree:config:
                      openconfig-spanning-tree:name: 'GigabitEthernet1/0'
                      openconfig-spanning-tree:guard: ROOT
                      openconfig-spanning-tree:bpdu-guard: true
                      openconfig-spanning-tree:link-type: P2P
                      openconfig-spanning-tree:bpdu-filter: false
                      openconfig-spanning-tree:edge-port: EDGE_AUTO
        api_method: PUT
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+spanning-tree portfast edge default:' in changes"

- name: test mstp
  hosts: "{{ lookup('env', 'TEST_DEVICE_XESWITCH') | default('xeswitch1', True) }}"
  gather_facts: no
  connection: network_cli
  vars:
    device: "{{ lookup('env', 'TEST_DEVICE_XESWITCH') | default('xeswitch1', True) }}"
    ansible_network_os: 'cisco.ios.ios'
  tasks:
    - name: stp_mstp
      tags:
        - stp_mstp
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-interfaces:interfaces:
              openconfig-interfaces:interface:
                - openconfig-interfaces:name: 'GigabitEthernet1/0'
                  openconfig-interfaces:config:
                    openconfig-interfaces:description: 'Access Port Example'
                    openconfig-interfaces:enabled: true
                    openconfig-interfaces:loopback-mode: false
                    openconfig-interfaces:name: 'GigabitEthernet1/0'
                    openconfig-interfaces:type: 'l2vlan'
                  openconfig-if-ethernet:ethernet:
                    openconfig-if-ethernet:config:
                      openconfig-if-ethernet:auto-negotiate: true
                      openconfig-if-ethernet:enable-flow-control: false
                    openconfig-vlan:switched-vlan:
                      openconfig-vlan:config:
                        openconfig-vlan:access-vlan: 100
                        openconfig-vlan:interface-mode: 'ACCESS'
                  openconfig-interfaces:hold-time:
                    openconfig-interfaces:config:
                      openconfig-interfaces:down: 0
                      openconfig-interfaces:up: 0
                - openconfig-interfaces:name: 'GigabitEthernet1/1'
                  openconfig-interfaces:config:
                    openconfig-interfaces:description: 'Trunk Port Example'
                    openconfig-interfaces:enabled: true
                    openconfig-interfaces:loopback-mode: false
                    openconfig-interfaces:name: 'GigabitEthernet1/1'
                    openconfig-interfaces:type: 'l2vlan'
                  openconfig-if-ethernet:ethernet:
                    openconfig-if-ethernet:config:
                      openconfig-if-ethernet:auto-negotiate: true
                      openconfig-if-ethernet:enable-flow-control: false
                    openconfig-vlan:switched-vlan:
                      openconfig-vlan:config:
                        openconfig-vlan:interface-mode: 'TRUNK'
                        openconfig-vlan:native-vlan: 99
                        openconfig-vlan:trunk-vlans:
                          - 100
                          - 200
                  openconfig-interfaces:hold-time:
                    openconfig-interfaces:config:
                      openconfig-interfaces:down: 0
                      openconfig-interfaces:up: 0
            openconfig-network-instance:network-instances:
              openconfig-network-instance:network-instance:
                - openconfig-network-instance:name: 'default'
                  openconfig-network-instance:config:
                    openconfig-network-instance:name: 'default'
                    openconfig-network-instance:type: 'DEFAULT_INSTANCE'
                    openconfig-network-instance:enabled: true
                  openconfig-network-instance:vlans:
                    openconfig-network-instance:vlan:
                      - openconfig-network-instance:vlan-id: 100
                        openconfig-network-instance:config:
                          openconfig-network-instance:vlan-id: 100
                          openconfig-network-instance:name: 'VLAN100'
                          openconfig-network-instance:status: 'ACTIVE'
                      - openconfig-network-instance:vlan-id: 200
                        openconfig-network-instance:config:
                          openconfig-network-instance:vlan-id: 200
                          openconfig-network-instance:name: 'VLAN200'
                          openconfig-network-instance:status: 'ACTIVE'
                      - openconfig-network-instance:vlan-id: 300
                        openconfig-network-instance:config:
                          openconfig-network-instance:vlan-id: 300
                          openconfig-network-instance:name: 'VLAN300'
                          openconfig-network-instance:status: 'ACTIVE'
                      - openconfig-network-instance:vlan-id: 400
                        openconfig-network-instance:config:
                          openconfig-network-instance:vlan-id: 400
                          openconfig-network-instance:name: 'VLAN400'
                          openconfig-network-instance:status: 'ACTIVE'
            openconfig-spanning-tree:stp:
              openconfig-spanning-tree:global:
                openconfig-spanning-tree:config:
                  openconfig-spanning-tree:enabled-protocol:
                    - MSTP
              openconfig-spanning-tree:mstp:
                openconfig-spanning-tree:config:
                  openconfig-spanning-tree:name: MST
                  openconfig-spanning-tree:revision: 1
                  openconfig-spanning-tree:forwarding-delay: 25
                openconfig-spanning-tree:mst-instances:
                  openconfig-spanning-tree:mst-instance:
                    - openconfig-spanning-tree:mst-id: 1
                      openconfig-spanning-tree:config:
                        openconfig-spanning-tree:mst-id: 1
                        openconfig-spanning-tree:bridge-priority: 16384
                        openconfig-spanning-tree:vlan:
                          - 100
                          - 200
                      openconfig-spanning-tree:interfaces:
                        openconfig-spanning-tree:interface:
                          - openconfig-spanning-tree:name: GigabitEthernet1/0
                            openconfig-spanning-tree:config:
                              openconfig-spanning-tree:name: GigabitEthernet1/0
                              openconfig-spanning-tree:cost: 10
                          - openconfig-spanning-tree:name: GigabitEthernet1/1
                            openconfig-spanning-tree:config:
                              openconfig-spanning-tree:name: GigabitEthernet1/1
                              openconfig-spanning-tree:port-priority: 96
                    - openconfig-spanning-tree:mst-id: 2
                      openconfig-spanning-tree:config:
                        openconfig-spanning-tree:mst-id: 2
                        openconfig-spanning-tree:bridge-priority: 61440
                        openconfig-spanning-tree:vlan:
                          - 300
                          - 400

        api_method: PUT
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+spanning-tree mode mstp:' in changes"
          - "'+ name MST:' in changes"
          - "'+ revision 1:' in changes"
          - "'+ instance 1 vlan 100, 200:' in changes"
          - "'+ instance 2 vlan 300, 400:' in changes"
          - "'+spanning-tree mst forward-time 25:' in changes"
          - "'+spanning-tree mst 1 priority 16384:' in changes"
          - "'+spanning-tree mst 2 priority 61440:' in changes"
          - "' interface GigabitEthernet1/0:' in changes"
          - "'+ spanning-tree mst 1 cost 10:' in changes"
          - "' interface GigabitEthernet1/1:' in changes"
          - "'+ spanning-tree mst 2 port-priority 96:' in changes"

- hosts: nso
  connection: local
  gather_facts: no
  roles:
    - nso-rollback-load
  run_once: true
  vars:
    rollback_file: "{{ lookup('env', 'PWD') }}/rollback.yaml"