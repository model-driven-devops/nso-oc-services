---
- hosts: nso
  connection: local
  gather_facts: no
  roles:
    - nso-rollback-save
  run_once: true
  vars:
    rollback_file: "{{ lookup('env', 'PWD') }}/rollback.yaml"

- name: test interfaces
  hosts: "{{ lookup('env', 'TEST_DEVICE_XEROUTER') | default('xe1', True) }}"
  gather_facts: no
  connection: network_cli
  vars:
    device: "{{ lookup('env', 'TEST_DEVICE_XEROUTER') | default('xe1', True) }}"
    ansible_network_os: 'cisco.ios.ios'
  tasks:
    - name: test vrrp
      tags:
        - vrrp
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-interfaces:interfaces:
              openconfig-interfaces:interface:
                - openconfig-interfaces:name: 'GigabitEthernet6'
                  openconfig-interfaces:config:
                    openconfig-interfaces:description: 'Physical Interface 6 VRRP'
                    openconfig-interfaces:enabled: true
                    openconfig-interfaces:name: 'GigabitEthernet6'
                    openconfig-interfaces:type: 'ethernetCsmacd'
                  openconfig-interfaces:subinterfaces:
                    openconfig-interfaces:subinterface:
                      - openconfig-interfaces:index: 0
                        openconfig-interfaces:config:
                          openconfig-interfaces:index: 0
                        openconfig-if-ip:ipv4:
                          openconfig-if-ip:addresses:
                            openconfig-if-ip:address:
                              - openconfig-if-ip:ip: '10.6.0.2'
                                openconfig-if-ip:config:
                                  openconfig-if-ip:ip: '10.6.0.2'
                                  openconfig-if-ip:prefix-length: 24
                                openconfig-if-ip:vrrp:
                                  openconfig-if-ip:vrrp-group:
                                    - openconfig-if-ip:virtual-router-id: 6  # group number
                                      openconfig-if-ip:config:
                                        openconfig-if-ip:advertisement-interval: 300  # units "centiseconds"; vrrp 5 timers advertise 3
                                        openconfig-if-ip:preempt: true
                                        openconfig-if-ip:preempt-delay: 10  # vrrp 5 preempt delay minimum 100
                                        openconfig-if-ip:priority: 200  # vrrp 5 priority 200
                                        openconfig-if-ip:virtual-address:  # vrrp 5 ip 10.6.0.100
                                          - '10.6.0.100'
                                        openconfig-if-ip:virtual-router-id: 6  # group number
                          openconfig-if-ip:config:
                            openconfig-if-ip:dhcp-client: false
        api_method: PUT
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "' interface GigabitEthernet6:' in changes"
          - "'+ description Physical Interface 6 VRRP:' in changes"
          - "'+ ip address 10.6.0.2 255.255.255.0:' in changes"
          - "'+ vrrp 6 ip 10.6.0.100:' in changes"
          - "'+ vrrp 6 preempt delay minimum 10:' in changes"
          - "'+ vrrp 6 priority 200:' in changes"
          - "'+ vrrp 6 timers advertise 3:' in changes"

    - name: test dot1q
      tags:
        - dot1q
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-interfaces:interfaces:
              openconfig-interfaces:interface:
                - openconfig-interfaces:name: 'GigabitEthernet7'
                  openconfig-interfaces:config:
                    openconfig-interfaces:description: 'Physical Interface 7 802.1q'
                    openconfig-interfaces:enabled: true
                    openconfig-interfaces:name: 'GigabitEthernet7'
                    openconfig-interfaces:type: 'ethernetCsmacd'
                  openconfig-interfaces:subinterfaces:
                    openconfig-interfaces:subinterface:
                      - openconfig-interfaces:index: 5
                        openconfig-interfaces:config:
                          openconfig-interfaces:description: 'Sub interface 5'
                          openconfig-interfaces:enabled: true
                          openconfig-interfaces:index: 5
                        openconfig-if-ip:ipv4:
                          openconfig-if-ip:addresses:
                            openconfig-if-ip:address:
                              - openconfig-if-ip:ip: '10.7.5.1'
                                openconfig-if-ip:config:
                                  openconfig-if-ip:ip: '10.7.5.1'
                                  openconfig-if-ip:prefix-length: '24'
                          openconfig-if-ip:config:
                            openconfig-if-ip:dhcp-client: false
                            openconfig-if-ip:enabled: true
                        openconfig-vlan:vlan:
                          openconfig-vlan:config:
                            openconfig-vlan:vlan-id: 5
                      - openconfig-interfaces:index: '6'
                        openconfig-interfaces:config:
                          openconfig-interfaces:description: 'Sub interface 6'
                          openconfig-interfaces:enabled: true
                          openconfig-interfaces:index: '6'
                        openconfig-if-ip:ipv4:
                          openconfig-if-ip:addresses:
                            openconfig-if-ip:address:
                              - openconfig-if-ip:ip: '10.7.6.1'
                                openconfig-if-ip:config:
                                  openconfig-if-ip:ip: '10.7.6.1'
                                  openconfig-if-ip:prefix-length: '24'
                          openconfig-if-ip:config:
                            openconfig-if-ip:dhcp-client: false
                            openconfig-if-ip:enabled: true
                        openconfig-vlan:vlan:
                          openconfig-vlan:config:
                            openconfig-vlan:vlan-id: 6
        api_method: PUT
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "' interface GigabitEthernet7:' in changes"
          - "'+ description Physical Interface 7 802.1q:' in changes"
          - "'+interface GigabitEthernet7.5:' in changes"
          - "'+ description Sub interface 5:' in changes"
          - "'+ encapsulation dot1Q 5:' in changes"
          - "'+ ip address 10.7.5.1 255.255.255.0:' in changes"
          - "'+interface GigabitEthernet7.6:' in changes"
          - "'+ description Sub interface 6:' in changes"
          - "'+ encapsulation dot1Q 6:' in changes"
          - "'+ ip address 10.7.6.1 255.255.255.0:' in changes"

    - name: test loopback interface
      tags:
        - loopback
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-interfaces:interfaces:
              openconfig-interfaces:interface:
                - openconfig-interfaces:name: 'Loopback0'
                  openconfig-interfaces:config:
                    openconfig-interfaces:description: 'Loopback 0'
                    openconfig-interfaces:enabled: true
                    openconfig-interfaces:name: 'Loopback0'
                    openconfig-interfaces:type: 'softwareLoopback'
                  openconfig-interfaces:subinterfaces:
                    openconfig-interfaces:subinterface:
                      - openconfig-interfaces:index: 0
                        openconfig-interfaces:config:
                          openconfig-interfaces:index: 0
                        openconfig-if-ip:ipv4:
                          openconfig-if-ip:addresses:
                            openconfig-if-ip:address:
                              - openconfig-if-ip:ip: '10.255.0.1'
                                openconfig-if-ip:config:
                                  openconfig-if-ip:ip: '10.255.0.1'
                                  openconfig-if-ip:prefix-length: '32'
                          openconfig-if-ip:config:
                            openconfig-if-ip:dhcp-client: false
        api_method: PUT
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+interface Loopback0:' in changes"
          - "'+ description Loopback 0:' in changes"
          - "'+ ip address 10.255.0.1 255.255.255.255:' in changes"

    - name: test vasi interfaces
      tags:
        - vasi
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-interfaces:interfaces:
              openconfig-interfaces:interface:
                - openconfig-interfaces:name: 'vasileft1'
                  openconfig-interfaces:config:
                    openconfig-interfaces:description: 'vasi left1'
                    openconfig-interfaces:enabled: true
                    openconfig-interfaces:name: 'vasileft1'
                    openconfig-interfaces:type: 'vasi'
                  openconfig-interfaces:subinterfaces:
                    openconfig-interfaces:subinterface:
                      - openconfig-interfaces:index: 0
                        openconfig-interfaces:config:
                          openconfig-interfaces:index: 0
                        openconfig-if-ip:ipv4:
                          openconfig-if-ip:addresses:
                            openconfig-if-ip:address:
                              - openconfig-if-ip:ip: '192.168.1.1'
                                openconfig-if-ip:config:
                                  openconfig-if-ip:ip: '192.168.1.1'
                                  openconfig-if-ip:prefix-length: '30'
                - openconfig-interfaces:name: 'vasiright1'
                  openconfig-interfaces:config:
                    openconfig-interfaces:description: 'vasi right1'
                    openconfig-interfaces:enabled: true
                    openconfig-interfaces:name: 'vasiright1'
                    openconfig-interfaces:type: 'vasi'
                  openconfig-interfaces:subinterfaces:
                    openconfig-interfaces:subinterface:
                      - openconfig-interfaces:index: 0
                        openconfig-interfaces:config:
                          openconfig-interfaces:index: 0
                        openconfig-if-ip:ipv4:
                          openconfig-if-ip:addresses:
                            openconfig-if-ip:address:
                              - openconfig-if-ip:ip: '192.168.1.2'
                                openconfig-if-ip:config:
                                  openconfig-if-ip:ip: '192.168.1.2'
                                  openconfig-if-ip:prefix-length: '30'
            openconfig-network-instance:network-instances:
              openconfig-network-instance:network-instance:
                - openconfig-network-instance:name: 'abc'
                  openconfig-network-instance:config:
                    openconfig-network-instance:name: 'abc'
                    openconfig-network-instance:type: 'L3VRF'
                    openconfig-network-instance:enabled: true
                    openconfig-network-instance:enabled-address-families:
                      - 'IPV4'
                  openconfig-network-instance:interfaces:
                    openconfig-network-instance:interface:
                      - openconfig-network-instance:id: 'vasileft1'
                        openconfig-network-instance:config:
                          openconfig-network-instance:id: 'vasileft1'
                          openconfig-network-instance:interface: 'vasileft1'
                          openconfig-network-instance:subinterface: 0
                - openconfig-network-instance:name: 'xyz'
                  openconfig-network-instance:config:
                    openconfig-network-instance:name: 'xyz'
                    openconfig-network-instance:type: 'L3VRF'
                    openconfig-network-instance:enabled: true
                    openconfig-network-instance:enabled-address-families:
                      - 'IPV4'
                  openconfig-network-instance:interfaces:
                    openconfig-network-instance:interface:
                      - openconfig-network-instance:id: 'vasiright1'
                        openconfig-network-instance:config:
                          openconfig-network-instance:id: 'vasiright1'
                          openconfig-network-instance:interface: 'vasiright1'
                          openconfig-network-instance:subinterface: 0
        api_method: PUT
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+interface vasileft1:' in changes"
          - "'+ description vasi left1:' in changes"
          - "'+ ip address 192.168.1.1 255.255.255.252:' in changes"
          - "'+ vrf forwarding abc:' in changes"
          - "'+interface vasiright1:' in changes"
          - "'+ description vasi right1:' in changes"
          - "'+ ip address 192.168.1.2 255.255.255.252:' in changes"
          - "'+ vrf forwarding xyz:' in changes"

#    - name: test ethernet_speed_duplex    ## EXAMPLE ONLY - ISSUES testing in CML
#      tags:
#        - ethernet_speed_duplex
#      import_role:
#        name: nso-openconfig-test
#      vars:
#        content: |
#          mdd:openconfig:
#            openconfig-interfaces:interfaces:
#              interface:
#                - config:
#                    description: 'Physical Interface 5'
#                    enabled: true
#                    name: 'GigabitEthernet5'
#                    type: 'ethernetCsmacd'
#                  name: 'GigabitEthernet5'
#                  openconfig-if-ethernet:ethernet:
#                    config:
#                      auto-negotiate: false
#                      port-speed: 'SPEED_1GB'
#                      duplex-mode: 'FULL'
#                  subinterfaces:
#                    subinterface:
#                      - config:
#                          index: 0
#                        index: 0
#                        openconfig-if-ip:ipv4:
#                          addresses:
#                            address:
#                              - config:
#                                  ip: '10.5.0.1'
#                                  prefix-length: 24
#                                ip: '10.5.0.1'
#        api_method: PUT
#        rollback: false
#        assertion_ignore_errors: false
#        assertions:
#          - "' interface GigabitEthernet5:' in changes"
#          - "'+ no negotiation auto:' in changes"
#          - "'+ speed 1000:' in changes"
#          - "'+ duplex full:' in changes"

    - name: test proxyarp
      tags:
        - proxyarp
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-interfaces:interfaces:
              openconfig-interfaces:interface:
                - openconfig-interfaces:name: 'GigabitEthernet5'
                  openconfig-interfaces:config:
                    openconfig-interfaces:description: 'Physical Interface 5'
                    openconfig-interfaces:enabled: true
                    openconfig-interfaces:mtu: 1500
                    openconfig-interfaces:name: 'GigabitEthernet5'
                    openconfig-interfaces:type: 'ethernetCsmacd'
                  openconfig-interfaces:subinterfaces:
                    openconfig-interfaces:subinterface:
                      - openconfig-interfaces:index: 0
                        openconfig-interfaces:config:
                          openconfig-interfaces:index: 0
                        openconfig-if-ip:ipv4:
                          openconfig-if-ip:addresses:
                            openconfig-if-ip:address:
                              - openconfig-if-ip:ip: '10.5.0.1'
                                openconfig-if-ip:config:
                                  openconfig-if-ip:ip: '10.5.0.1'
                                  openconfig-if-ip:prefix-length: 24
                          openconfig-if-ip:config:
                            openconfig-if-ip:dhcp-client: false
                          openconfig-if-ip:proxy-arp:
                            openconfig-if-ip:config:
                              openconfig-if-ip:mode: REMOTE_ONLY  # Default is DISABLE other option is REMOTE_ONLY for IOS
        api_method: PUT
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "' interface GigabitEthernet5:' in changes"
          - "'- no ip address:' in changes"

    - name: test proxyarp
      tags:
        - proxyarp
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-interfaces:interfaces:
              openconfig-interfaces:interface:
                - openconfig-interfaces:name: 'GigabitEthernet5'
                  openconfig-interfaces:config:
                    openconfig-interfaces:description: 'Physical Interface 5'
                    openconfig-interfaces:enabled: true
                    openconfig-interfaces:mtu: 1500
                    openconfig-interfaces:name: 'GigabitEthernet5'
                    openconfig-interfaces:type: 'ethernetCsmacd'
                  openconfig-interfaces:subinterfaces:
                    openconfig-interfaces:subinterface:
                      - openconfig-interfaces:index: 0
                        openconfig-interfaces:config:
                          openconfig-interfaces:index: 0
                        openconfig-if-ip:ipv4:
                          openconfig-if-ip:addresses:
                            openconfig-if-ip:address:
                              - openconfig-if-ip:ip: '10.5.0.1'
                                openconfig-if-ip:config:
                                  openconfig-if-ip:ip: '10.5.0.1'
                                  openconfig-if-ip:prefix-length: 24
                          openconfig-if-ip:config:
                            openconfig-if-ip:dhcp-client: false
                          openconfig-if-ip:proxy-arp:
                            openconfig-if-ip:config:
                              openconfig-if-ip:mode: DISABLE  # Default is DISABLE other option is REMOTE_ONLY for IOS
        api_method: PUT
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "' interface GigabitEthernet5:' in changes"
          - "'+ no ip proxy-arp:' in changes"

    - name: test no_ip_redirects_no_ip_unreachables configuration
      tags:
        - no_ip_redirects_no_ip_unreachables
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-interfaces:interfaces:
              openconfig-interfaces:interface:
                - openconfig-interfaces:name: 'GigabitEthernet5'
                  openconfig-interfaces:config:
                    openconfig-interfaces:description: 'Physical Interface 5'
                    openconfig-interfaces:enabled: true
                    openconfig-interfaces:name: 'GigabitEthernet5'
                    openconfig-interfaces:type: 'ethernetCsmacd'
                  openconfig-interfaces:subinterfaces:
                    openconfig-interfaces:subinterface:
                      - openconfig-interfaces:index: 0
                        openconfig-interfaces:config:
                          openconfig-interfaces:index: 0
                        openconfig-if-ip:ipv4:
                          openconfig-if-ip:addresses:
                            openconfig-if-ip:address:
                              - openconfig-if-ip:ip: '10.5.0.1'
                                openconfig-if-ip:config:
                                  openconfig-if-ip:ip: '10.5.0.1'
                                  openconfig-if-ip:prefix-length: 24
                          openconfig-if-ip:config:
                            openconfig-if-ip:dhcp-client: false
                            openconfig-if-ip-mdd-ext:redirects: false
                            openconfig-if-ip-mdd-ext:unreachables: false
        api_method: PUT
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+ no ip redirects:' in changes"
          - "'+ no ip unreachables:' in changes"

    - name: test ip_redirects_ip_unreachables configuration
      tags:
        - ip_redirects_ip_unreachables
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-interfaces:interfaces:
              openconfig-interfaces:interface:
                - openconfig-interfaces:name: 'GigabitEthernet5'
                  openconfig-interfaces:config:
                    openconfig-interfaces:description: 'Physical Interface 5'
                    openconfig-interfaces:enabled: true
                    openconfig-interfaces:name: 'GigabitEthernet5'
                    openconfig-interfaces:type: 'ethernetCsmacd'
                  openconfig-interfaces:subinterfaces:
                    openconfig-interfaces:subinterface:
                      - openconfig-interfaces:index: 0
                        openconfig-interfaces:config:
                          openconfig-interfaces:index: 0
                        openconfig-if-ip:ipv4:
                          openconfig-if-ip:addresses:
                            openconfig-if-ip:address:
                              - openconfig-if-ip:ip: '10.5.0.1'
                                openconfig-if-ip:config:
                                  openconfig-if-ip:ip: '10.5.0.1'
                                  openconfig-if-ip:prefix-length: 24
                          openconfig-if-ip:config:
                            openconfig-if-ip:dhcp-client: false
                            openconfig-if-ip-mdd-ext:redirects: true
                            openconfig-if-ip-mdd-ext:unreachables: true
        api_method: PATCH
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'- no ip redirects:' in changes"
          - "'- no ip unreachables:' in changes"

    - name: test ip_mask_reply configuration
      tags:
        - ip_mask_reply
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-interfaces:interfaces:
              openconfig-interfaces:interface:
                - openconfig-interfaces:name: 'GigabitEthernet5'
                  openconfig-interfaces:config:
                    openconfig-interfaces:description: 'Physical Interface 5'
                    openconfig-interfaces:enabled: true
                    openconfig-interfaces:name: 'GigabitEthernet5'
                    openconfig-interfaces:type: 'ethernetCsmacd'
                  openconfig-interfaces:subinterfaces:
                    openconfig-interfaces:subinterface:
                      - openconfig-interfaces:index: 0
                        openconfig-interfaces:config:
                          openconfig-interfaces:index: 0
                        openconfig-if-ip:ipv4:
                          openconfig-if-ip:addresses:
                            openconfig-if-ip:address:
                              - openconfig-if-ip:ip: '10.5.0.1'
                                openconfig-if-ip:config:
                                  openconfig-if-ip:ip: '10.5.0.1'
                                  openconfig-if-ip:prefix-length: 24
                          openconfig-if-ip:config:
                            openconfig-if-ip:dhcp-client: false
                            openconfig-if-ip-mdd-ext:mask-reply: true
        api_method: PUT
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+ ip mask-reply:' in changes"

    - name: test no_ip_mask_reply configuration
      tags:
        - no_ip_mask_reply
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-interfaces:interfaces:
              openconfig-interfaces:interface:
                - openconfig-interfaces:name: 'GigabitEthernet5'
                  openconfig-interfaces:config:
                    openconfig-interfaces:description: 'Physical Interface 5'
                    openconfig-interfaces:enabled: true
                    openconfig-interfaces:name: 'GigabitEthernet5'
                    openconfig-interfaces:type: 'ethernetCsmacd'
                  openconfig-interfaces:subinterfaces:
                    openconfig-interfaces:subinterface:
                      - openconfig-interfaces:index: 0
                        openconfig-interfaces:config:
                          openconfig-interfaces:index: 0
                        openconfig-if-ip:ipv4:
                          openconfig-if-ip:addresses:
                            openconfig-if-ip:address:
                              - openconfig-if-ip:ip: '10.5.0.1'
                                openconfig-if-ip:config:
                                  openconfig-if-ip:ip: '10.5.0.1'
                                  openconfig-if-ip:prefix-length: 24
                          openconfig-if-ip:config:
                            openconfig-if-ip:dhcp-client: false
                            openconfig-if-ip-mdd-ext:mask-reply: false
        api_method: PUT
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'- ip mask-reply:' in changes"

    - name: test gre_tunnel configuration
      tags:
        - gre_tunnel
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-interfaces:interfaces:
              openconfig-interfaces:interface:
                - openconfig-interfaces:name: 'Loopback10'
                  openconfig-interfaces:config:
                    openconfig-interfaces:enabled: true
                    openconfig-interfaces:name: 'Loopback10'
                    openconfig-interfaces:type: 'softwareLoopback'
                    openconfig-interfaces:description: 'TEST123'
                  openconfig-interfaces:subinterfaces:
                    openconfig-interfaces:subinterface:
                      - openconfig-interfaces:index: 0
                        openconfig-interfaces:config:
                          openconfig-interfaces:index: 0
                        openconfig-if-ip:ipv4:
                          openconfig-if-ip:addresses:
                            openconfig-if-ip:address:
                              - openconfig-if-ip:ip: '10.255.10.1'
                                openconfig-if-ip:config:
                                  openconfig-if-ip:ip: '10.255.10.1'
                                  openconfig-if-ip:prefix-length: 32
                          openconfig-if-ip:config:
                            openconfig-if-ip:dhcp-client: false
                - openconfig-interfaces:name: 'Tunnel1'
                  openconfig-interfaces:config:
                    openconfig-interfaces:description: 'GRE Tunnel Interface'
                    openconfig-interfaces:enabled: true
                    openconfig-interfaces:name: 'Tunnel1'
                    openconfig-interfaces:type: 'tunnel'
                  openconfig-if-tunnel:tunnel:
                    openconfig-if-tunnel:config:
                      openconfig-if-tunnel:src: '10.255.10.1'
                      openconfig-if-tunnel:dst: '192.168.1.1'
                      openconfig-if-tunnel:gre-key: 1
                      openconfig-if-tunnel-ext:tunnel-path-mtu-discovery: true
                      openconfig-if-tunnel-ext:keepalives:
                        openconfig-if-tunnel-ext:period: 5
                        openconfig-if-tunnel-ext:retries: 3
                    openconfig-if-tunnel:ipv4:
                      openconfig-if-tunnel:config:
                        openconfig-if-tunnel:mtu: 1476
                        openconfig-if-tunnel:dhcp-client: false
                        openconfig-if-ip-mdd-ext:tcp-adjust-mss: 1460
                      openconfig-if-tunnel:addresses:
                        openconfig-if-tunnel:address:
                          - openconfig-if-tunnel:ip: '10.254.1.1'
                            openconfig-if-tunnel:config:
                              openconfig-if-tunnel:ip: '10.254.1.1'
                              openconfig-if-tunnel:prefix-length: 24

        api_method: PUT
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+interface Tunnel1:' in changes"
          - "'+ tunnel source 10.255.10.1:' in changes"
          - "'+ tunnel destination 192.168.1.1:' in changes"
          - "'+ tunnel key 1:' in changes"
          - "'+ tunnel path-mtu-discovery:' in changes"
          - "'+ keepalive 5 3:' in changes"
          - "'+ ip address 10.254.1.1 255.255.255.0:' in changes"
          - "'+ ip mtu 1476:' in changes"
          - "'+ ip tcp adjust-mss 1460:' in changes"
#          - "'+ tunnel ttl 255:' in changes"  # not available in NSO XE NED


    - name: test mac-address
      tags:
        -  mac-address
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-interfaces:interfaces:
              openconfig-interfaces:interface:
                - openconfig-interfaces:name: 'GigabitEthernet5'
                  openconfig-interfaces:config:
                    openconfig-interfaces:description: 'Physical Interface 5'
                    openconfig-interfaces:enabled: true
                    openconfig-interfaces:mtu: 1500
                    openconfig-interfaces:name: 'GigabitEthernet5'
                    openconfig-interfaces:type: 'ethernetCsmacd'
                  openconfig-if-ethernet:ethernet:
                    openconfig-if-ethernet:config:
                      openconfig-if-ethernet:mac-address: '52:54:00:99:99:99'
                  openconfig-interfaces:hold-time:
                    openconfig-interfaces:config:
                      openconfig-interfaces:down: 0
                      openconfig-interfaces:up: 0  # not in xe
                  openconfig-interfaces:subinterfaces:
                    openconfig-interfaces:subinterface:
                      - openconfig-interfaces:index: 0
                        openconfig-interfaces:config:
                          openconfig-interfaces:index: 0
                        openconfig-if-ip:ipv4:
                          openconfig-if-ip:addresses:
                            openconfig-if-ip:address:
                              - openconfig-if-ip:ip: '10.5.0.1'
                                openconfig-if-ip:config:
                                  openconfig-if-ip:ip: '10.5.0.1'
                                  openconfig-if-ip:prefix-length: 24
                          openconfig-if-ip:config:
                            openconfig-if-ip:dhcp-client: false
        api_method: PUT
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "' interface GigabitEthernet5:' in changes"
          - "'+ mac-address 5254.0099.9999:' in changes"

    - name: test nat-interface
      tags:
        -  nat-interface
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-interfaces:interfaces:
              openconfig-interfaces:interface:
                - openconfig-interfaces:name: 'GigabitEthernet5'
                  openconfig-interfaces:config:
                    openconfig-interfaces:description: 'Physical Interface 5'
                    openconfig-interfaces:enabled: true
                    openconfig-interfaces:mtu: 1500
                    openconfig-interfaces:name: 'GigabitEthernet5'
                    openconfig-interfaces:type: 'ethernetCsmacd'
                  openconfig-interfaces:subinterfaces:
                    openconfig-interfaces:subinterface:
                      - openconfig-interfaces:index: 0
                        openconfig-interfaces:config:
                          openconfig-interfaces:index: 0
                        openconfig-if-ip:ipv4:
                          openconfig-if-ip:addresses:
                            openconfig-if-ip:address:
                              - openconfig-if-ip:ip: '10.5.0.1'
                                openconfig-if-ip:config:
                                  openconfig-if-ip:ip: '10.5.0.1'
                                  openconfig-if-ip:prefix-length: 24
                          openconfig-if-ip:config:
                            openconfig-if-ip-mdd-ext:nat:
                              openconfig-if-ip-mdd-ext:nat-choice: 'inside'
                - openconfig-interfaces:name: 'GigabitEthernet6'
                  openconfig-interfaces:config:
                    openconfig-interfaces:description: 'Physical Interface 6'
                    openconfig-interfaces:enabled: true
                    openconfig-interfaces:mtu: 1500
                    openconfig-interfaces:name: 'GigabitEthernet6'
                    openconfig-interfaces:type: 'ethernetCsmacd'
                  openconfig-interfaces:subinterfaces:
                    openconfig-interfaces:subinterface:
                      - openconfig-interfaces:index: 0
                        openconfig-interfaces:config:
                          openconfig-interfaces:index: 0
                        openconfig-if-ip:ipv4:
                          openconfig-if-ip:addresses:
                            openconfig-if-ip:address:
                              - openconfig-if-ip:ip: '10.6.0.1'
                                openconfig-if-ip:config:
                                  openconfig-if-ip:ip: '10.6.0.1'
                                  openconfig-if-ip:prefix-length: 24
                          openconfig-if-ip:config:
                            openconfig-if-ip-mdd-ext:nat:
                              openconfig-if-ip-mdd-ext:nat-choice: 'outside'
        api_method: PUT
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "' interface GigabitEthernet5:' in changes"
          - "'+ ip nat inside:' in changes"
          - "' interface GigabitEthernet6:' in changes"
          - "'+ ip nat outside:' in changes"

    - name: test hold-down-timer
      tags:
        -  hold-down-timer
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-interfaces:interfaces:
              openconfig-interfaces:interface:
                - openconfig-interfaces:name: 'GigabitEthernet5'
                  openconfig-interfaces:config:
                    openconfig-interfaces:description: 'Physical Interface 5'
                    openconfig-interfaces:enabled: true
                    openconfig-interfaces:mtu: 1500
                    openconfig-interfaces:name: 'GigabitEthernet5'
                    openconfig-interfaces:type: 'ethernetCsmacd'
                  openconfig-interfaces:hold-time:
                    openconfig-interfaces:config:
                      openconfig-interfaces:down: 10
                      openconfig-interfaces:up: 0  # not in xe
                  openconfig-interfaces:subinterfaces:
                    openconfig-interfaces:subinterface:
                      - openconfig-interfaces:index: 0
                        openconfig-interfaces:config:
                          openconfig-interfaces:index: 0
                        openconfig-if-ip:ipv4:
                          openconfig-if-ip:addresses:
                            openconfig-if-ip:address:
                              - openconfig-if-ip:ip: '10.5.0.1'
                                openconfig-if-ip:config:
                                  openconfig-if-ip:ip: '10.5.0.1'
                                  openconfig-if-ip:prefix-length: 24
                          openconfig-if-ip:config:
                            openconfig-if-ip:dhcp-client: false
        api_method: PUT
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "' interface GigabitEthernet5:' in changes"
          - "'+ carrier-delay msec 10:' in changes"

    - name: test lacp_trunk_po10 configuration
      tags:
        - lacp_trunk_po10
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-interfaces:interfaces:
              openconfig-interfaces:interface:
                - openconfig-interfaces:name: 'Port-channel10'
                  openconfig-interfaces:config:
                    openconfig-interfaces:description: 'LACP Example PO10'
                    openconfig-interfaces:enabled: true
                    openconfig-interfaces:mtu: 1500
                    openconfig-interfaces:name: 'Port-channel10'
                    openconfig-interfaces:type: 'ieee8023adLag'
                  openconfig-if-aggregate:aggregation:
                    openconfig-if-aggregate:config:
                      openconfig-if-aggregate:lag-type: 'LACP'
                  openconfig-interfaces:subinterfaces:
                    openconfig-interfaces:subinterface:
                      - openconfig-interfaces:index: 105
                        openconfig-interfaces:config:
                          openconfig-interfaces:description: 'Sub interface 105'
                          openconfig-interfaces:enabled: true
                          openconfig-interfaces:index: 105
                        openconfig-interfaces:index: 105
                        openconfig-if-ip:ipv4:
                          openconfig-if-ip:addresses:
                            openconfig-if-ip:address:
                              - openconfig-if-ip:ip: '172.10.105.1'
                                openconfig-if-ip:config:
                                  openconfig-if-ip:ip: '172.10.105.1'
                                  openconfig-if-ip:prefix-length: 24
                        openconfig-vlan:vlan:
                          openconfig-vlan:config:
                            openconfig-vlan:vlan-id: 105
                      - openconfig-interfaces:index: 106
                        openconfig-interfaces:config:
                          openconfig-interfaces:description: 'Sub interface 106'
                          openconfig-interfaces:enabled: true
                          openconfig-interfaces:index: 106
                        openconfig-if-ip:ipv4:
                          openconfig-if-ip:addresses:
                            openconfig-if-ip:address:
                              - openconfig-if-ip:ip: '172.10.106.1'
                                openconfig-if-ip:config:
                                  openconfig-if-ip:ip: '172.10.106.1'
                                  openconfig-if-ip:prefix-length: 24
                        openconfig-vlan:vlan:
                          openconfig-vlan:config:
                            openconfig-vlan:vlan-id: 106
        api_method: PUT
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "'+interface Port-channel10:' in changes"
          - "'+ description LACP Example PO10:' in changes"
          - "'+interface Port-channel10.105:' in changes"
          - "'+ description Sub interface 105:' in changes"
          - "'+ encapsulation dot1Q 105:' in changes"
          - "'+ ip address 172.10.105.1 255.255.255.0:' in changes"
          - "'+interface Port-channel10.106:' in changes"
          - "'+ description Sub interface 106:' in changes"
          - "'+ encapsulation dot1Q 106:' in changes"
          - "'+ ip address 172.10.106.1 255.255.255.0:' in changes"

- hosts: nso
  connection: local
  gather_facts: no
  roles:
    - nso-rollback-load
  run_once: true
  vars:
    rollback_file: "{{ lookup('env', 'PWD') }}/rollback.yaml"

- name: test interfaces
  hosts: "{{ lookup('env', 'TEST_DEVICE_XEROUTER') | default('xe1', True) }}"
  gather_facts: no
  connection: network_cli
  vars:
    device: "{{ lookup('env', 'TEST_DEVICE_XEROUTER') | default('xe1', True) }}"
    ansible_network_os: 'cisco.ios.ios'
  tasks:
    - name: test hsrp
      tags:
        - hsrp
      import_role:
        name: nso-openconfig-test
      vars:
        content: |
          mdd:openconfig:
            openconfig-interfaces:interfaces:
              openconfig-interfaces:interface:
                - openconfig-interfaces:name: 'GigabitEthernet6'
                  openconfig-interfaces:config:
                    openconfig-interfaces:description: 'Physical Interface 6 HSRP'
                    openconfig-interfaces:enabled: true
                    openconfig-interfaces:name: 'GigabitEthernet6'
                    openconfig-interfaces:type: 'ethernetCsmacd'
                  openconfig-interfaces:subinterfaces:
                    openconfig-interfaces:subinterface:
                      - openconfig-interfaces:index: 0
                        openconfig-interfaces:config:
                          openconfig-interfaces:index: 0
                        openconfig-if-ip:ipv4:
                          openconfig-if-ip:addresses:
                            openconfig-if-ip:address:
                              - openconfig-if-ip:ip: '10.6.0.2'
                                openconfig-if-ip:config:
                                  openconfig-if-ip:ip: '10.6.0.2'
                                  openconfig-if-ip:prefix-length: 24
                                openconfig-if-ip-mdd-ext:hsrp:
                                  openconfig-if-ip-mdd-ext:hsrp-group:
                                    - openconfig-if-ip-mdd-ext:group-number: 3  # group number
                                      openconfig-if-ip-mdd-ext:config:
                                        openconfig-if-ip-mdd-ext:preempt: true
                                        openconfig-if-ip-mdd-ext:preempt-delay: 3500  # hsrp 5 preempt delay mi
                                        openconfig-if-ip-mdd-ext:priority: 200  # hsrp 7 priority 200
                                        openconfig-if-ip-mdd-ext:virtual-address:  # hsrp 3 ip 10.6.0.110
                                          - '10.6.0.110'
                                        openconfig-if-ip-mdd-ext:group-number: 3  # group number
                                        openconfig-if-ip-mdd-ext:timers:
                                          openconfig-if-ip-mdd-ext:hello-interval: 30
                                          openconfig-if-ip-mdd-ext:holdtime: 100
                          openconfig-if-ip:config:
                            openconfig-if-ip:dhcp-client: false
        api_method: PUT
        rollback: false
        assertion_ignore_errors: false
        assertions:
          - "' interface GigabitEthernet6:' in changes"
          - "'+ standby 3 ip 10.6.0.110:' in changes"
          - "'+ standby 3 preempt delay minimum 3500:' in changes"
          - "'+ standby 3 priority 200:' in changes"
          - "'+ standby 3 timers 30 100:' in changes"
