- set_fact:
    nso_host: "{{ lookup('env', 'NSO_HOST') }}"
    nso_username: "{{ lookup('env', 'NSO_USERNAME') }}"
    nso_password: "{{ lookup('env', 'NSO_PASSWORD') }}"
    apply:
      delegate_to: localhost
- include_role:
    name: ciscops.mdd.nso
    tasks_from: get_rollbacks
- set_fact:
    file_content:
      rollback_id: "{{ rollback_id }}"
  when: rollback_id is defined
  vars:
    rollback_id: "{{ nso_rollback_facts | json_query('data[0].rollback_nr') }}"
- name: Save Rollback file
  copy:
    dest: "{{ rollback_file }}"
    content: "{{ file_content | to_nice_yaml(2) }}"
  when: file_content is defined
#
#
#- set_fact:
#    nso_host: "{{ lookup('env', 'NSO_HOST') }}"
#    nso_username: "{{ lookup('env', 'NSO_USERNAME') }}"
#    nso_password: "{{ lookup('env', 'NSO_PASSWORD') }}"
#    apply:
#      delegate_to: localhost
#
#- name: run pyats
#  include_role:
#    name: ansible-pyats
#
#- name: collect config (before)
#  ios_command:
#    commands:
#      - show run
#  register: result_before
#
#- name: Convert string to JSON
#  set_fact:
#    configs: "{{ content | from_yaml | to_json }}"
#    apply:
#      delegate_to: localhost
#
#- name: JSON configs
#  debug:
#    msg: "{{ configs }}"
#
#- name: System dns-servers
#  uri:
#    url: "http://{{ nso_host }}:8080/restconf/data/tailf-ncs:devices/device={{ device }}/mdd:openconfig"
#    url_username: "{{ nso_username }}"
#    url_password: "{{ nso_password }}"
#    force_basic_auth: yes
#    validate_certs: no
#    status_code: [200,201,204]
#    method: "{{ api_method }}"
#    headers: "{
#      'Content-Type': 'application/yang-data+json',
#      'Accept': 'application/yang-data+json'}"
#    body_format: json
#    body: "{{ configs }}"
#  delegate_to: localhost
#
#- name: run pyats
#  include_role:
#    name: ansible-pyats
#
#- name: collect config (after)
#  ios_command:
#    commands:
#      - show run
#  register: result_after
#
#- set_fact:
#    exclude_list:
#      - (^Using.*)
#      - (Building.*)
#      - (Current.*)
#      - (crypto pki certificate chain.*)
#    apply:
#      delegate_to: localhost
#
#- set_fact:
#    changes: "{{ result_before.stdout[0] | genie_config_diff(result_after.stdout[0], exclude=exclude_list) }}"
#    apply:
#      delegate_to: localhost
#
#- name: debug changes
#  debug:
#    msg: "{{ changes }}"
#
#- assert:
#    that: "{{ assertions }}"
#  ignore_errors: "{{ ignore_errors }}"
#
#- name: Rollback
#  uri:
#    url: "http://{{ nso_host }}:8080/restconf/data/tailf-rollback:rollback-files/apply-rollback-file"
#    url_username: "{{ nso_username }}"
#    url_password: "{{ nso_password }}"
#    force_basic_auth: yes
#    validate_certs: no
#    status_code: [ 204 ]
#    method: POST
#    headers: "{
#      'Content-Type': 'application/yang-data+xml'}"
#    body: |
#      <input xmlns="http://tail-f.com/ns/rollback">
#        <id>0</id>
#      </input>
#  when: rollback|bool == true
