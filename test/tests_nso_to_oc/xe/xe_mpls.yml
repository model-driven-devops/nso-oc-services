---
- hosts: localhost
  gather_facts: no
  environment:
    NSO_DEVICE: xe1
  vars:
    device: "{{ lookup('env', 'TEST_DEVICE_XEROUTER') | default('xe1', True) }}"
  tasks:
    - name: Run XE network instance default for MPLS tests
      include_role:
        name: ned-to-oc-test
      vars:
        script_path: ../../../package_nso_to_oc/xe/xe_network_instances.py
        api_test_data:
          - name: Set up OC service config for MPLS testing
            tags:
              - oc_set_up
            api_path: mdd:openconfig
            api_method: PUT
            content: |
              mdd:openconfig:
                openconfig-interfaces:interfaces:
                  openconfig-interfaces:interface:
                    - openconfig-interfaces:name: 'Loopback10'
                      openconfig-interfaces:config:
                        openconfig-interfaces:name: 'Loopback10'
                        openconfig-interfaces:enabled: true
                        openconfig-interfaces:type: 'softwareLoopback'
                        openconfig-interfaces:description: 'Loopback0 - MPLS RID'
                      openconfig-interfaces:subinterfaces:
                        openconfig-interfaces:subinterface:
                          - openconfig-interfaces:index: 0
                            openconfig-interfaces:config:
                              openconfig-interfaces:index: 0
                            openconfig-if-ip:ipv4:
                              openconfig-if-ip:addresses:
                                openconfig-if-ip:address:
                                  - openconfig-if-ip:ip: '172.31.100.1'
                                    openconfig-if-ip:config:
                                      openconfig-if-ip:ip: '172.31.100.1'
                                      openconfig-if-ip:prefix-length: 32
                              openconfig-if-ip:config:
                                openconfig-if-ip:dhcp-client: false
                    - openconfig-interfaces:name: 'GigabitEthernet2'
                      openconfig-interfaces:config:
                        openconfig-interfaces:name: 'GigabitEthernet2'
                        openconfig-interfaces:enabled: true
                        openconfig-interfaces:type: 'ethernetCsmacd'
                        openconfig-interfaces:description: 'Test gigabitethernet2 - MPLS'
                      openconfig-if-ethernet:ethernet:
                        openconfig-if-ethernet:config:
                          openconfig-if-ethernet:auto-negotiate: true
                          openconfig-if-ethernet:enable-flow-control: false
                      openconfig-interfaces:subinterfaces:
                        openconfig-interfaces:subinterface:
                          - openconfig-interfaces:index: 0
                            openconfig-interfaces:config:
                              openconfig-interfaces:index: 0
                            openconfig-if-ip:ipv4:
                              openconfig-if-ip:addresses:
                                openconfig-if-ip:address:
                                  - openconfig-if-ip:ip: '172.16.100.1'
                                    openconfig-if-ip:config:
                                      openconfig-if-ip:ip: '172.16.100.1'
                                      openconfig-if-ip:prefix-length: 30
                              openconfig-if-ip:config:
                                openconfig-if-ip:dhcp-client: false
                    - openconfig-interfaces:name: 'GigabitEthernet3'
                      openconfig-interfaces:config:
                        openconfig-interfaces:name: 'GigabitEthernet3'
                        openconfig-interfaces:enabled: true
                        openconfig-interfaces:type: 'ethernetCsmacd'
                        openconfig-interfaces:description: 'Test gigabitethernet3 - MPLS'
                      openconfig-if-ethernet:ethernet:
                        openconfig-if-ethernet:config:
                          openconfig-if-ethernet:auto-negotiate: true
                          openconfig-if-ethernet:enable-flow-control: false
                      openconfig-interfaces:subinterfaces:
                        openconfig-interfaces:subinterface:
                          - openconfig-interfaces:index: 0
                            openconfig-interfaces:config:
                              openconfig-interfaces:index: 0
                            openconfig-if-ip:ipv4:
                              openconfig-if-ip:addresses:
                                openconfig-if-ip:address:
                                  - openconfig-if-ip:ip: '172.16.100.5'
                                    openconfig-if-ip:config:
                                      openconfig-if-ip:ip: '172.16.100.5'
                                      openconfig-if-ip:prefix-length: 30
                              openconfig-if-ip:config:
                                openconfig-if-ip:dhcp-client: false
                openconfig-network-instance:network-instances:
                  openconfig-network-instance:network-instance:
                    - openconfig-network-instance:name: 'default'
                      openconfig-network-instance:config:
                        openconfig-network-instance:name: 'default'
                        openconfig-network-instance:type: 'DEFAULT_INSTANCE'
                        openconfig-network-instance:enabled: true
          - name: NED system init for MPLS
            tags:
              - ned_init_mpls
            api_path: config
            api_method: PATCH
            content: |
              config:
                tailf-ned-cisco-ios:mpls:
                  ip: true
                  mpls-ip-conf:
                    ip:
                      propagate-ttl-conf:
                        propagate-ttl: false
                  ldp:
                    discovery:
                      hello:
                        holdtime: 1234
                        interval: 5678
                    graceful-restart-enable:
                      graceful-restart:
                        - null
                    router-id:
                      interface: '172.16.100.1'
                      force:
                        - null

          - name: NED init interface for MPLS
            tags:
              - init_intf_mpls
            api_path: config/tailf-ned-cisco-ios:interface
            api_method: PATCH
            content: |
              interface:
                GigabitEthernet:
                  - name: '2'
                    mpls:
                      ip:
                        - null
                      mtu: 1320
                      bgp:
                        forwarding:
                          - null
                  - name: '3'
                    mpls:
                      ip:
                        - null
                      mtu: 1430
                      bgp:
                        forwarding:
                          - null

        assertions:
          # These are testing for network instances
          - "'default' in oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'] | map(attribute='name') | list"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][0]['mpls']['global']['config']['ttl-propagation'] == False"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][0]['mpls']['signaling-protocols']['ldp']['global']['config']['lsr-id'] == '172.16.100.1'"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][0]['mpls']['signaling-protocols']['ldp']['global']['graceful-restart']['config']['enabled'] == True"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][0]['mpls']['signaling-protocols']['ldp']['interface-attributes']['config']['hello-holdtime'] == 1234"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][0]['mpls']['signaling-protocols']['ldp']['interface-attributes']['config']['hello-interval'] == 5678"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][0]['mpls']['global']['interface-attributes']['interface'][0]['config']['mpls-enabled'] == True"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][0]['mpls']['global']['interface-attributes']['interface'][0]['config']['mpls-bgp-forwarding'] == True"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][0]['mpls']['global']['interface-attributes']['interface'][0]['config']['mpls-mtu'] == 1320"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][0]['mpls']['global']['interface-attributes']['interface'][1]['config']['mpls-enabled'] == True"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][0]['mpls']['global']['interface-attributes']['interface'][1]['config']['mpls-bgp-forwarding'] == True"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][0]['mpls']['global']['interface-attributes']['interface'][1]['config']['mpls-mtu'] == 1430"
