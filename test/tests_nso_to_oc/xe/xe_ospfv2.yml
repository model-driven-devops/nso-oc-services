---
- hosts: nso
  connection: local
  gather_facts: no
  roles:
    - nso-rollback-save
  run_once: true
  vars:
    rollback_file: "{{ lookup('env', 'PWD') }}/rollback.yaml"

- hosts: localhost
  gather_facts: no
  environment:
    NSO_DEVICE: xe1
  vars:
    nso_host: "{{ lookup('env', 'NSO_HOST') }}"
    nso_username: "{{ lookup('env', 'NSO_USERNAME') }}"
    nso_password: "{{ lookup('env', 'NSO_PASSWORD') }}"
    device: "{{ lookup('env', 'TEST_DEVICE_XEROUTER') | default('xe1', True) }}"
  tasks:
    - block:
      - name: Set up service config
        tags:
          - set_up
        import_role:
          name: nso-ned-device-configure
        vars:
          api_path: mdd:openconfig
          content: |
            mdd:openconfig:
              openconfig-interfaces:interfaces:
                openconfig-interfaces:interface:
                  - openconfig-interfaces:name: 'Loopback10'
                    openconfig-interfaces:config:
                      openconfig-interfaces:name: 'Loopback10'
                      openconfig-interfaces:enabled: true
                      openconfig-interfaces:type: 'softwareLoopback'
                      openconfig-interfaces:description: 'Test loopback'
                    openconfig-interfaces:subinterfaces:
                      openconfig-interfaces:subinterface:
                        - openconfig-interfaces:index: 0
                          openconfig-interfaces:config:
                            openconfig-interfaces:index: 0
                          openconfig-if-ip:ipv4:
                            openconfig-if-ip:addresses:
                              openconfig-if-ip:address:
                                - openconfig-if-ip:ip: '10.255.10.1'
                                  openconfig-if-ip:config:
                                    openconfig-if-ip:ip: '10.255.10.1'
                                    openconfig-if-ip:prefix-length: 24
                            openconfig-if-ip:config:
                              openconfig-if-ip:dhcp-client: false
                  - openconfig-interfaces:name: 'Loopback100'
                    openconfig-interfaces:config:
                      openconfig-interfaces:name: 'Loopback100'
                      openconfig-interfaces:enabled: true
                      openconfig-interfaces:type: 'softwareLoopback'
                      openconfig-interfaces:description: 'Test loopback'
                    openconfig-interfaces:subinterfaces:
                      openconfig-interfaces:subinterface:
                        - openconfig-interfaces:index: 0
                          openconfig-interfaces:config:
                            openconfig-interfaces:index: 0
                          openconfig-if-ip:ipv4:
                            openconfig-if-ip:addresses:
                              openconfig-if-ip:address:
                                - openconfig-if-ip:ip: '10.255.100.1'
                                  openconfig-if-ip:config:
                                    openconfig-if-ip:ip: '10.255.100.1'
                                    openconfig-if-ip:prefix-length: 24
                            openconfig-if-ip:config:
                              openconfig-if-ip:dhcp-client: false
                  - openconfig-interfaces:name: 'GigabitEthernet7'
                    openconfig-interfaces:config:
                      openconfig-interfaces:name: 'GigabitEthernet7'
                      openconfig-interfaces:enabled: true
                      openconfig-interfaces:type: 'ethernetCsmacd'
                      openconfig-interfaces:description: 'Test gigabitethernet'
                    openconfig-if-ethernet:ethernet:
                      openconfig-if-ethernet:config:
                        openconfig-if-ethernet:auto-negotiate: true
                        openconfig-if-ethernet:enable-flow-control: false
                    openconfig-interfaces:hold-time:
                      openconfig-interfaces:config:
                        openconfig-interfaces:down: '10'
                    openconfig-interfaces:subinterfaces:
                      openconfig-interfaces:subinterface:
                        - openconfig-interfaces:index: 0
                          openconfig-interfaces:config:
                            openconfig-interfaces:index: 0
                          openconfig-if-ip:ipv4:
                            openconfig-if-ip:addresses:
                              openconfig-if-ip:address:
                                - openconfig-if-ip:ip: '10.250.20.1'
                                  openconfig-if-ip:config:
                                    openconfig-if-ip:ip: '10.250.20.1'
                                    openconfig-if-ip:prefix-length: 24
                            openconfig-if-ip:config:
                              openconfig-if-ip:dhcp-client: false
                  - openconfig-interfaces:name: 'GigabitEthernet3'
                    openconfig-interfaces:config:
                      openconfig-interfaces:name: 'GigabitEthernet3'
                      openconfig-interfaces:enabled: true
                      openconfig-interfaces:type: 'ethernetCsmacd'
                      openconfig-interfaces:description: 'Test gigabitethernet'
                    openconfig-if-ethernet:ethernet:
                      openconfig-if-ethernet:config:
                        openconfig-if-ethernet:auto-negotiate: true
                        openconfig-if-ethernet:enable-flow-control: false
                    openconfig-interfaces:hold-time:
                      openconfig-interfaces:config:
                        openconfig-interfaces:down: '10'
                    openconfig-interfaces:subinterfaces:
                      openconfig-interfaces:subinterface:
                        - openconfig-interfaces:index: 0
                          openconfig-interfaces:config:
                            openconfig-interfaces:index: 0
                          openconfig-if-ip:ipv4:
                            openconfig-if-ip:addresses:
                              openconfig-if-ip:address:
                                - openconfig-if-ip:ip: '10.3.0.2'
                                  openconfig-if-ip:config:
                                    openconfig-if-ip:ip: '10.3.0.2'
                                    openconfig-if-ip:prefix-length: 24
                            openconfig-if-ip:config:
                              openconfig-if-ip:dhcp-client: false
                  - openconfig-interfaces:name: 'GigabitEthernet5'
                    openconfig-interfaces:config:
                      openconfig-interfaces:name: 'GigabitEthernet5'
                      openconfig-interfaces:enabled: true
                      openconfig-interfaces:type: 'ethernetCsmacd'
                      openconfig-interfaces:description: 'Test gigabitethernet'
                    openconfig-if-ethernet:ethernet:
                      openconfig-if-ethernet:config:
                        openconfig-if-ethernet:auto-negotiate: true
                        openconfig-if-ethernet:enable-flow-control: false
                    openconfig-interfaces:hold-time:
                      openconfig-interfaces:config:
                        openconfig-interfaces:down: '10'
                    openconfig-interfaces:subinterfaces:
                      openconfig-interfaces:subinterface:
                        - openconfig-interfaces:index: 0
                          openconfig-interfaces:config:
                            openconfig-interfaces:index: 0
                          openconfig-if-ip:ipv4:
                            openconfig-if-ip:addresses:
                              openconfig-if-ip:address:
                                - openconfig-if-ip:ip: '10.5.0.2'
                                  openconfig-if-ip:config:
                                    openconfig-if-ip:ip: '10.5.0.2'
                                    openconfig-if-ip:prefix-length: 24
                            openconfig-if-ip:config:
                              openconfig-if-ip:dhcp-client: false
                  - openconfig-interfaces:name: 'GigabitEthernet6'
                    openconfig-interfaces:config:
                      openconfig-interfaces:name: 'GigabitEthernet6'
                      openconfig-interfaces:enabled: true
                      openconfig-interfaces:type: 'ethernetCsmacd'
                      openconfig-interfaces:description: 'Test gigabitethernet'
                    openconfig-if-ethernet:ethernet:
                      openconfig-if-ethernet:config:
                        openconfig-if-ethernet:auto-negotiate: true
                        openconfig-if-ethernet:enable-flow-control: false
                    openconfig-interfaces:hold-time:
                      openconfig-interfaces:config:
                        openconfig-interfaces:down: '10'
                    openconfig-interfaces:subinterfaces:
                      openconfig-interfaces:subinterface:
                        - openconfig-interfaces:index: 0
                          openconfig-interfaces:config:
                            openconfig-interfaces:index: 0
                          openconfig-if-ip:ipv4:
                            openconfig-if-ip:addresses:
                              openconfig-if-ip:address:
                                - openconfig-if-ip:ip: '10.6.0.1'
                                  openconfig-if-ip:config:
                                    openconfig-if-ip:ip: '10.6.0.1'
                                    openconfig-if-ip:prefix-length: 24
                            openconfig-if-ip:config:
                              openconfig-if-ip:dhcp-client: false
                  - openconfig-interfaces:name: 'GigabitEthernet8'
                    openconfig-interfaces:config:
                      openconfig-interfaces:name: 'GigabitEthernet8'
                      openconfig-interfaces:enabled: true
                      openconfig-interfaces:type: 'ethernetCsmacd'
                      openconfig-interfaces:description: 'Test gigabitethernet'
                    openconfig-if-ethernet:ethernet:
                      openconfig-if-ethernet:config:
                        openconfig-if-ethernet:auto-negotiate: true
                        openconfig-if-ethernet:enable-flow-control: false
                    openconfig-interfaces:hold-time:
                      openconfig-interfaces:config:
                        openconfig-interfaces:down: '10'
                    openconfig-interfaces:subinterfaces:
                      openconfig-interfaces:subinterface:
                        - openconfig-interfaces:index: 0
                          openconfig-interfaces:config:
                            openconfig-interfaces:index: 0
                          openconfig-if-ip:ipv4:
                            openconfig-if-ip:addresses:
                              openconfig-if-ip:address:
                                - openconfig-if-ip:ip: '10.250.25.1'
                                  openconfig-if-ip:config:
                                    openconfig-if-ip:ip: '10.250.25.1'
                                    openconfig-if-ip:prefix-length: 24
                            openconfig-if-ip:config:
                              openconfig-if-ip:dhcp-client: false
                        - openconfig-interfaces:index: 10
                          openconfig-interfaces:config:
                            openconfig-interfaces:index: 10
                          openconfig-if-ip:ipv4:
                            openconfig-if-ip:addresses:
                              openconfig-if-ip:address:
                                - openconfig-if-ip:ip: '10.8.10.2'
                                  openconfig-if-ip:config:
                                    openconfig-if-ip:ip: '10.8.10.2'
                                    openconfig-if-ip:prefix-length: 24
                            openconfig-if-ip:config:
                              openconfig-if-ip:dhcp-client: false
                  - openconfig-interfaces:name: 'Tunnel1'
                    openconfig-interfaces:config:
                      openconfig-interfaces:name: 'Tunnel1'
                      openconfig-interfaces:enabled: true
                      openconfig-interfaces:type: 'tunnel'
                      openconfig-interfaces:mtu: 1476
                      openconfig-interfaces:description: 'Test tunnel'
                    openconfig-if-tunnel:tunnel:
                      openconfig-if-tunnel:config:
                        openconfig-if-tunnel:src: '10.255.0.1'
                        openconfig-if-tunnel:dst: '192.168.172.1'
                        openconfig-if-tunnel:gre-key: 1
                        openconfig-if-tunnel-ext:keepalives:
                          openconfig-if-tunnel-ext:period: 5
                          openconfig-if-tunnel-ext:retries: 3
                    openconfig-interfaces:hold-time:
                      openconfig-interfaces:config:
                        openconfig-interfaces:down: '10'
                    openconfig-interfaces:subinterfaces:
                      openconfig-interfaces:subinterface:
                        - openconfig-interfaces:index: 0
                          openconfig-interfaces:config:
                            openconfig-interfaces:index: 0
                          openconfig-if-ip:ipv4:
                            openconfig-if-ip:addresses:
                              openconfig-if-ip:address:
                                - openconfig-if-ip:ip: '10.254.0.1'
                                  openconfig-if-ip:config:
                                    openconfig-if-ip:ip: '10.254.0.1'
                                    openconfig-if-ip:prefix-length: 24
                            openconfig-if-ip:config:
                              openconfig-if-ip:dhcp-client: false
                  - openconfig-interfaces:name: 'vasileft1'
                    openconfig-interfaces:config:
                      openconfig-interfaces:name: 'vasileft1'
                      openconfig-interfaces:enabled: true
                      openconfig-interfaces:type: 'vasi'
                      openconfig-interfaces:description: 'Test vasi'
                    openconfig-interfaces:hold-time:
                      openconfig-interfaces:config:
                        openconfig-interfaces:down: '10'
                    openconfig-interfaces:subinterfaces:
                      openconfig-interfaces:subinterface:
                        - openconfig-interfaces:index: 0
                          openconfig-interfaces:config:
                            openconfig-interfaces:index: 0
                          openconfig-if-ip:ipv4:
                            openconfig-if-ip:addresses:
                              openconfig-if-ip:address:
                                - openconfig-if-ip:ip: '192.168.1.1'
                                  openconfig-if-ip:config:
                                    openconfig-if-ip:ip: '192.168.1.1'
                                    openconfig-if-ip:prefix-length: 30
                            openconfig-if-ip:config:
                              openconfig-if-ip:dhcp-client: false
                  - openconfig-interfaces:name: 'vasiright1'
                    openconfig-interfaces:config:
                      openconfig-interfaces:name: 'vasiright1'
                      openconfig-interfaces:enabled: true
                      openconfig-interfaces:type: 'vasi'
                      openconfig-interfaces:description: 'Test vasi'
                    openconfig-interfaces:hold-time:
                      openconfig-interfaces:config:
                        openconfig-interfaces:down: '10'
                    openconfig-interfaces:subinterfaces:
                      openconfig-interfaces:subinterface:
                        - openconfig-interfaces:index: 0
                          openconfig-interfaces:config:
                            openconfig-interfaces:index: 0
                          openconfig-if-ip:ipv4:
                            openconfig-if-ip:addresses:
                              openconfig-if-ip:address:
                                - openconfig-if-ip:ip: '192.168.2.2'
                                  openconfig-if-ip:config:
                                    openconfig-if-ip:ip: '192.168.2.2'
                                    openconfig-if-ip:prefix-length: 30
                            openconfig-if-ip:config:
                              openconfig-if-ip:dhcp-client: false
              openconfig-routing-policy:routing-policy:
                openconfig-routing-policy:defined-sets:
                  openconfig-routing-policy:prefix-sets:
                    openconfig-routing-policy:prefix-set:
                      - openconfig-routing-policy:name: 'prefix_test'
                        openconfig-routing-policy:config:
                          openconfig-routing-policy:name: 'prefix_test'
                          openconfig-routing-policy:mode: 'IPV4'
                        openconfig-routing-policy:prefixes:
                          openconfig-routing-policy:prefix:
                            - openconfig-routing-policy:ip-prefix: '10.0.0.0/24'
                              openconfig-routing-policy:masklength-range: 'exact'
                              openconfig-routing-policy:config:
                                openconfig-routing-policy:ip-prefix: '10.0.0.0/24'
                                openconfig-routing-policy:masklength-range: 'exact'
                                openconfig-routing-policy-ext:seq: 10
                            - openconfig-routing-policy:ip-prefix: '10.0.0.0/23'
                              openconfig-routing-policy:masklength-range: '24..30'
                              openconfig-routing-policy:config:
                                openconfig-routing-policy:ip-prefix: '10.0.0.0/23'
                                openconfig-routing-policy:masklength-range: '24..30'
                                openconfig-routing-policy-ext:seq: 20
                openconfig-routing-policy:policy-definitions:
                  openconfig-routing-policy:policy-definition:
                    - openconfig-routing-policy:name: 'TEST'
                      openconfig-routing-policy:config:
                        openconfig-routing-policy:name: 'TEST'
                      openconfig-routing-policy:statements:
                        openconfig-routing-policy:statement:
                          - openconfig-routing-policy:name: '10'
                            openconfig-routing-policy:config:
                              openconfig-routing-policy:name: '10'
                            openconfig-routing-policy:actions:
                              openconfig-routing-policy:config:
                                openconfig-routing-policy:policy-result: 'ACCEPT_ROUTE'
                    - openconfig-routing-policy:name: 'test'
                      openconfig-routing-policy:config:
                        openconfig-routing-policy:name: 'test'
                      openconfig-routing-policy:statements:
                        openconfig-routing-policy:statement:
                          - openconfig-routing-policy:name: '10'
                            openconfig-routing-policy:config:
                              openconfig-routing-policy:name: '10'
                            openconfig-routing-policy:actions:
                              openconfig-routing-policy:config:
                                openconfig-routing-policy:policy-result: 'ACCEPT_ROUTE'
                            openconfig-routing-policy:conditions:
                              openconfig-routing-policy:match-prefix-set:
                                openconfig-routing-policy:config:
                                  openconfig-routing-policy:prefix-set: 'prefix_test'
                                  openconfig-routing-policy:match-set-options: 'ANY'
              openconfig-network-instance:network-instances:
                openconfig-network-instance:network-instance:
                  - openconfig-network-instance:name: 'default'
                    openconfig-network-instance:config:
                      openconfig-network-instance:name: 'default'
                      openconfig-network-instance:type: 'DEFAULT_INSTANCE'
                      openconfig-network-instance:enabled: true
          api_method: PUT

      - name: NSO Init OSPF
        tags:
          - init_ospf
        import_role:
          name: nso-ned-device-configure
        vars:
          api_path: config/tailf-ned-cisco-ios:router/ospf
          content: |
            ospf:
              - id: '2'
              - id: '100'
          api_method: PATCH

      - name: NSO Init VRF
        tags:
          - init_vrf
        import_role:
          name: nso-ned-device-configure
        vars:
          api_path: config/tailf-ned-cisco-ios:vrf/definition
          content: |
            definition:
              - name: 'internal_0'
                address-family:
                  ipv4: {}
                  ipv6: {}
              - name: abc
                address-family:
                  ipv4: {}
                  ipv6: {}
              - name: xyz
                address-family:
                  ipv4: {}
                  ipv6: {}
          api_method: PATCH

    - name: Init interface
      tags:
        - init_intf
      import_role:
        name: nso-ned-device-configure
      vars:
        api_path: config/tailf-ned-cisco-ios:interface
        content: |
          interface:
            Loopback:
              - name: '10'
                vrf:
                  forwarding: 'internal_0'
                ip:
                  address:
                    primary:
                      address: 10.255.10.1
                      mask: 255.255.255.255
              - name: 100
                ip:
                  address:
                    primary:
                      address: 10.255.100.1
                      mask: 255.255.255.255
            GigabitEthernet:
              - name: '7'
                vrf:
                  forwarding: 'internal_0'
                description: 'Description for GigabitEthernet7'
                negotiation:
                  auto: True
                mop:
                  xenabled: False
                  sysid: False
                ip:
                  address:
                    primary:
                      address: '10.250.20.1'
                      mask: '255.255.255.0'
                  ospf:
                    network: 
                      - 'non-broadcast'
                    dead-interval:
                      seconds: 60
                    hello-interval: 15
                    retransmit-interval: 10
                    bfd: {}
                    cost: 10
                    priority: 10
                    authentication:
                      message-digest: ''
                    message-digest-key: 
                      - id: '1'
                        md5:
                          type: '0'
                          secret: 'pass1'
                      - id: '2'
                        md5:
                          type: '7'
                          secret: '140713181F56'
                  policy:
                    route-map: 'TEST'
                shutdown: []
                carrier-delay:
                  msec: 10
              - name: '8'
                vrf:
                  forwarding: 'internal_0'
                description: 'Description for GigabitEthernet8'
                negotiation:
                  auto: True
                mop:
                  xenabled: False
                  sysid: False
                ip:
                  address:
                    primary:
                      address: '10.250.25.1'
                      mask: '255.255.255.0'
                  ospf:
                    network: 
                      - 'non-broadcast'
                    dead-interval:
                      seconds: 60
                    hello-interval: 15
                    retransmit-interval: 10
                    bfd: {}
                    cost: 10
                    priority: 10
                    authentication:
                      null: ''
                  policy:
                    route-map: 'TEST'
                shutdown: []
                carrier-delay:
                  msec: 10
        api_method: PATCH

      # Global
    - name: NSO configure global config
      tags:
        - ospf_global_config
      import_role:
        name: nso-ned-device-configure
      vars:
        api_path: config/tailf-ned-cisco-ios:router/ospf
        content: |
          ospf:
            - id: '2'
              vrf: 'internal_0'
              router-id: '1.1.1.1'
              log-adjacency-changes:
                detail: ''
              compatible:
                rfc1583: True
              prefix-suppression: ''
              nsf-ietf:
                nsf:
                  ietf: {}
              default-information:
                originate:
                  always: {}
                  metric: '5'
                  metric-type: '1'
                  route-map: 'TEST'
              mpls:
                ldp:
                  sync: {}
              timers:
                throttle:
                  lsa:
                    start-interval: 1000
                    hold-interval: 10000
                    max-interval: 10000
                  spf:
                    spf-start: 10000
                    spf-hold: 20000
                    spf-max-wait: 20000
              auto-cost:
                reference-bandwidth: '100000'
        api_method: PATCH

    - name: Execute NSO NED to OC script
      tags:
        - ospfv2_global
      script: ../../../package_nso_to_oc/xe/xe_network_instances.py
      args:
        executable: python3
      register: nso_to_oc_result
    - debug:
        msg: "{{nso_to_oc_result}}"

    - name: NSO API call
      uri:
        url: "http://{{ nso_host }}:8080/restconf/data/tailf-ncs:devices/device={{ device }}/mdd:openconfig"
        url_username: "{{ nso_username }}"
        url_password: "{{ nso_password }}"
        force_basic_auth: yes
        validate_certs: no
        status_code: [200,201,204]
        method: GET
        headers: "{
          'Content-Type': 'application/yang-data+json',
          'Accept': 'application/yang-data+json'}"
        body_format: json
      delegate_to: localhost
      register: oc_result
    - debug:
        msg: "{{ oc_result }}"
    - assert:
        that:
          # These are testing for network instances
          - "'default' in oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'] | map(attribute='name') | list"
          - "'abc' in oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'] | map(attribute='name') | list"
          - "'xyz' in oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'] | map(attribute='name') | list"

          # The rest of these are for OC
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['name'] == '2'"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['global']['config']['hide-transit-only-networks'] == true"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['global']['config']['log-adjacency-changes'] == true"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['global']['config']['router-id'] == '1.1.1.1'"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['global']['config']['summary-route-cost-mode'] == 'RFC1583_COMPATIBLE'"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['global']['graceful-restart']['config']['enabled'] == true"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['global']['config']['openconfig-ospfv2-ext:capability-vrf-lite'] == false"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['global']['config']['openconfig-ospfv2-ext:default-information-originate']['config']['metric'] == '5'"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['global']['config']['openconfig-ospfv2-ext:default-information-originate']['config']['metric-type'] == 1"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['global']['config']['openconfig-ospfv2-ext:auto-cost-ref-bandwidth'] == 100000"
          # TODO Add route-maps to OC services
          # - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['global']['config']['openconfig-ospfv2-ext:default-information-originate']['config']['route-map'] == 'TEST'"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['global']['config']['openconfig-ospfv2-ext:default-information-originate']['config']['always'] == true"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['global']['mpls']['igp-ldp-sync']['config']['enabled'] == true"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['global']['timers']['lsa-generation']['config']['initial-delay'] == 1000"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['global']['timers']['lsa-generation']['config']['maximum-delay'] == 10000"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['global']['timers']['lsa-generation']['config']['openconfig-ospfv2-ext:hold-time'] == 10000"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['global']['timers']['spf']['config']['initial-delay'] == 10000"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['global']['timers']['spf']['config']['maximum-delay'] == 20000"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['global']['timers']['spf']['config']['openconfig-ospfv2-ext:hold-time'] == 20000"

        # Areas
    - name: NSO configure areas config
      tags:
        - ospf_areas_config
      import_role:
        name: nso-ned-device-configure
      vars:
        api_path: config/tailf-ned-cisco-ios:router/ospf
        content: |
          ospf:
            - id: '100'
              area:
                - id: '1'
                  filter-list:
                    - direction: 'in'
                      prefix: 'test'
              network:
                - ip: '10.255.100.1'
                  mask: '0.0.0.0'
                  area: '1'
                - ip: '0.0.0.0'
                  mask: '255.255.255.255'
                  area: '0'
            - id: '2'
              vrf: 'internal_0'
              area:
                - id: '1'
                  stub:
                    no-summary: {}
                - id: '4'
                  filter-list:
                    - direction: 'in'
                      prefix: 'test'
                  # Getting error: "Area is configured as NSSA already"
                  nssa:
                    default-information-originate: {}
                    no-summary: {}
                - id: '5'
                  filter-list:
                    - direction: 'in'
                      prefix: 'test'
                  # Getting error: "Virtual links are not allowed in NSSA and stub areas"
                  virtual-link:
                    - id: '10.200.200.200'
              passive-interface:
                interface:
                  - name: 'GigabitEthernet7'
              network:
                - ip: '10.250.0.0'
                  mask: '0.0.255.255'
                  area: '4'
                - ip: '10.250.25.0'
                  mask: '0.0.0.255'
                  area: '5'
                - ip: '0.0.0.0'
                  mask: '255.255.255.255'
                  area: '0'
              mpls:
                traffic-eng:
                  area: ['4']
              neighbor:
                ip: '10.10.10.10'
                cost-database-filter-container:
                  cost: 100

        api_method: PATCH

    - name: Execute NSO NED to OC script
      tags:
        - ospfv2_areas
      script: ../../../package_nso_to_oc/xe/xe_network_instances.py
      args:
        executable: python3
      register: nso_to_oc_result
    - debug:
        msg: "{{nso_to_oc_result}}"

    - name: NSO API call
      uri:
        url: "http://{{ nso_host }}:8080/restconf/data/tailf-ncs:devices/device={{ device }}/mdd:openconfig"
        url_username: "{{ nso_username }}"
        url_password: "{{ nso_password }}"
        force_basic_auth: yes
        validate_certs: no
        status_code: [200,201,204]
        method: GET
        headers: "{
          'Content-Type': 'application/yang-data+json',
          'Accept': 'application/yang-data+json'}"
        body_format: json
      delegate_to: localhost
      register: oc_result
    - debug:
        msg: "{{ oc_result }}"
    - assert:
        that:
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['areas']['area'][0]['interfaces']['interface'][0]['config']['id'] == 'Loopback10'"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['areas']['area'][0]['interfaces']['interface'][0]['config']['passive'] == false"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['areas']['area'][1]['openconfig-ospfv2-ext:stub-options']['totally-stubby']['config']['enabled'] == true"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['areas']['area'][2]['interfaces']['interface'][0]['config']['id'] == 'GigabitEthernet7'"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['areas']['area'][2]['interfaces']['interface'][0]['config']['passive'] == true"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['areas']['area'][2]['interfaces']['interface'][0]['config']['metric'] == 10"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['areas']['area'][2]['interfaces']['interface'][0]['config']['network-type'] == 'openconfig-ospf-types:NON_BROADCAST_NETWORK'"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['areas']['area'][2]['openconfig-ospfv2-ext:stub-options']['nssa']['config']['no-summary'] == true"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['areas']['area'][3]['virtual-links']['virtual-link'][0]['config']['remote-router-id'] == '10.200.200.200'"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['areas']['area'][2]['interfaces']['interface'][0]['config']['passive'] == true"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['areas']['area'][2]['interfaces']['interface'][0]['neighbors']['neighbor'][0]['router-id'] == '10.10.10.10'"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['areas']['area'][2]['interfaces']['interface'][0]['neighbors']['neighbor'][0]['config']['metric'] == 100"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['areas']['area'][2]['mpls']['config']['traffic-engineering-enabled'] == true"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['areas']['area'][2]['interfaces']['interface'][0]['openconfig-ospfv2-ext:authentication']['config']['authentication-type'] == 'MD5'"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['areas']['area'][3]['interfaces']['interface'][0]['openconfig-ospfv2-ext:authentication']['config']['authentication-type'] == 'NULL'"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['areas']['area'][2]['interfaces']['interface'][0]['openconfig-ospfv2-ext:authentication']['md5-authentication-keys']['md5-authentication-key'][0]['config']['key-id'] == 1"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['areas']['area'][2]['interfaces']['interface'][0]['openconfig-ospfv2-ext:authentication']['md5-authentication-keys']['md5-authentication-key'][0]['config']['key'] == 'pass1'"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['areas']['area'][2]['interfaces']['interface'][0]['openconfig-ospfv2-ext:authentication']['md5-authentication-keys']['md5-authentication-key'][1]['config']['key-id'] == 2"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['areas']['area'][2]['interfaces']['interface'][0]['openconfig-ospfv2-ext:authentication']['md5-authentication-keys']['md5-authentication-key'][1]['config']['key'] == '140713181F56'"
          # This is testing for globals, but areas are required, so we test that portion of globals here.
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['global']['inter-area-propagation-policies']['inter-area-propagation-policy'][0]['src-area'] == 0"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['global']['inter-area-propagation-policies']['inter-area-propagation-policy'][0]['dst-area'] == 4"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['global']['inter-area-propagation-policies']['inter-area-propagation-policy'][0]['config']['src-area'] == 0"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['global']['inter-area-propagation-policies']['inter-area-propagation-policy'][0]['config']['dst-area'] == 4"
          - "oc_result.json['mdd:openconfig']['openconfig-network-instance:network-instances']['network-instance'][2]['protocols']['protocol'][0]['ospfv2']['global']['inter-area-propagation-policies']['inter-area-propagation-policy'][0]['config']['import-policy'][0] == 'test'"
